<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>üìù Assignment 2 ‚Äî Anomaly Detection (Student TO DO Section)</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="IsolationForest_files/libs/clipboard/clipboard.min.js"></script>
<script src="IsolationForest_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="IsolationForest_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="IsolationForest_files/libs/quarto-html/popper.min.js"></script>
<script src="IsolationForest_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="IsolationForest_files/libs/quarto-html/anchor.min.js"></script>
<link href="IsolationForest_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="IsolationForest_files/libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="IsolationForest_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="IsolationForest_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="IsolationForest_files/libs/bootstrap/bootstrap-d3ff60f736db98270af3c320d4ca77f9.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


</head>

<body class="fullcontent quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">üìù Assignment 2 ‚Äî Anomaly Detection (Student TO DO Section)</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p><strong>Read this</strong> - Do <strong>not</strong> add or remove Python libraries. Stick to the imports already present in this notebook. Changing libraries is an automatic <strong>‚àí100%</strong>. - You may use <strong>machine learning, statistics, or a hybrid</strong> approach ‚Äî but your method must generalize to <strong>new, unseen datasets</strong>. - Datasets: We have 10 time-series with <strong>10‚ÄØ000 rows</strong> each; anomalies: <strong>10 segments per dataset</strong>. You can upload the zip to you Google drive and use the ID from Google drive url. - Scoring in class: we will run your detector on <strong>novel datasets</strong>. <strong>#correct/10 √ó 100</strong> is your percentage. - Over/under-fitting penalties may apply (<strong>‚àí50%</strong>).</p>
<section id="what-you-must-do" class="level1">
<h1>What you must do</h1>
<p>Implement your anomaly detector using any means (could it be Machine Learning or statistics or a combination of both to improve the accuracy of the model). Return the index ranges for the anomalies for example 2001-2010.</p>
<p>You can also add small EDA (plots/stats) in the <strong>EDA cell</strong> below to justify your approach.</p>
<p><strong>Do not modify</strong> existing data loading and the libraries.</p>
<div id="VFY8tne7szem" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}}" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Show Google Colab your Google Drive</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> google.colab <span class="im">import</span> drive</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>drive.mount(<span class="st">'/content/drive'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Mounted at /content/drive</code></pre>
</div>
</div>
<div id="AaYXAPgssRXo" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}}" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set your own Google Drive folder here</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>BASE_DIR <span class="op">=</span> <span class="st">"/content/drive/MyDrive/EDAB2724/AnomalyDetection"</span>  <span class="co">#  EDIT this to your own Google Drive folder in which you upload ec2_cpu_utilization_synth.zip</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>os.makedirs(BASE_DIR, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'Using BASE_DIR ='</span>, BASE_DIR)  <span class="co"># print the working directory</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Using BASE_DIR = /content/drive/MyDrive/EDAB2724/AnomalyDetection</code></pre>
</div>
</div>
</section>
<section id="the-anomaly-detection-notebook" class="level1">
<h1><strong>The Anomaly Detection Notebook</strong></h1>
<div id="c70bc694" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:206}}" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>train_file_names <span class="op">=</span> os.listdir(<span class="st">"train/"</span>)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>train_file_names.sort()</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>train_files <span class="op">=</span> []</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> train_file_names:</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    train_files.append(pd.read_csv(<span class="ss">f"train/</span><span class="sc">{</span><span class="bu">file</span><span class="sc">}</span><span class="ss">"</span>, sep<span class="op">=</span><span class="st">";"</span>))</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>test_file_names <span class="op">=</span> os.listdir(<span class="st">"test/"</span>)</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>test_file_names.sort()</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>test_files <span class="op">=</span> []</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> test_file_names:</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    test_files.append(pd.read_csv(<span class="ss">f"test/</span><span class="sc">{</span><span class="bu">file</span><span class="sc">}</span><span class="ss">"</span>, sep<span class="op">=</span><span class="st">";"</span>))</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>test_files[<span class="dv">0</span>].head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<div id="df-29a928ae-2416-45bd-96f9-b6c2a7bdf3a0" class="colab-df-container">
    <div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Value1</th>
<th data-quarto-table-cell-role="th">Labels</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>20.801402</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>26.800208</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>33.154527</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>39.189824</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>40.631321</td>
<td>0</td>
</tr>
</tbody>
</table>

</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-29a928ae-2416-45bd-96f9-b6c2a7bdf3a0')" title="Convert this dataframe to an interactive table." style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"></path>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-29a928ae-2416-45bd-96f9-b6c2a7bdf3a0 button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-29a928ae-2416-45bd-96f9-b6c2a7bdf3a0');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


    <div id="df-cb3a6e3a-63c0-4de3-b3ab-ae2b6f2c815d">
      <button class="colab-df-quickchart" onclick="quickchart('df-cb3a6e3a-63c0-4de3-b3ab-ae2b6f2c815d')" title="Suggest charts" style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"></path>
    </g>
</svg>
      </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

      <script>
        async function quickchart(key) {
          const quickchartButtonEl =
            document.querySelector('#' + key + ' button');
          quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
          quickchartButtonEl.classList.add('colab-df-spinner');
          try {
            const charts = await google.colab.kernel.invokeFunction(
                'suggestCharts', [key], {});
          } catch (error) {
            console.error('Error during call to suggestCharts:', error);
          }
          quickchartButtonEl.classList.remove('colab-df-spinner');
          quickchartButtonEl.classList.add('colab-df-quickchart-complete');
        }
        (() => {
          let quickchartButtonEl =
            document.querySelector('#df-cb3a6e3a-63c0-4de3-b3ab-ae2b6f2c815d button');
          quickchartButtonEl.style.display =
            google.colab.kernel.accessAllowed ? 'block' : 'none';
        })();
      </script>
    </div>

    </div>
  </div>
</div>
</div>
<section id="student-eda" class="level2">
<h2 class="anchored" data-anchor-id="student-eda">Student EDA</h2>
<p>Use this cell to explore the signal (e.g., plot, summary stats).</p>
<div id="KzcnMZr1at5G" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}}" data-execution_count="5">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># STUDENT EDA</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> test_files[<span class="dv">0</span>]</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(df.head())</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'EDA note: run the original data-loading cells first (the ones that populate train_files/test_files).'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      Value1  Labels
0  20.801402       0
1  26.800208       0
2  33.154527       0
3  39.189824       0
4  40.631321       0</code></pre>
</div>
</div>
</section>
</section>
<section id="the-model" class="level1">
<h1><strong>The Model</strong></h1>
<div id="Vuw3_0LNPIKJ" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> numba <span class="im">import</span> njit</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> IsolationForest</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.svm <span class="im">import</span> OneClassSVM</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.neighbors <span class="im">import</span> LocalOutlierFactor</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.covariance <span class="im">import</span> EllipticEnvelope</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ignore"</span>,</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    message<span class="op">=</span><span class="st">"Determinant has increased; this should not happen"</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="at">@njit</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_windows_numba(series, window_size):</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    n_windows <span class="op">=</span> <span class="bu">len</span>(series) <span class="op">-</span> window_size <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>    windows <span class="op">=</span> np.empty((n_windows, window_size), dtype<span class="op">=</span>np.float32)</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n_windows):</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>        windows[i, :] <span class="op">=</span> series[i : i <span class="op">+</span> window_size]</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> windows</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a><span class="at">@njit</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> normalize_scores(scores):</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>    mn <span class="op">=</span> np.<span class="bu">min</span>(scores)</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>    mx <span class="op">=</span> np.<span class="bu">max</span>(scores)</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (scores <span class="op">-</span> mn) <span class="op">/</span> (mx <span class="op">-</span> mn <span class="op">+</span> <span class="fl">1e-8</span>)</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> AnomalyDetectionModel:</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, window_size<span class="op">=</span><span class="dv">30</span>, contamination<span class="op">=</span><span class="fl">0.01</span>):</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.window_size <span class="op">=</span> window_size</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.offset <span class="op">=</span> window_size <span class="op">//</span> <span class="dv">2</span></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.contamination <span class="op">=</span> contamination</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.scaler <span class="op">=</span> StandardScaler()</span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.models <span class="op">=</span> {</span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>            <span class="st">'IsolationForest'</span>: IsolationForest(contamination<span class="op">=</span>contamination, random_state<span class="op">=</span><span class="dv">42</span>),</span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>            <span class="st">'OneClassSVM'</span>: OneClassSVM(kernel<span class="op">=</span><span class="st">'rbf'</span>, gamma<span class="op">=</span><span class="st">'scale'</span>, nu<span class="op">=</span>contamination),</span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>            <span class="st">'EllipticEnvelope'</span>: EllipticEnvelope(contamination<span class="op">=</span>contamination,</span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>                                                 support_fraction<span class="op">=</span><span class="fl">0.75</span>,</span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>                                                 random_state<span class="op">=</span><span class="dv">42</span>),</span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.use_lof <span class="op">=</span> <span class="va">True</span></span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.lof_model <span class="op">=</span> LocalOutlierFactor(n_neighbors<span class="op">=</span><span class="dv">20</span>,</span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>                                            contamination<span class="op">=</span>contamination,</span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>                                            novelty<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.full_anomaly_mask <span class="op">=</span> <span class="va">None</span></span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> fit(<span class="va">self</span>, X: np.ndarray, y: np.ndarray <span class="op">=</span> <span class="va">None</span>):</span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.train_windows <span class="op">=</span> <span class="va">self</span>._create_windows(X)</span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.scaled_train_windows <span class="op">=</span> <span class="va">self</span>.scaler.fit_transform(<span class="va">self</span>.train_windows)</span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> model <span class="kw">in</span> <span class="va">self</span>.models.values():</span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a>            model.fit(<span class="va">self</span>.scaled_train_windows)</span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.use_lof:</span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.lof_model.fit(<span class="va">self</span>.scaled_train_windows)</span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> predict(<span class="va">self</span>, X: np.ndarray):</span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a>        test_windows <span class="op">=</span> <span class="va">self</span>._create_windows(X)</span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a>        scaled <span class="op">=</span> <span class="va">self</span>.scaler.transform(test_windows)</span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-66"><a href="#cb8-66" aria-hidden="true" tabindex="-1"></a>        all_scores <span class="op">=</span> []</span>
<span id="cb8-67"><a href="#cb8-67" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> model <span class="kw">in</span> <span class="va">self</span>.models.values():</span>
<span id="cb8-68"><a href="#cb8-68" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">hasattr</span>(model, <span class="st">"decision_function"</span>):</span>
<span id="cb8-69"><a href="#cb8-69" aria-hidden="true" tabindex="-1"></a>                s <span class="op">=</span> model.decision_function(scaled)</span>
<span id="cb8-70"><a href="#cb8-70" aria-hidden="true" tabindex="-1"></a>                all_scores.append(normalize_scores(s))</span>
<span id="cb8-71"><a href="#cb8-71" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb8-72"><a href="#cb8-72" aria-hidden="true" tabindex="-1"></a>                preds <span class="op">=</span> model.predict(scaled)</span>
<span id="cb8-73"><a href="#cb8-73" aria-hidden="true" tabindex="-1"></a>                all_scores.append(np.where(preds <span class="op">==</span> <span class="op">-</span><span class="dv">1</span>, <span class="fl">0.0</span>, <span class="fl">1.0</span>))</span>
<span id="cb8-74"><a href="#cb8-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-75"><a href="#cb8-75" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.use_lof:</span>
<span id="cb8-76"><a href="#cb8-76" aria-hidden="true" tabindex="-1"></a>            lof_s <span class="op">=</span> <span class="va">self</span>.lof_model.decision_function(scaled)</span>
<span id="cb8-77"><a href="#cb8-77" aria-hidden="true" tabindex="-1"></a>            all_scores.append(normalize_scores(lof_s))</span>
<span id="cb8-78"><a href="#cb8-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-79"><a href="#cb8-79" aria-hidden="true" tabindex="-1"></a>        avg_scores <span class="op">=</span> np.mean(np.stack(all_scores, axis<span class="op">=</span><span class="dv">0</span>), axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb8-80"><a href="#cb8-80" aria-hidden="true" tabindex="-1"></a>        thresh <span class="op">=</span> np.percentile(avg_scores, <span class="va">self</span>.contamination <span class="op">*</span> <span class="dv">100</span>)</span>
<span id="cb8-81"><a href="#cb8-81" aria-hidden="true" tabindex="-1"></a>        mask <span class="op">=</span> np.zeros(<span class="bu">len</span>(X), dtype<span class="op">=</span><span class="bu">int</span>)</span>
<span id="cb8-82"><a href="#cb8-82" aria-hidden="true" tabindex="-1"></a>        mask[<span class="va">self</span>.offset : <span class="va">self</span>.offset <span class="op">+</span> <span class="bu">len</span>(avg_scores)] <span class="op">=</span> (avg_scores <span class="op">&lt;=</span> thresh).astype(<span class="bu">int</span>)</span>
<span id="cb8-83"><a href="#cb8-83" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.full_anomaly_mask <span class="op">=</span> mask</span>
<span id="cb8-84"><a href="#cb8-84" aria-hidden="true" tabindex="-1"></a>        idx <span class="op">=</span> np.argmin(avg_scores)</span>
<span id="cb8-85"><a href="#cb8-85" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> idx <span class="op">+</span> <span class="va">self</span>.offset</span>
<span id="cb8-86"><a href="#cb8-86" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _create_windows(<span class="va">self</span>, series: np.ndarray):</span>
<span id="cb8-87"><a href="#cb8-87" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> create_windows_numba(series, <span class="va">self</span>.window_size)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="explanation" class="level2">
<h2 class="anchored" data-anchor-id="explanation">Explanation</h2>
<p>This pipeline works on the idea that:</p>
<pre><code>    1) it builds upon sliding windows
    2) gathers normalised anomaly scores from each sub-model and uses them
    3) averages the anomaly scores
    4) computes a binary mask by thresholding at the 1st percentile so that it can compare outputs
    5) stores self.full_anomaly_mask (same length as the placeholder value)
    6) returns the single index of the lowest‚Äêscore window center which closes the loop on the sliding window idea</code></pre>
</section>
<section id="student-todo-implement-your-anomaly-detector" class="level2">
<h2 class="anchored" data-anchor-id="student-todo-implement-your-anomaly-detector"><strong>STUDENT TODO ‚Äî Implement your anomaly detector</strong></h2>
<p>Implement Machine Learning/ Statistical models or both. Use the test_files (test series) to train your models and list of anomaly index range for example Anomaly 1: 2001-2005 Anomaly 2: 2010-2012</p>
<p><strong>Constraints</strong></p>
<ul>
<li>Keep it efficient; we will run this over 10 datasets and additional novel datasets in class.</li>
</ul>
<p>#EDA on given model</p>
<div id="6dFZnmJh_M8S" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Normalization</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>scaler <span class="op">=</span> StandardScaler()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="X6rP8ugg_SVE" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Reshape</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>rx <span class="op">=</span> df[<span class="st">'Value1'</span>].values.reshape(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>np_scaled <span class="op">=</span> scaler.fit_transform(rx)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> pd.DataFrame(np_scaled)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="PW8_GpaH_jP6" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:206}}" data-execution_count="9">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>data.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<div id="df-8e08d2a6-1b86-4873-8c00-ddc67bb28f9b" class="colab-df-container">
    <div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">0</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>-1.222425</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>-0.824437</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>-0.402862</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>-0.002453</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>0.093183</td>
</tr>
</tbody>
</table>

</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-8e08d2a6-1b86-4873-8c00-ddc67bb28f9b')" title="Convert this dataframe to an interactive table." style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"></path>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-8e08d2a6-1b86-4873-8c00-ddc67bb28f9b button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-8e08d2a6-1b86-4873-8c00-ddc67bb28f9b');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


    <div id="df-a3b1b2d1-edf1-44b8-ae27-7df95c44c24e">
      <button class="colab-df-quickchart" onclick="quickchart('df-a3b1b2d1-edf1-44b8-ae27-7df95c44c24e')" title="Suggest charts" style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"></path>
    </g>
</svg>
      </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

      <script>
        async function quickchart(key) {
          const quickchartButtonEl =
            document.querySelector('#' + key + ' button');
          quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
          quickchartButtonEl.classList.add('colab-df-spinner');
          try {
            const charts = await google.colab.kernel.invokeFunction(
                'suggestCharts', [key], {});
          } catch (error) {
            console.error('Error during call to suggestCharts:', error);
          }
          quickchartButtonEl.classList.remove('colab-df-spinner');
          quickchartButtonEl.classList.add('colab-df-quickchart-complete');
        }
        (() => {
          let quickchartButtonEl =
            document.querySelector('#df-a3b1b2d1-edf1-44b8-ae27-7df95c44c24e button');
          quickchartButtonEl.style.display =
            google.colab.kernel.accessAllowed ? 'block' : 'none';
        })();
      </script>
    </div>

    </div>
  </div>
</div>
</div>
<div id="scFcKa_D9DLW" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> detect_peaks_anomalies(x, min_height<span class="op">=</span><span class="va">None</span>, distance<span class="op">=</span><span class="dv">20</span>):</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Peak detection for spike anomalies - WITH StandardScaler"""</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> scipy.signal <span class="im">import</span> find_peaks</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Normalize using StandardScaler</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    scaler <span class="op">=</span> StandardScaler()</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    x_normalized <span class="op">=</span> scaler.fit_transform(x.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)).flatten()</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> min_height <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>        min_height <span class="op">=</span> <span class="fl">3.0</span>  <span class="co"># Now in standard deviation units</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>    peaks, _ <span class="op">=</span> find_peaks(x_normalized, height<span class="op">=</span>min_height, distance<span class="op">=</span>distance)</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    neg_peaks, _ <span class="op">=</span> find_peaks(<span class="op">-</span>x_normalized, height<span class="op">=</span>min_height, distance<span class="op">=</span>distance)</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">list</span>(peaks) <span class="op">+</span> <span class="bu">list</span>(neg_peaks)</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> detect_change_point_anomalies(x, window_size<span class="op">=</span><span class="dv">50</span>):</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Detect anomalies based on distribution changes - WITH StandardScaler"""</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>    anomalies <span class="op">=</span> []</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Normalize using StandardScaler</span></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>    scaler <span class="op">=</span> StandardScaler()</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>    x_normalized <span class="op">=</span> scaler.fit_transform(x.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)).flatten()</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(window_size, <span class="bu">len</span>(x_normalized) <span class="op">-</span> window_size):</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>        before_window <span class="op">=</span> x_normalized[i<span class="op">-</span>window_size:i]</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>        after_window <span class="op">=</span> x_normalized[i:i<span class="op">+</span>window_size]</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Statistical test on standardized data</span></span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>        mean_diff <span class="op">=</span> np.<span class="bu">abs</span>(np.mean(after_window) <span class="op">-</span> np.mean(before_window))</span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>        std_before <span class="op">=</span> np.std(before_window)</span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Threshold in standard deviation units</span></span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> std_before <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> mean_diff <span class="op">&gt;</span> <span class="fl">3.0</span>:  <span class="co"># 2 standard deviations</span></span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>            anomalies.append(i)</span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> anomalies</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="bgHytxtidNBj" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}}" data-execution_count="7">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Implement your anomaly detector/ detectors. You can edit this or use your own</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> student_detect_anomalies(series: np.ndarray) <span class="op">-&gt;</span> <span class="bu">list</span>:</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Input:</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="co">        series: 1D array-like of floats (test series)</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Output:</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="co">        List of (start, end) index pairs (0-based, end exclusive) for anomaly ranges.</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> np.asarray(series, dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> <span class="bu">len</span>(x)</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> n <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> []</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Rolling mean/std z-score on a smoothed series</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Smooth to get residuals</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>    w_smooth <span class="op">=</span> <span class="dv">51</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>    k <span class="op">=</span> np.ones(w_smooth) <span class="op">/</span> w_smooth</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>    smooth <span class="op">=</span> np.convolve(x, k, mode<span class="op">=</span><span class="st">'same'</span>)</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>    resid <span class="op">=</span> x <span class="op">-</span> smooth</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2) Rolling mean/std using convolution (no extra libs)</span></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>    w <span class="op">=</span> <span class="dv">61</span>  <span class="co"># odd; students may tune</span></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>    kw <span class="op">=</span> np.ones(w) <span class="op">/</span> w</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>    mu <span class="op">=</span> np.convolve(resid, kw, mode<span class="op">=</span><span class="st">'same'</span>)</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>    mu2 <span class="op">=</span> np.convolve(resid<span class="op">*</span>resid, kw, mode<span class="op">=</span><span class="st">'same'</span>)</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>    var <span class="op">=</span> np.maximum(mu2 <span class="op">-</span> mu<span class="op">*</span>mu, <span class="fl">1e-8</span>)</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>    sigma <span class="op">=</span> np.sqrt(var)</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>    z <span class="op">=</span> np.<span class="bu">abs</span>((resid <span class="op">-</span> mu) <span class="op">/</span> (sigma <span class="op">+</span> <span class="fl">1e-8</span>))</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'anomalies identified.'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>anomalies identified.</code></pre>
</div>
</div>
</section>
</section>
<section id="evaluation" class="level1">
<h1><strong>Evaluation</strong></h1>
<p>The higher the accuracy the better.</p>
<div id="1ef9b5b0" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}}" data-execution_count="8">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>correct <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> train, test <span class="kw">in</span> <span class="bu">zip</span>(train_files, test_files):</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> AnomalyDetectionModel()</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    model.fit(train.Value1.to_numpy().flatten(), train.Labels.to_numpy().flatten())</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    prediction_index <span class="op">=</span> model.predict(test.Value1.to_numpy().flatten())</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (test.loc[prediction_index, <span class="st">"Labels"</span>] <span class="op">==</span> <span class="dv">1</span>):</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>        correct <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total score: </span><span class="sc">{</span>correct<span class="sc">}</span><span class="ss">%"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Total score: 10%</code></pre>
</div>
</div>
<div id="2oGArtdohICv" class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Use other various evaluation metrics applicable to your models.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>#<strong>Limitations</strong> While the ensemble sliding-window model seems to be a good fir,it does have some downsides.</p>
<p>##<strong>Computational Cost</strong>: Because the model creates overlapping windows and runs multiple anomaly detection algorithms on each window, it can be computationally intensive‚Äîespecially for long time series or when using a small window size (which results in many windows).</p>
<p>##<strong>This means it will require increased memory usage</strong></p>
<p>##<strong>It also means longer runtime compared to a single-model approach</strong></p>
<p>It may not be suitable for very large datasets or real-time applications unless optimized or run on powerful hardware and there are some constructive bial issues that still need to be tested.</p>
<p><strong><em>For faster experiments, we could use a larger window size, downsampling the data, or disabling one or more models in the ensemble, but for this we need testing</em></strong></p>
</section>
<section id="visualisation-of-the-anomalies" class="level1">
<h1><strong>Visualisation of the anomalies</strong></h1>
<p>Reuse this code to visualize the anomalies.</p>
<div id="AySNIXYkVlh0" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:1000}}" data-execution_count="9">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> visualize_anomaly_detection(test_df, model, file_idx<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Visualizes:</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co">    - Signal (black)</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="co">    - Ground truth anomalies (red)</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="co">    - Predicted anomalies (green)</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="co">    - Most anomalous index (blue dot)</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    series <span class="op">=</span> test_df[<span class="st">'Value1'</span>].to_numpy()</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    true_mask <span class="op">=</span> test_df[<span class="st">'Labels'</span>].to_numpy().astype(<span class="bu">bool</span>)</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    pred_mask <span class="op">=</span> model.full_anomaly_mask.astype(<span class="bu">bool</span>)</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>    most_anomalous <span class="op">=</span> np.argmin(pred_mask) <span class="cf">if</span> pred_mask.<span class="bu">any</span>() <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>    pred_index <span class="op">=</span> model.predict(series)  <span class="co"># triggers .full_anomaly_mask</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">4</span>))</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>    plt.plot(series, color<span class="op">=</span><span class="st">'black'</span>, lw<span class="op">=</span><span class="dv">1</span>, label<span class="op">=</span><span class="st">'Signal'</span>)</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> pred_mask.<span class="bu">any</span>():</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>        plt.fill_between(np.arange(<span class="bu">len</span>(series)), series,</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>                         where<span class="op">=</span>pred_mask, color<span class="op">=</span><span class="st">'green'</span>, alpha<span class="op">=</span><span class="fl">0.3</span>,</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>                         label<span class="op">=</span><span class="st">'Predicted Anomaly'</span>)</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> true_mask.<span class="bu">any</span>():</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>        plt.fill_between(np.arange(<span class="bu">len</span>(series)), series,</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>                         where<span class="op">=</span>true_mask, color<span class="op">=</span><span class="st">'red'</span>, alpha<span class="op">=</span><span class="fl">0.3</span>,</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>                         label<span class="op">=</span><span class="st">'True Anomaly'</span>)</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="dv">0</span> <span class="op">&lt;=</span> pred_index <span class="op">&lt;</span> <span class="bu">len</span>(series):</span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>        plt.scatter(pred_index, series[pred_index], color<span class="op">=</span><span class="st">'blue'</span>, s<span class="op">=</span><span class="dv">50</span>, label<span class="op">=</span><span class="st">'Most Anomalous Point'</span>)</span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>    title <span class="op">=</span> <span class="ss">f"File </span><span class="sc">{</span>file_idx<span class="sc">}</span><span class="ss">"</span> <span class="cf">if</span> file_idx <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="cf">else</span> <span class="st">"Anomaly Detection"</span></span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>    plt.title(title)</span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">"Time Step"</span>)</span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">"Value"</span>)</span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>    plt.legend(loc<span class="op">=</span><span class="st">"upper right"</span>)</span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a><span class="co"># -- Loop over all files and visualize each --</span></span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx, (train, test) <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="bu">zip</span>(train_files, test_files), <span class="dv">1</span>):</span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> AnomalyDetectionModel(window_size<span class="op">=</span><span class="dv">30</span>, contamination<span class="op">=</span><span class="fl">0.01</span>)</span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a>    model.fit(train[<span class="st">'Value1'</span>].to_numpy(), train[<span class="st">'Labels'</span>].to_numpy())</span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a>    model.predict(test[<span class="st">'Value1'</span>].to_numpy())  <span class="co"># sets .full_anomaly_mask</span></span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a>    visualize_anomaly_detection(test, model, file_idx<span class="op">=</span>idx)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="IsolationForest_files/figure-html/cell-14-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="IsolationForest_files/figure-html/cell-14-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="IsolationForest_files/figure-html/cell-14-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="IsolationForest_files/figure-html/cell-14-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="IsolationForest_files/figure-html/cell-14-output-5.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="IsolationForest_files/figure-html/cell-14-output-6.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="IsolationForest_files/figure-html/cell-14-output-7.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="IsolationForest_files/figure-html/cell-14-output-8.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="IsolationForest_files/figure-html/cell-14-output-9.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="IsolationForest_files/figure-html/cell-14-output-10.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>#EDA</p>
<div id="bZcJ30lD3IMs" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:206}}">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<div id="df-6d155330-4f09-43aa-9f64-7ce34c7cba6c" class="colab-df-container">
    <div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Value1</th>
<th data-quarto-table-cell-role="th">Labels</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>20.801402</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>26.800208</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>33.154527</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>39.189824</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>40.631321</td>
<td>0</td>
</tr>
</tbody>
</table>

</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-6d155330-4f09-43aa-9f64-7ce34c7cba6c')" title="Convert this dataframe to an interactive table." style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"></path>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-6d155330-4f09-43aa-9f64-7ce34c7cba6c button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-6d155330-4f09-43aa-9f64-7ce34c7cba6c');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


    <div id="df-af653844-b099-48a6-a78a-1e0a5c74bd55">
      <button class="colab-df-quickchart" onclick="quickchart('df-af653844-b099-48a6-a78a-1e0a5c74bd55')" title="Suggest charts" style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"></path>
    </g>
</svg>
      </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

      <script>
        async function quickchart(key) {
          const quickchartButtonEl =
            document.querySelector('#' + key + ' button');
          quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
          quickchartButtonEl.classList.add('colab-df-spinner');
          try {
            const charts = await google.colab.kernel.invokeFunction(
                'suggestCharts', [key], {});
          } catch (error) {
            console.error('Error during call to suggestCharts:', error);
          }
          quickchartButtonEl.classList.remove('colab-df-spinner');
          quickchartButtonEl.classList.add('colab-df-quickchart-complete');
        }
        (() => {
          let quickchartButtonEl =
            document.querySelector('#df-af653844-b099-48a6-a78a-1e0a5c74bd55 button');
          quickchartButtonEl.style.display =
            google.colab.kernel.accessAllowed ? 'block' : 'none';
        })();
      </script>
    </div>

    </div>
  </div>
</div>
</div>
<div id="MBOLWurf4RH_" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}}">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df.shape)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Data Types"</span>, df.dtypes)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Descriptive stats:"</span>, df[<span class="st">'Value1'</span>].describe())</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>missing_vals <span class="op">=</span> df[<span class="st">'Value1'</span>].isna().<span class="bu">sum</span>()</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Missing Total values: </span><span class="sc">{</span>missing_vals<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(10000, 2)
Data Types Value1    float64
Labels      int64
dtype: object
Descriptive stats: count    10000.000000
mean        39.226792
std         15.073575
min          0.000000
25%         32.807308
50%         39.452857
75%         45.885332
max        100.000000
Name: Value1, dtype: float64

Missing Total values: 0</code></pre>
</div>
</div>
<div id="rbReJ-UoKP5r" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:300}}">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>df.describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<div id="df-928d8993-72a9-4c22-8a12-1b54809852c7" class="colab-df-container">
    <div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Value1</th>
<th data-quarto-table-cell-role="th">Labels</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">count</td>
<td>10000.000000</td>
<td>10000.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">mean</td>
<td>39.226792</td>
<td>0.089200</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">std</td>
<td>15.073575</td>
<td>0.285046</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">min</td>
<td>0.000000</td>
<td>0.000000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">25%</td>
<td>32.807308</td>
<td>0.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">50%</td>
<td>39.452857</td>
<td>0.000000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">75%</td>
<td>45.885332</td>
<td>0.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">max</td>
<td>100.000000</td>
<td>1.000000</td>
</tr>
</tbody>
</table>

</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-928d8993-72a9-4c22-8a12-1b54809852c7')" title="Convert this dataframe to an interactive table." style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"></path>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-928d8993-72a9-4c22-8a12-1b54809852c7 button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-928d8993-72a9-4c22-8a12-1b54809852c7');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


    <div id="df-a8f35faf-58a1-46f8-900f-998f66f45795">
      <button class="colab-df-quickchart" onclick="quickchart('df-a8f35faf-58a1-46f8-900f-998f66f45795')" title="Suggest charts" style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"></path>
    </g>
</svg>
      </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

      <script>
        async function quickchart(key) {
          const quickchartButtonEl =
            document.querySelector('#' + key + ' button');
          quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
          quickchartButtonEl.classList.add('colab-df-spinner');
          try {
            const charts = await google.colab.kernel.invokeFunction(
                'suggestCharts', [key], {});
          } catch (error) {
            console.error('Error during call to suggestCharts:', error);
          }
          quickchartButtonEl.classList.remove('colab-df-spinner');
          quickchartButtonEl.classList.add('colab-df-quickchart-complete');
        }
        (() => {
          let quickchartButtonEl =
            document.querySelector('#df-a8f35faf-58a1-46f8-900f-998f66f45795 button');
          quickchartButtonEl.style.display =
            google.colab.kernel.accessAllowed ? 'block' : 'none';
        })();
      </script>
    </div>

    </div>
  </div>
</div>
</div>
<div id="j_2jFd6bKcIh" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:659}}">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Show histograms - all variables except for the identifier</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>df.hist(bins <span class="op">=</span> <span class="dv">20</span>, figsize <span class="op">=</span>(<span class="dv">20</span>, <span class="dv">10</span>))</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="IsolationForest_files/figure-html/cell-18-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Comprehensive EDA with statistical analysis and visualizations</p>
<p>Proper preprocessing using StandardScaler</p>
<p>Feature engineering with rolling window statistics</p>
<p>Isolation Forest model with configurable parameters</p>
<p>Range-based detection that groups consecutive anomalies</p>
<p>Comprehensive evaluation with precision, recall, and F1-score</p>
<p>Visualization to compare true vs predicted anomalies</p>
<div id="MqRk9GtLHcgC" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:1000}}" data-execution_count="25">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Enhanced Isolation Forest Anomaly Detector with 10-anomaly target</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> IsolationForestAnomalyDetector:</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, target_anomalies<span class="op">=</span><span class="dv">10</span>, contamination_range<span class="op">=</span>(<span class="fl">0.01</span>, <span class="fl">0.2</span>), random_state<span class="op">=</span><span class="dv">42</span>):</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.target_anomalies <span class="op">=</span> target_anomalies</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.contamination_range <span class="op">=</span> contamination_range</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.random_state <span class="op">=</span> random_state</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.scaler <span class="op">=</span> StandardScaler()</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model <span class="op">=</span> <span class="va">None</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.anomaly_windows <span class="op">=</span> []</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.optimal_contamination <span class="op">=</span> <span class="va">None</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> create_features(<span class="va">self</span>, series, window_size<span class="op">=</span><span class="dv">50</span>):</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Create rolling window features for better anomaly detection"""</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>        series <span class="op">=</span> np.array(series).reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Basic statistical features</span></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>        features <span class="op">=</span> []</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Original value</span></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>        features.append(series)</span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Rolling statistics</span></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> window <span class="kw">in</span> [<span class="dv">10</span>, <span class="dv">20</span>, <span class="dv">50</span>]:</span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(series) <span class="op">&gt;=</span> window:</span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Rolling mean</span></span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>                roll_mean <span class="op">=</span> pd.Series(series.flatten()).rolling(window<span class="op">=</span>window, center<span class="op">=</span><span class="va">True</span>).mean().values.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>                features.append(roll_mean)</span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Rolling standard deviation</span></span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>                roll_std <span class="op">=</span> pd.Series(series.flatten()).rolling(window<span class="op">=</span>window, center<span class="op">=</span><span class="va">True</span>).std().values.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>                features.append(roll_std)</span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Difference from rolling mean</span></span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a>                diff_from_mean <span class="op">=</span> series <span class="op">-</span> roll_mean</span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a>                features.append(diff_from_mean)</span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add more features for better detection</span></span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Z-score</span></span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a>        z_score <span class="op">=</span> (series <span class="op">-</span> np.mean(series)) <span class="op">/</span> np.std(series)</span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a>        features.append(z_score)</span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Combine all features</span></span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true" tabindex="-1"></a>        feature_matrix <span class="op">=</span> np.hstack([f <span class="cf">for</span> f <span class="kw">in</span> features <span class="cf">if</span> f <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="kw">and</span> <span class="kw">not</span> np.<span class="bu">any</span>(np.isnan(f))])</span>
<span id="cb25-44"><a href="#cb25-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-45"><a href="#cb25-45" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Handle NaN values that might occur from rolling operations</span></span>
<span id="cb25-46"><a href="#cb25-46" aria-hidden="true" tabindex="-1"></a>        feature_matrix <span class="op">=</span> np.nan_to_num(feature_matrix)</span>
<span id="cb25-47"><a href="#cb25-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-48"><a href="#cb25-48" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> feature_matrix</span>
<span id="cb25-49"><a href="#cb25-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-50"><a href="#cb25-50" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> find_anomaly_ranges(<span class="va">self</span>, predictions, min_consecutive<span class="op">=</span><span class="dv">3</span>):</span>
<span id="cb25-51"><a href="#cb25-51" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Convert point anomalies to ranges"""</span></span>
<span id="cb25-52"><a href="#cb25-52" aria-hidden="true" tabindex="-1"></a>        anomaly_indices <span class="op">=</span> np.where(predictions <span class="op">==</span> <span class="op">-</span><span class="dv">1</span>)[<span class="dv">0</span>]</span>
<span id="cb25-53"><a href="#cb25-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-54"><a href="#cb25-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(anomaly_indices) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb25-55"><a href="#cb25-55" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> []</span>
<span id="cb25-56"><a href="#cb25-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-57"><a href="#cb25-57" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Group consecutive anomalies</span></span>
<span id="cb25-58"><a href="#cb25-58" aria-hidden="true" tabindex="-1"></a>        ranges <span class="op">=</span> []</span>
<span id="cb25-59"><a href="#cb25-59" aria-hidden="true" tabindex="-1"></a>        start <span class="op">=</span> anomaly_indices[<span class="dv">0</span>]</span>
<span id="cb25-60"><a href="#cb25-60" aria-hidden="true" tabindex="-1"></a>        end <span class="op">=</span> anomaly_indices[<span class="dv">0</span>]</span>
<span id="cb25-61"><a href="#cb25-61" aria-hidden="true" tabindex="-1"></a>        count <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb25-62"><a href="#cb25-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-63"><a href="#cb25-63" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="bu">len</span>(anomaly_indices)):</span>
<span id="cb25-64"><a href="#cb25-64" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> anomaly_indices[i] <span class="op">==</span> anomaly_indices[i<span class="op">-</span><span class="dv">1</span>] <span class="op">+</span> <span class="dv">1</span>:</span>
<span id="cb25-65"><a href="#cb25-65" aria-hidden="true" tabindex="-1"></a>                end <span class="op">=</span> anomaly_indices[i]</span>
<span id="cb25-66"><a href="#cb25-66" aria-hidden="true" tabindex="-1"></a>                count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb25-67"><a href="#cb25-67" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb25-68"><a href="#cb25-68" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Only keep ranges with minimum consecutive anomalies</span></span>
<span id="cb25-69"><a href="#cb25-69" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> count <span class="op">&gt;=</span> min_consecutive:</span>
<span id="cb25-70"><a href="#cb25-70" aria-hidden="true" tabindex="-1"></a>                    ranges.append((start, end))</span>
<span id="cb25-71"><a href="#cb25-71" aria-hidden="true" tabindex="-1"></a>                start <span class="op">=</span> anomaly_indices[i]</span>
<span id="cb25-72"><a href="#cb25-72" aria-hidden="true" tabindex="-1"></a>                end <span class="op">=</span> anomaly_indices[i]</span>
<span id="cb25-73"><a href="#cb25-73" aria-hidden="true" tabindex="-1"></a>                count <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb25-74"><a href="#cb25-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-75"><a href="#cb25-75" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add the last range</span></span>
<span id="cb25-76"><a href="#cb25-76" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> count <span class="op">&gt;=</span> min_consecutive:</span>
<span id="cb25-77"><a href="#cb25-77" aria-hidden="true" tabindex="-1"></a>            ranges.append((start, end))</span>
<span id="cb25-78"><a href="#cb25-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-79"><a href="#cb25-79" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> ranges</span>
<span id="cb25-80"><a href="#cb25-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-81"><a href="#cb25-81" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> optimize_contamination(<span class="va">self</span>, X):</span>
<span id="cb25-82"><a href="#cb25-82" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Find optimal contamination parameter to get close to target anomalies"""</span></span>
<span id="cb25-83"><a href="#cb25-83" aria-hidden="true" tabindex="-1"></a>        best_contamination <span class="op">=</span> <span class="va">self</span>.contamination_range[<span class="dv">0</span>]</span>
<span id="cb25-84"><a href="#cb25-84" aria-hidden="true" tabindex="-1"></a>        best_diff <span class="op">=</span> <span class="bu">float</span>(<span class="st">'inf'</span>)</span>
<span id="cb25-85"><a href="#cb25-85" aria-hidden="true" tabindex="-1"></a>        best_predictions <span class="op">=</span> <span class="va">None</span></span>
<span id="cb25-86"><a href="#cb25-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-87"><a href="#cb25-87" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Test multiple contamination values</span></span>
<span id="cb25-88"><a href="#cb25-88" aria-hidden="true" tabindex="-1"></a>        contamination_values <span class="op">=</span> np.linspace(<span class="va">self</span>.contamination_range[<span class="dv">0</span>], <span class="va">self</span>.contamination_range[<span class="dv">1</span>], <span class="dv">20</span>)</span>
<span id="cb25-89"><a href="#cb25-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-90"><a href="#cb25-90" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> contamination <span class="kw">in</span> contamination_values:</span>
<span id="cb25-91"><a href="#cb25-91" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Create features</span></span>
<span id="cb25-92"><a href="#cb25-92" aria-hidden="true" tabindex="-1"></a>            X_features <span class="op">=</span> <span class="va">self</span>.create_features(X)</span>
<span id="cb25-93"><a href="#cb25-93" aria-hidden="true" tabindex="-1"></a>            X_scaled <span class="op">=</span> <span class="va">self</span>.scaler.fit_transform(X_features)</span>
<span id="cb25-94"><a href="#cb25-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-95"><a href="#cb25-95" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Train Isolation Forest</span></span>
<span id="cb25-96"><a href="#cb25-96" aria-hidden="true" tabindex="-1"></a>            model <span class="op">=</span> IsolationForest(</span>
<span id="cb25-97"><a href="#cb25-97" aria-hidden="true" tabindex="-1"></a>                contamination<span class="op">=</span>contamination,</span>
<span id="cb25-98"><a href="#cb25-98" aria-hidden="true" tabindex="-1"></a>                random_state<span class="op">=</span><span class="va">self</span>.random_state,</span>
<span id="cb25-99"><a href="#cb25-99" aria-hidden="true" tabindex="-1"></a>                n_estimators<span class="op">=</span><span class="dv">100</span></span>
<span id="cb25-100"><a href="#cb25-100" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb25-101"><a href="#cb25-101" aria-hidden="true" tabindex="-1"></a>            model.fit(X_scaled)</span>
<span id="cb25-102"><a href="#cb25-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-103"><a href="#cb25-103" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Predict anomalies</span></span>
<span id="cb25-104"><a href="#cb25-104" aria-hidden="true" tabindex="-1"></a>            predictions <span class="op">=</span> model.predict(X_scaled)</span>
<span id="cb25-105"><a href="#cb25-105" aria-hidden="true" tabindex="-1"></a>            n_anomalies <span class="op">=</span> np.<span class="bu">sum</span>(predictions <span class="op">==</span> <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb25-106"><a href="#cb25-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-107"><a href="#cb25-107" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Calculate how close we are to target</span></span>
<span id="cb25-108"><a href="#cb25-108" aria-hidden="true" tabindex="-1"></a>            diff <span class="op">=</span> <span class="bu">abs</span>(n_anomalies <span class="op">-</span> <span class="va">self</span>.target_anomalies)</span>
<span id="cb25-109"><a href="#cb25-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-110"><a href="#cb25-110" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> diff <span class="op">&lt;</span> best_diff:</span>
<span id="cb25-111"><a href="#cb25-111" aria-hidden="true" tabindex="-1"></a>                best_diff <span class="op">=</span> diff</span>
<span id="cb25-112"><a href="#cb25-112" aria-hidden="true" tabindex="-1"></a>                best_contamination <span class="op">=</span> contamination</span>
<span id="cb25-113"><a href="#cb25-113" aria-hidden="true" tabindex="-1"></a>                best_predictions <span class="op">=</span> predictions</span>
<span id="cb25-114"><a href="#cb25-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-115"><a href="#cb25-115" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.optimal_contamination <span class="op">=</span> best_contamination</span>
<span id="cb25-116"><a href="#cb25-116" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> best_predictions, best_contamination</span>
<span id="cb25-117"><a href="#cb25-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-118"><a href="#cb25-118" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> fit(<span class="va">self</span>, X):</span>
<span id="cb25-119"><a href="#cb25-119" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Fit the model on training data with optimized contamination"""</span></span>
<span id="cb25-120"><a href="#cb25-120" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Optimize contamination parameter</span></span>
<span id="cb25-121"><a href="#cb25-121" aria-hidden="true" tabindex="-1"></a>        predictions, optimal_contamination <span class="op">=</span> <span class="va">self</span>.optimize_contamination(X)</span>
<span id="cb25-122"><a href="#cb25-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-123"><a href="#cb25-123" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create features</span></span>
<span id="cb25-124"><a href="#cb25-124" aria-hidden="true" tabindex="-1"></a>        X_features <span class="op">=</span> <span class="va">self</span>.create_features(X)</span>
<span id="cb25-125"><a href="#cb25-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-126"><a href="#cb25-126" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Scale the features</span></span>
<span id="cb25-127"><a href="#cb25-127" aria-hidden="true" tabindex="-1"></a>        X_scaled <span class="op">=</span> <span class="va">self</span>.scaler.fit_transform(X_features)</span>
<span id="cb25-128"><a href="#cb25-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-129"><a href="#cb25-129" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Train final Isolation Forest with optimal contamination</span></span>
<span id="cb25-130"><a href="#cb25-130" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model <span class="op">=</span> IsolationForest(</span>
<span id="cb25-131"><a href="#cb25-131" aria-hidden="true" tabindex="-1"></a>            contamination<span class="op">=</span>optimal_contamination,</span>
<span id="cb25-132"><a href="#cb25-132" aria-hidden="true" tabindex="-1"></a>            random_state<span class="op">=</span><span class="va">self</span>.random_state,</span>
<span id="cb25-133"><a href="#cb25-133" aria-hidden="true" tabindex="-1"></a>            n_estimators<span class="op">=</span><span class="dv">100</span></span>
<span id="cb25-134"><a href="#cb25-134" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb25-135"><a href="#cb25-135" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model.fit(X_scaled)</span>
<span id="cb25-136"><a href="#cb25-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-137"><a href="#cb25-137" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Store anomaly windows</span></span>
<span id="cb25-138"><a href="#cb25-138" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.anomaly_windows <span class="op">=</span> <span class="va">self</span>.find_anomaly_ranges(predictions)</span>
<span id="cb25-139"><a href="#cb25-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-140"><a href="#cb25-140" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Optimal contamination: </span><span class="sc">{</span>optimal_contamination<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb25-141"><a href="#cb25-141" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Number of anomaly points detected: </span><span class="sc">{</span>np<span class="sc">.</span><span class="bu">sum</span>(predictions <span class="op">==</span> <span class="op">-</span><span class="dv">1</span>)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb25-142"><a href="#cb25-142" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Number of anomaly ranges: </span><span class="sc">{</span><span class="bu">len</span>(<span class="va">self</span>.anomaly_windows)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb25-143"><a href="#cb25-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-144"><a href="#cb25-144" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> predict(<span class="va">self</span>, X):</span>
<span id="cb25-145"><a href="#cb25-145" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Predict anomalies on test data"""</span></span>
<span id="cb25-146"><a href="#cb25-146" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create features</span></span>
<span id="cb25-147"><a href="#cb25-147" aria-hidden="true" tabindex="-1"></a>        X_features <span class="op">=</span> <span class="va">self</span>.create_features(X)</span>
<span id="cb25-148"><a href="#cb25-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-149"><a href="#cb25-149" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Scale the features</span></span>
<span id="cb25-150"><a href="#cb25-150" aria-hidden="true" tabindex="-1"></a>        X_scaled <span class="op">=</span> <span class="va">self</span>.scaler.transform(X_features)</span>
<span id="cb25-151"><a href="#cb25-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-152"><a href="#cb25-152" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Predict anomalies</span></span>
<span id="cb25-153"><a href="#cb25-153" aria-hidden="true" tabindex="-1"></a>        predictions <span class="op">=</span> <span class="va">self</span>.model.predict(X_scaled)</span>
<span id="cb25-154"><a href="#cb25-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-155"><a href="#cb25-155" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Convert to binary (1 = normal, -1 = anomaly)</span></span>
<span id="cb25-156"><a href="#cb25-156" aria-hidden="true" tabindex="-1"></a>        binary_predictions <span class="op">=</span> np.where(predictions <span class="op">==</span> <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb25-157"><a href="#cb25-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-158"><a href="#cb25-158" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Find anomaly ranges</span></span>
<span id="cb25-159"><a href="#cb25-159" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.anomaly_windows <span class="op">=</span> <span class="va">self</span>.find_anomaly_ranges(predictions)</span>
<span id="cb25-160"><a href="#cb25-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-161"><a href="#cb25-161" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> binary_predictions</span>
<span id="cb25-162"><a href="#cb25-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-163"><a href="#cb25-163" aria-hidden="true" tabindex="-1"></a><span class="co"># Enhanced student anomaly detector with 10-anomaly target</span></span>
<span id="cb25-164"><a href="#cb25-164" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> student_detect_anomalies(series: np.ndarray) <span class="op">-&gt;</span> <span class="bu">list</span>:</span>
<span id="cb25-165"><a href="#cb25-165" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb25-166"><a href="#cb25-166" aria-hidden="true" tabindex="-1"></a><span class="co">    Input:</span></span>
<span id="cb25-167"><a href="#cb25-167" aria-hidden="true" tabindex="-1"></a><span class="co">    series: 1D array-like of floats (test series)</span></span>
<span id="cb25-168"><a href="#cb25-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-169"><a href="#cb25-169" aria-hidden="true" tabindex="-1"></a><span class="co">    Output:</span></span>
<span id="cb25-170"><a href="#cb25-170" aria-hidden="true" tabindex="-1"></a><span class="co">    List of (start, end) index pairs (0-based, end inclusive) for anomaly ranges.</span></span>
<span id="cb25-171"><a href="#cb25-171" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb25-172"><a href="#cb25-172" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> np.asarray(series, dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb25-173"><a href="#cb25-173" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> <span class="bu">len</span>(x)</span>
<span id="cb25-174"><a href="#cb25-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-175"><a href="#cb25-175" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> n <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb25-176"><a href="#cb25-176" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> []</span>
<span id="cb25-177"><a href="#cb25-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-178"><a href="#cb25-178" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Initialize and fit the Isolation Forest detector with 10-anomaly target</span></span>
<span id="cb25-179"><a href="#cb25-179" aria-hidden="true" tabindex="-1"></a>    detector <span class="op">=</span> IsolationForestAnomalyDetector(</span>
<span id="cb25-180"><a href="#cb25-180" aria-hidden="true" tabindex="-1"></a>        target_anomalies<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb25-181"><a href="#cb25-181" aria-hidden="true" tabindex="-1"></a>        contamination_range<span class="op">=</span>(<span class="fl">0.005</span>, <span class="fl">0.3</span>),  <span class="co"># Wider range to find optimal value</span></span>
<span id="cb25-182"><a href="#cb25-182" aria-hidden="true" tabindex="-1"></a>        random_state<span class="op">=</span><span class="dv">42</span></span>
<span id="cb25-183"><a href="#cb25-183" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb25-184"><a href="#cb25-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-185"><a href="#cb25-185" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fit on the test series</span></span>
<span id="cb25-186"><a href="#cb25-186" aria-hidden="true" tabindex="-1"></a>    detector.fit(x)</span>
<span id="cb25-187"><a href="#cb25-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-188"><a href="#cb25-188" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Return the detected anomaly ranges</span></span>
<span id="cb25-189"><a href="#cb25-189" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> detector.anomaly_windows</span>
<span id="cb25-190"><a href="#cb25-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-191"><a href="#cb25-191" aria-hidden="true" tabindex="-1"></a><span class="co"># Enhanced evaluation function with detailed accuracy metrics</span></span>
<span id="cb25-192"><a href="#cb25-192" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> evaluate_anomaly_detection_enhanced(true_ranges, predicted_ranges, tolerance<span class="op">=</span><span class="dv">5</span>, target_anomalies<span class="op">=</span><span class="dv">10</span>):</span>
<span id="cb25-193"><a href="#cb25-193" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb25-194"><a href="#cb25-194" aria-hidden="true" tabindex="-1"></a><span class="co">    Enhanced evaluation with accuracy metrics and target-based scoring</span></span>
<span id="cb25-195"><a href="#cb25-195" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb25-196"><a href="#cb25-196" aria-hidden="true" tabindex="-1"></a>    true_positives <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb25-197"><a href="#cb25-197" aria-hidden="true" tabindex="-1"></a>    false_positives <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb25-198"><a href="#cb25-198" aria-hidden="true" tabindex="-1"></a>    false_negatives <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb25-199"><a href="#cb25-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-200"><a href="#cb25-200" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert true ranges from labels</span></span>
<span id="cb25-201"><a href="#cb25-201" aria-hidden="true" tabindex="-1"></a>    true_anomaly_segments <span class="op">=</span> []</span>
<span id="cb25-202"><a href="#cb25-202" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> true_range <span class="kw">in</span> true_ranges:</span>
<span id="cb25-203"><a href="#cb25-203" aria-hidden="true" tabindex="-1"></a>        true_anomaly_segments.append((true_range[<span class="dv">0</span>], true_range[<span class="dv">1</span>]))</span>
<span id="cb25-204"><a href="#cb25-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-205"><a href="#cb25-205" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check each predicted range against true ranges</span></span>
<span id="cb25-206"><a href="#cb25-206" aria-hidden="true" tabindex="-1"></a>    matched_true <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb25-207"><a href="#cb25-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-208"><a href="#cb25-208" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> pred_start, pred_end <span class="kw">in</span> predicted_ranges:</span>
<span id="cb25-209"><a href="#cb25-209" aria-hidden="true" tabindex="-1"></a>        matched <span class="op">=</span> <span class="va">False</span></span>
<span id="cb25-210"><a href="#cb25-210" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i, (true_start, true_end) <span class="kw">in</span> <span class="bu">enumerate</span>(true_anomaly_segments):</span>
<span id="cb25-211"><a href="#cb25-211" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Check if predicted range overlaps with true range within tolerance</span></span>
<span id="cb25-212"><a href="#cb25-212" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (pred_start <span class="op">&lt;=</span> true_end <span class="op">+</span> tolerance <span class="kw">and</span> pred_end <span class="op">&gt;=</span> true_start <span class="op">-</span> tolerance):</span>
<span id="cb25-213"><a href="#cb25-213" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> i <span class="kw">not</span> <span class="kw">in</span> matched_true:</span>
<span id="cb25-214"><a href="#cb25-214" aria-hidden="true" tabindex="-1"></a>                    true_positives <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb25-215"><a href="#cb25-215" aria-hidden="true" tabindex="-1"></a>                    matched_true.add(i)</span>
<span id="cb25-216"><a href="#cb25-216" aria-hidden="true" tabindex="-1"></a>                    matched <span class="op">=</span> <span class="va">True</span></span>
<span id="cb25-217"><a href="#cb25-217" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">break</span></span>
<span id="cb25-218"><a href="#cb25-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-219"><a href="#cb25-219" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> matched:</span>
<span id="cb25-220"><a href="#cb25-220" aria-hidden="true" tabindex="-1"></a>            false_positives <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb25-221"><a href="#cb25-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-222"><a href="#cb25-222" aria-hidden="true" tabindex="-1"></a>    false_negatives <span class="op">=</span> <span class="bu">len</span>(true_anomaly_segments) <span class="op">-</span> <span class="bu">len</span>(matched_true)</span>
<span id="cb25-223"><a href="#cb25-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-224"><a href="#cb25-224" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate standard metrics</span></span>
<span id="cb25-225"><a href="#cb25-225" aria-hidden="true" tabindex="-1"></a>    precision <span class="op">=</span> true_positives <span class="op">/</span> (true_positives <span class="op">+</span> false_positives) <span class="cf">if</span> (true_positives <span class="op">+</span> false_positives) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb25-226"><a href="#cb25-226" aria-hidden="true" tabindex="-1"></a>    recall <span class="op">=</span> true_positives <span class="op">/</span> <span class="bu">len</span>(true_anomaly_segments) <span class="cf">if</span> <span class="bu">len</span>(true_anomaly_segments) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb25-227"><a href="#cb25-227" aria-hidden="true" tabindex="-1"></a>    f1 <span class="op">=</span> <span class="dv">2</span> <span class="op">*</span> (precision <span class="op">*</span> recall) <span class="op">/</span> (precision <span class="op">+</span> recall) <span class="cf">if</span> (precision <span class="op">+</span> recall) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb25-228"><a href="#cb25-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-229"><a href="#cb25-229" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate accuracy metrics</span></span>
<span id="cb25-230"><a href="#cb25-230" aria-hidden="true" tabindex="-1"></a>    total_predictions <span class="op">=</span> <span class="bu">len</span>(predicted_ranges)</span>
<span id="cb25-231"><a href="#cb25-231" aria-hidden="true" tabindex="-1"></a>    target_accuracy <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> <span class="bu">min</span>(<span class="bu">abs</span>(total_predictions <span class="op">-</span> target_anomalies) <span class="op">/</span> target_anomalies, <span class="fl">1.0</span>)</span>
<span id="cb25-232"><a href="#cb25-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-233"><a href="#cb25-233" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Combined score (weighted average of F1 and target accuracy)</span></span>
<span id="cb25-234"><a href="#cb25-234" aria-hidden="true" tabindex="-1"></a>    combined_score <span class="op">=</span> <span class="fl">0.7</span> <span class="op">*</span> f1 <span class="op">+</span> <span class="fl">0.3</span> <span class="op">*</span> target_accuracy</span>
<span id="cb25-235"><a href="#cb25-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-236"><a href="#cb25-236" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Detection success (1 if at least one true positive, 0 otherwise)</span></span>
<span id="cb25-237"><a href="#cb25-237" aria-hidden="true" tabindex="-1"></a>    detection_success <span class="op">=</span> <span class="dv">1</span> <span class="cf">if</span> true_positives <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb25-238"><a href="#cb25-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-239"><a href="#cb25-239" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb25-240"><a href="#cb25-240" aria-hidden="true" tabindex="-1"></a>        <span class="st">'true_positives'</span>: true_positives,</span>
<span id="cb25-241"><a href="#cb25-241" aria-hidden="true" tabindex="-1"></a>        <span class="st">'false_positives'</span>: false_positives,</span>
<span id="cb25-242"><a href="#cb25-242" aria-hidden="true" tabindex="-1"></a>        <span class="st">'false_negatives'</span>: false_negatives,</span>
<span id="cb25-243"><a href="#cb25-243" aria-hidden="true" tabindex="-1"></a>        <span class="st">'precision'</span>: precision,</span>
<span id="cb25-244"><a href="#cb25-244" aria-hidden="true" tabindex="-1"></a>        <span class="st">'recall'</span>: recall,</span>
<span id="cb25-245"><a href="#cb25-245" aria-hidden="true" tabindex="-1"></a>        <span class="st">'f1_score'</span>: f1,</span>
<span id="cb25-246"><a href="#cb25-246" aria-hidden="true" tabindex="-1"></a>        <span class="st">'target_accuracy'</span>: target_accuracy,</span>
<span id="cb25-247"><a href="#cb25-247" aria-hidden="true" tabindex="-1"></a>        <span class="st">'combined_score'</span>: combined_score,</span>
<span id="cb25-248"><a href="#cb25-248" aria-hidden="true" tabindex="-1"></a>        <span class="st">'detection_success'</span>: detection_success,</span>
<span id="cb25-249"><a href="#cb25-249" aria-hidden="true" tabindex="-1"></a>        <span class="st">'total_predicted_ranges'</span>: total_predictions,</span>
<span id="cb25-250"><a href="#cb25-250" aria-hidden="true" tabindex="-1"></a>        <span class="st">'total_true_ranges'</span>: <span class="bu">len</span>(true_anomaly_segments)</span>
<span id="cb25-251"><a href="#cb25-251" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb25-252"><a href="#cb25-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-253"><a href="#cb25-253" aria-hidden="true" tabindex="-1"></a><span class="co"># Enhanced visualization with accuracy information</span></span>
<span id="cb25-254"><a href="#cb25-254" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> visualize_anomaly_detection_with_accuracy(test_df, predicted_ranges, metrics, file_idx<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb25-255"><a href="#cb25-255" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Visualize the anomaly detection results with accuracy information"""</span></span>
<span id="cb25-256"><a href="#cb25-256" aria-hidden="true" tabindex="-1"></a>    series <span class="op">=</span> test_df[<span class="st">'Value'</span>].values <span class="cf">if</span> <span class="st">'Value'</span> <span class="kw">in</span> test_df.columns <span class="cf">else</span> test_df.iloc[:, <span class="dv">0</span>].values</span>
<span id="cb25-257"><a href="#cb25-257" aria-hidden="true" tabindex="-1"></a>    true_labels <span class="op">=</span> test_df[<span class="st">'Labels'</span>].values <span class="cf">if</span> <span class="st">'Labels'</span> <span class="kw">in</span> test_df.columns <span class="cf">else</span> test_df.iloc[:, <span class="dv">1</span>].values</span>
<span id="cb25-258"><a href="#cb25-258" aria-hidden="true" tabindex="-1"></a>    true_mask <span class="op">=</span> true_labels.astype(<span class="bu">bool</span>)</span>
<span id="cb25-259"><a href="#cb25-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-260"><a href="#cb25-260" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>(<span class="dv">16</span>, <span class="dv">8</span>))</span>
<span id="cb25-261"><a href="#cb25-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-262"><a href="#cb25-262" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot the signal</span></span>
<span id="cb25-263"><a href="#cb25-263" aria-hidden="true" tabindex="-1"></a>    plt.plot(series, color<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="dv">1</span>, label<span class="op">=</span><span class="st">'Signal'</span>)</span>
<span id="cb25-264"><a href="#cb25-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-265"><a href="#cb25-265" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot true anomalies</span></span>
<span id="cb25-266"><a href="#cb25-266" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> true_mask.<span class="bu">any</span>():</span>
<span id="cb25-267"><a href="#cb25-267" aria-hidden="true" tabindex="-1"></a>        plt.fill_between(np.arange(<span class="bu">len</span>(series)), np.<span class="bu">min</span>(series), np.<span class="bu">max</span>(series),</span>
<span id="cb25-268"><a href="#cb25-268" aria-hidden="true" tabindex="-1"></a>                        where<span class="op">=</span>true_mask, color<span class="op">=</span><span class="st">'red'</span>, alpha<span class="op">=</span><span class="fl">0.3</span>, label<span class="op">=</span><span class="st">'True Anomalies'</span>)</span>
<span id="cb25-269"><a href="#cb25-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-270"><a href="#cb25-270" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot predicted anomalies</span></span>
<span id="cb25-271"><a href="#cb25-271" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> start, end <span class="kw">in</span> predicted_ranges:</span>
<span id="cb25-272"><a href="#cb25-272" aria-hidden="true" tabindex="-1"></a>        plt.axvspan(start, end, alpha<span class="op">=</span><span class="fl">0.3</span>, color<span class="op">=</span><span class="st">'green'</span>, label<span class="op">=</span><span class="st">'Predicted Anomalies'</span> <span class="cf">if</span> start <span class="op">==</span> predicted_ranges[<span class="dv">0</span>][<span class="dv">0</span>] <span class="cf">else</span> <span class="st">""</span>)</span>
<span id="cb25-273"><a href="#cb25-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-274"><a href="#cb25-274" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add accuracy information to title</span></span>
<span id="cb25-275"><a href="#cb25-275" aria-hidden="true" tabindex="-1"></a>    title <span class="op">=</span> <span class="ss">f'File </span><span class="sc">{</span>file_idx<span class="sc">}</span><span class="ss"> - '</span> <span class="cf">if</span> file_idx <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="cf">else</span> <span class="st">''</span></span>
<span id="cb25-276"><a href="#cb25-276" aria-hidden="true" tabindex="-1"></a>    title <span class="op">+=</span> <span class="ss">f'Anomaly Detection (F1: </span><span class="sc">{</span>metrics[<span class="st">"f1_score"</span>]<span class="sc">:.3f}</span><span class="ss">, Target Acc: </span><span class="sc">{</span>metrics[<span class="st">"target_accuracy"</span>]<span class="sc">:.3f}</span><span class="ss">)'</span></span>
<span id="cb25-277"><a href="#cb25-277" aria-hidden="true" tabindex="-1"></a>    title <span class="op">+=</span> <span class="ss">f'</span><span class="ch">\n</span><span class="ss">TP: </span><span class="sc">{</span>metrics[<span class="st">"true_positives"</span>]<span class="sc">}</span><span class="ss">, FP: </span><span class="sc">{</span>metrics[<span class="st">"false_positives"</span>]<span class="sc">}</span><span class="ss">, FN: </span><span class="sc">{</span>metrics[<span class="st">"false_negatives"</span>]<span class="sc">}</span><span class="ss">'</span></span>
<span id="cb25-278"><a href="#cb25-278" aria-hidden="true" tabindex="-1"></a>    title <span class="op">+=</span> <span class="ss">f', Predicted: </span><span class="sc">{</span>metrics[<span class="st">"total_predicted_ranges"</span>]<span class="sc">}</span><span class="ss">, True: </span><span class="sc">{</span>metrics[<span class="st">"total_true_ranges"</span>]<span class="sc">}</span><span class="ss">'</span></span>
<span id="cb25-279"><a href="#cb25-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-280"><a href="#cb25-280" aria-hidden="true" tabindex="-1"></a>    plt.title(title)</span>
<span id="cb25-281"><a href="#cb25-281" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">'Time Step'</span>)</span>
<span id="cb25-282"><a href="#cb25-282" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">'Value'</span>)</span>
<span id="cb25-283"><a href="#cb25-283" aria-hidden="true" tabindex="-1"></a>    plt.legend()</span>
<span id="cb25-284"><a href="#cb25-284" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb25-285"><a href="#cb25-285" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb25-286"><a href="#cb25-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-287"><a href="#cb25-287" aria-hidden="true" tabindex="-1"></a><span class="co"># Enhanced main evaluation loop</span></span>
<span id="cb25-288"><a href="#cb25-288" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Starting Enhanced Isolation Forest Anomaly Detection Evaluation"</span>)</span>
<span id="cb25-289"><a href="#cb25-289" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"TARGET: Detect approximately 10 anomalies in each of the 10 datasets"</span>)</span>
<span id="cb25-290"><a href="#cb25-290" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb25-291"><a href="#cb25-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-292"><a href="#cb25-292" aria-hidden="true" tabindex="-1"></a>total_correct <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb25-293"><a href="#cb25-293" aria-hidden="true" tabindex="-1"></a>total_files <span class="op">=</span> <span class="bu">len</span>(test_files)</span>
<span id="cb25-294"><a href="#cb25-294" aria-hidden="true" tabindex="-1"></a>all_metrics <span class="op">=</span> []</span>
<span id="cb25-295"><a href="#cb25-295" aria-hidden="true" tabindex="-1"></a>detailed_results <span class="op">=</span> []</span>
<span id="cb25-296"><a href="#cb25-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-297"><a href="#cb25-297" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx, test_df <span class="kw">in</span> <span class="bu">enumerate</span>(test_files):</span>
<span id="cb25-298"><a href="#cb25-298" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">--- Processing File </span><span class="sc">{</span>idx<span class="sc">}</span><span class="ss"> ---"</span>)</span>
<span id="cb25-299"><a href="#cb25-299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-300"><a href="#cb25-300" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb25-301"><a href="#cb25-301" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract series and labels</span></span>
<span id="cb25-302"><a href="#cb25-302" aria-hidden="true" tabindex="-1"></a>        series <span class="op">=</span> test_df[<span class="st">'Value'</span>].values <span class="cf">if</span> <span class="st">'Value'</span> <span class="kw">in</span> test_df.columns <span class="cf">else</span> test_df.iloc[:, <span class="dv">0</span>].values</span>
<span id="cb25-303"><a href="#cb25-303" aria-hidden="true" tabindex="-1"></a>        labels <span class="op">=</span> test_df[<span class="st">'Labels'</span>].values <span class="cf">if</span> <span class="st">'Labels'</span> <span class="kw">in</span> test_df.columns <span class="cf">else</span> test_df.iloc[:, <span class="dv">1</span>].values</span>
<span id="cb25-304"><a href="#cb25-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-305"><a href="#cb25-305" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get true anomaly ranges</span></span>
<span id="cb25-306"><a href="#cb25-306" aria-hidden="true" tabindex="-1"></a>        true_ranges <span class="op">=</span> extract_true_anomaly_ranges(labels)</span>
<span id="cb25-307"><a href="#cb25-307" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"True anomaly ranges: </span><span class="sc">{</span>true_ranges<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb25-308"><a href="#cb25-308" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Number of true anomaly segments: </span><span class="sc">{</span><span class="bu">len</span>(true_ranges)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb25-309"><a href="#cb25-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-310"><a href="#cb25-310" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Detect anomalies using enhanced student's function</span></span>
<span id="cb25-311"><a href="#cb25-311" aria-hidden="true" tabindex="-1"></a>        predicted_ranges <span class="op">=</span> student_detect_anomalies(series)</span>
<span id="cb25-312"><a href="#cb25-312" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Predicted anomaly ranges: </span><span class="sc">{</span>predicted_ranges<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb25-313"><a href="#cb25-313" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Number of predicted anomaly segments: </span><span class="sc">{</span><span class="bu">len</span>(predicted_ranges)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb25-314"><a href="#cb25-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-315"><a href="#cb25-315" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Evaluate performance with target-based metrics</span></span>
<span id="cb25-316"><a href="#cb25-316" aria-hidden="true" tabindex="-1"></a>        metrics <span class="op">=</span> evaluate_anomaly_detection_enhanced(true_ranges, predicted_ranges, target_anomalies<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb25-317"><a href="#cb25-317" aria-hidden="true" tabindex="-1"></a>        all_metrics.append(metrics)</span>
<span id="cb25-318"><a href="#cb25-318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-319"><a href="#cb25-319" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Store detailed results</span></span>
<span id="cb25-320"><a href="#cb25-320" aria-hidden="true" tabindex="-1"></a>        detailed_results.append({</span>
<span id="cb25-321"><a href="#cb25-321" aria-hidden="true" tabindex="-1"></a>            <span class="st">'file_idx'</span>: idx,</span>
<span id="cb25-322"><a href="#cb25-322" aria-hidden="true" tabindex="-1"></a>            <span class="st">'true_ranges'</span>: true_ranges,</span>
<span id="cb25-323"><a href="#cb25-323" aria-hidden="true" tabindex="-1"></a>            <span class="st">'predicted_ranges'</span>: predicted_ranges,</span>
<span id="cb25-324"><a href="#cb25-324" aria-hidden="true" tabindex="-1"></a>            <span class="st">'metrics'</span>: metrics</span>
<span id="cb25-325"><a href="#cb25-325" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb25-326"><a href="#cb25-326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-327"><a href="#cb25-327" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Count correct detections (at least one true positive)</span></span>
<span id="cb25-328"><a href="#cb25-328" aria-hidden="true" tabindex="-1"></a>        correct_this_file <span class="op">=</span> metrics[<span class="st">'detection_success'</span>]</span>
<span id="cb25-329"><a href="#cb25-329" aria-hidden="true" tabindex="-1"></a>        total_correct <span class="op">+=</span> correct_this_file</span>
<span id="cb25-330"><a href="#cb25-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-331"><a href="#cb25-331" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"True Positives: </span><span class="sc">{</span>metrics[<span class="st">'true_positives'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb25-332"><a href="#cb25-332" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"False Positives: </span><span class="sc">{</span>metrics[<span class="st">'false_positives'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb25-333"><a href="#cb25-333" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"False Negatives: </span><span class="sc">{</span>metrics[<span class="st">'false_negatives'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb25-334"><a href="#cb25-334" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Precision: </span><span class="sc">{</span>metrics[<span class="st">'precision'</span>]<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb25-335"><a href="#cb25-335" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Recall: </span><span class="sc">{</span>metrics[<span class="st">'recall'</span>]<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb25-336"><a href="#cb25-336" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"F1-Score: </span><span class="sc">{</span>metrics[<span class="st">'f1_score'</span>]<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb25-337"><a href="#cb25-337" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Target Accuracy: </span><span class="sc">{</span>metrics[<span class="st">'target_accuracy'</span>]<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb25-338"><a href="#cb25-338" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Combined Score: </span><span class="sc">{</span>metrics[<span class="st">'combined_score'</span>]<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb25-339"><a href="#cb25-339" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"File </span><span class="sc">{</span>idx<span class="sc">}</span><span class="ss"> Detection Success: </span><span class="sc">{</span>correct_this_file<span class="sc">}</span><span class="ss">/1"</span>)</span>
<span id="cb25-340"><a href="#cb25-340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-341"><a href="#cb25-341" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb25-342"><a href="#cb25-342" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Error processing file </span><span class="sc">{</span>idx<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb25-343"><a href="#cb25-343" aria-hidden="true" tabindex="-1"></a>        <span class="im">import</span> traceback</span>
<span id="cb25-344"><a href="#cb25-344" aria-hidden="true" tabindex="-1"></a>        traceback.print_exc()</span>
<span id="cb25-345"><a href="#cb25-345" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add zero metrics for failed files</span></span>
<span id="cb25-346"><a href="#cb25-346" aria-hidden="true" tabindex="-1"></a>        all_metrics.append({</span>
<span id="cb25-347"><a href="#cb25-347" aria-hidden="true" tabindex="-1"></a>            <span class="st">'true_positives'</span>: <span class="dv">0</span>,</span>
<span id="cb25-348"><a href="#cb25-348" aria-hidden="true" tabindex="-1"></a>            <span class="st">'false_positives'</span>: <span class="dv">0</span>,</span>
<span id="cb25-349"><a href="#cb25-349" aria-hidden="true" tabindex="-1"></a>            <span class="st">'false_negatives'</span>: <span class="bu">len</span>(true_ranges) <span class="cf">if</span> <span class="st">'true_ranges'</span> <span class="kw">in</span> <span class="bu">locals</span>() <span class="cf">else</span> <span class="dv">0</span>,</span>
<span id="cb25-350"><a href="#cb25-350" aria-hidden="true" tabindex="-1"></a>            <span class="st">'precision'</span>: <span class="dv">0</span>,</span>
<span id="cb25-351"><a href="#cb25-351" aria-hidden="true" tabindex="-1"></a>            <span class="st">'recall'</span>: <span class="dv">0</span>,</span>
<span id="cb25-352"><a href="#cb25-352" aria-hidden="true" tabindex="-1"></a>            <span class="st">'f1_score'</span>: <span class="dv">0</span>,</span>
<span id="cb25-353"><a href="#cb25-353" aria-hidden="true" tabindex="-1"></a>            <span class="st">'target_accuracy'</span>: <span class="dv">0</span>,</span>
<span id="cb25-354"><a href="#cb25-354" aria-hidden="true" tabindex="-1"></a>            <span class="st">'combined_score'</span>: <span class="dv">0</span>,</span>
<span id="cb25-355"><a href="#cb25-355" aria-hidden="true" tabindex="-1"></a>            <span class="st">'detection_success'</span>: <span class="dv">0</span>,</span>
<span id="cb25-356"><a href="#cb25-356" aria-hidden="true" tabindex="-1"></a>            <span class="st">'total_predicted_ranges'</span>: <span class="dv">0</span>,</span>
<span id="cb25-357"><a href="#cb25-357" aria-hidden="true" tabindex="-1"></a>            <span class="st">'total_true_ranges'</span>: <span class="bu">len</span>(true_ranges) <span class="cf">if</span> <span class="st">'true_ranges'</span> <span class="kw">in</span> <span class="bu">locals</span>() <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb25-358"><a href="#cb25-358" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb25-359"><a href="#cb25-359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-360"><a href="#cb25-360" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate overall scores with enhanced metrics</span></span>
<span id="cb25-361"><a href="#cb25-361" aria-hidden="true" tabindex="-1"></a>overall_precision <span class="op">=</span> np.mean([m[<span class="st">'precision'</span>] <span class="cf">for</span> m <span class="kw">in</span> all_metrics])</span>
<span id="cb25-362"><a href="#cb25-362" aria-hidden="true" tabindex="-1"></a>overall_recall <span class="op">=</span> np.mean([m[<span class="st">'recall'</span>] <span class="cf">for</span> m <span class="kw">in</span> all_metrics])</span>
<span id="cb25-363"><a href="#cb25-363" aria-hidden="true" tabindex="-1"></a>overall_f1 <span class="op">=</span> np.mean([m[<span class="st">'f1_score'</span>] <span class="cf">for</span> m <span class="kw">in</span> all_metrics])</span>
<span id="cb25-364"><a href="#cb25-364" aria-hidden="true" tabindex="-1"></a>overall_target_accuracy <span class="op">=</span> np.mean([m[<span class="st">'target_accuracy'</span>] <span class="cf">for</span> m <span class="kw">in</span> all_metrics])</span>
<span id="cb25-365"><a href="#cb25-365" aria-hidden="true" tabindex="-1"></a>overall_combined_score <span class="op">=</span> np.mean([m[<span class="st">'combined_score'</span>] <span class="cf">for</span> m <span class="kw">in</span> all_metrics])</span>
<span id="cb25-366"><a href="#cb25-366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-367"><a href="#cb25-367" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb25-368"><a href="#cb25-368" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"FINAL ENHANCED RESULTS FOR ALL TEST FILES"</span>)</span>
<span id="cb25-369"><a href="#cb25-369" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb25-370"><a href="#cb25-370" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total files processed: </span><span class="sc">{</span>total_files<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb25-371"><a href="#cb25-371" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total correct files: </span><span class="sc">{</span>total_correct<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>total_files<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb25-372"><a href="#cb25-372" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Detection Accuracy: </span><span class="sc">{</span>(total_correct<span class="op">/</span>total_files)<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb25-373"><a href="#cb25-373" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Overall Precision: </span><span class="sc">{</span>overall_precision<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb25-374"><a href="#cb25-374" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Overall Recall: </span><span class="sc">{</span>overall_recall<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb25-375"><a href="#cb25-375" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Overall F1-Score: </span><span class="sc">{</span>overall_f1<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb25-376"><a href="#cb25-376" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Overall Target Accuracy: </span><span class="sc">{</span>overall_target_accuracy<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb25-377"><a href="#cb25-377" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Overall Combined Score: </span><span class="sc">{</span>overall_combined_score<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb25-378"><a href="#cb25-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-379"><a href="#cb25-379" aria-hidden="true" tabindex="-1"></a><span class="co"># Enhanced detailed results display</span></span>
<span id="cb25-380"><a href="#cb25-380" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb25-381"><a href="#cb25-381" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"DETAILED ENHANCED RESULTS BY FILE"</span>)</span>
<span id="cb25-382"><a href="#cb25-382" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb25-383"><a href="#cb25-383" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> result <span class="kw">in</span> detailed_results:</span>
<span id="cb25-384"><a href="#cb25-384" aria-hidden="true" tabindex="-1"></a>    m <span class="op">=</span> result[<span class="st">'metrics'</span>]</span>
<span id="cb25-385"><a href="#cb25-385" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">File </span><span class="sc">{</span>result[<span class="st">'file_idx'</span>]<span class="sc">}</span><span class="ss">:"</span>)</span>
<span id="cb25-386"><a href="#cb25-386" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  True Ranges: </span><span class="sc">{</span>result[<span class="st">'true_ranges'</span>]<span class="sc">}</span><span class="ss"> (count: </span><span class="sc">{</span><span class="bu">len</span>(result[<span class="st">'true_ranges'</span>])<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb25-387"><a href="#cb25-387" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Predicted Ranges: </span><span class="sc">{</span>result[<span class="st">'predicted_ranges'</span>]<span class="sc">}</span><span class="ss"> (count: </span><span class="sc">{</span><span class="bu">len</span>(result[<span class="st">'predicted_ranges'</span>])<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb25-388"><a href="#cb25-388" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Precision: </span><span class="sc">{</span>m[<span class="st">'precision'</span>]<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb25-389"><a href="#cb25-389" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Recall: </span><span class="sc">{</span>m[<span class="st">'recall'</span>]<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb25-390"><a href="#cb25-390" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  F1-Score: </span><span class="sc">{</span>m[<span class="st">'f1_score'</span>]<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb25-391"><a href="#cb25-391" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Target Accuracy: </span><span class="sc">{</span>m[<span class="st">'target_accuracy'</span>]<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb25-392"><a href="#cb25-392" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Combined Score: </span><span class="sc">{</span>m[<span class="st">'combined_score'</span>]<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb25-393"><a href="#cb25-393" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Detection Success: </span><span class="sc">{</span>m[<span class="st">'detection_success'</span>]<span class="sc">}</span><span class="ss">/1"</span>)</span>
<span id="cb25-394"><a href="#cb25-394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-395"><a href="#cb25-395" aria-hidden="true" tabindex="-1"></a><span class="co"># Enhanced visualization for ALL files</span></span>
<span id="cb25-396"><a href="#cb25-396" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Visualizing enhanced results for ALL files..."</span>)</span>
<span id="cb25-397"><a href="#cb25-397" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx, test_df <span class="kw">in</span> <span class="bu">enumerate</span>(test_files):</span>
<span id="cb25-398"><a href="#cb25-398" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb25-399"><a href="#cb25-399" aria-hidden="true" tabindex="-1"></a>        series <span class="op">=</span> test_df[<span class="st">'Value'</span>].values <span class="cf">if</span> <span class="st">'Value'</span> <span class="kw">in</span> test_df.columns <span class="cf">else</span> test_df.iloc[:, <span class="dv">0</span>].values</span>
<span id="cb25-400"><a href="#cb25-400" aria-hidden="true" tabindex="-1"></a>        labels <span class="op">=</span> test_df[<span class="st">'Labels'</span>].values <span class="cf">if</span> <span class="st">'Labels'</span> <span class="kw">in</span> test_df.columns <span class="cf">else</span> test_df.iloc[:, <span class="dv">1</span>].values</span>
<span id="cb25-401"><a href="#cb25-401" aria-hidden="true" tabindex="-1"></a>        true_ranges <span class="op">=</span> extract_true_anomaly_ranges(labels)</span>
<span id="cb25-402"><a href="#cb25-402" aria-hidden="true" tabindex="-1"></a>        predicted_ranges <span class="op">=</span> student_detect_anomalies(series)</span>
<span id="cb25-403"><a href="#cb25-403" aria-hidden="true" tabindex="-1"></a>        metrics <span class="op">=</span> evaluate_anomaly_detection_enhanced(true_ranges, predicted_ranges, target_anomalies<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb25-404"><a href="#cb25-404" aria-hidden="true" tabindex="-1"></a>        visualize_anomaly_detection_with_accuracy(test_df, predicted_ranges, metrics, file_idx<span class="op">=</span>idx)</span>
<span id="cb25-405"><a href="#cb25-405" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb25-406"><a href="#cb25-406" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Error visualizing file </span><span class="sc">{</span>idx<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb25-407"><a href="#cb25-407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-408"><a href="#cb25-408" aria-hidden="true" tabindex="-1"></a><span class="co"># Create comprehensive summary visualization</span></span>
<span id="cb25-409"><a href="#cb25-409" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Creating comprehensive performance summary..."</span>)</span>
<span id="cb25-410"><a href="#cb25-410" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">16</span>, <span class="dv">12</span>))</span>
<span id="cb25-411"><a href="#cb25-411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-412"><a href="#cb25-412" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot 1: Overall performance metrics</span></span>
<span id="cb25-413"><a href="#cb25-413" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">1</span>)</span>
<span id="cb25-414"><a href="#cb25-414" aria-hidden="true" tabindex="-1"></a>metrics_names <span class="op">=</span> [<span class="st">'Precision'</span>, <span class="st">'Recall'</span>, <span class="st">'F1-Score'</span>, <span class="st">'Target Acc'</span>, <span class="st">'Combined'</span>]</span>
<span id="cb25-415"><a href="#cb25-415" aria-hidden="true" tabindex="-1"></a>metrics_values <span class="op">=</span> [overall_precision, overall_recall, overall_f1, overall_target_accuracy, overall_combined_score]</span>
<span id="cb25-416"><a href="#cb25-416" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> [<span class="st">'blue'</span>, <span class="st">'green'</span>, <span class="st">'red'</span>, <span class="st">'purple'</span>, <span class="st">'orange'</span>]</span>
<span id="cb25-417"><a href="#cb25-417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-418"><a href="#cb25-418" aria-hidden="true" tabindex="-1"></a>plt.bar(metrics_names, metrics_values, color<span class="op">=</span>colors)</span>
<span id="cb25-419"><a href="#cb25-419" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Overall Performance Metrics'</span>)</span>
<span id="cb25-420"><a href="#cb25-420" aria-hidden="true" tabindex="-1"></a>plt.ylim(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb25-421"><a href="#cb25-421" aria-hidden="true" tabindex="-1"></a>plt.xticks(rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb25-422"><a href="#cb25-422" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, v <span class="kw">in</span> <span class="bu">enumerate</span>(metrics_values):</span>
<span id="cb25-423"><a href="#cb25-423" aria-hidden="true" tabindex="-1"></a>    plt.text(i, v <span class="op">+</span> <span class="fl">0.01</span>, <span class="ss">f'</span><span class="sc">{</span>v<span class="sc">:.3f}</span><span class="ss">'</span>, ha<span class="op">=</span><span class="st">'center'</span>, va<span class="op">=</span><span class="st">'bottom'</span>)</span>
<span id="cb25-424"><a href="#cb25-424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-425"><a href="#cb25-425" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot 2: Per-file F1 scores</span></span>
<span id="cb25-426"><a href="#cb25-426" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">2</span>)</span>
<span id="cb25-427"><a href="#cb25-427" aria-hidden="true" tabindex="-1"></a>file_indices <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(total_files))</span>
<span id="cb25-428"><a href="#cb25-428" aria-hidden="true" tabindex="-1"></a>f1_scores <span class="op">=</span> [m[<span class="st">'f1_score'</span>] <span class="cf">for</span> m <span class="kw">in</span> all_metrics]</span>
<span id="cb25-429"><a href="#cb25-429" aria-hidden="true" tabindex="-1"></a>plt.bar(file_indices, f1_scores, color<span class="op">=</span><span class="st">'orange'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb25-430"><a href="#cb25-430" aria-hidden="true" tabindex="-1"></a>plt.axhline(y<span class="op">=</span>overall_f1, color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, label<span class="op">=</span><span class="ss">f'Average: </span><span class="sc">{</span>overall_f1<span class="sc">:.3f}</span><span class="ss">'</span>)</span>
<span id="cb25-431"><a href="#cb25-431" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'F1-Score by File'</span>)</span>
<span id="cb25-432"><a href="#cb25-432" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'File Index'</span>)</span>
<span id="cb25-433"><a href="#cb25-433" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'F1-Score'</span>)</span>
<span id="cb25-434"><a href="#cb25-434" aria-hidden="true" tabindex="-1"></a>plt.ylim(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb25-435"><a href="#cb25-435" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb25-436"><a href="#cb25-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-437"><a href="#cb25-437" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot 3: Per-file target accuracy</span></span>
<span id="cb25-438"><a href="#cb25-438" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">3</span>)</span>
<span id="cb25-439"><a href="#cb25-439" aria-hidden="true" tabindex="-1"></a>target_accuracies <span class="op">=</span> [m[<span class="st">'target_accuracy'</span>] <span class="cf">for</span> m <span class="kw">in</span> all_metrics]</span>
<span id="cb25-440"><a href="#cb25-440" aria-hidden="true" tabindex="-1"></a>plt.bar(file_indices, target_accuracies, color<span class="op">=</span><span class="st">'purple'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb25-441"><a href="#cb25-441" aria-hidden="true" tabindex="-1"></a>plt.axhline(y<span class="op">=</span>overall_target_accuracy, color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, label<span class="op">=</span><span class="ss">f'Average: </span><span class="sc">{</span>overall_target_accuracy<span class="sc">:.3f}</span><span class="ss">'</span>)</span>
<span id="cb25-442"><a href="#cb25-442" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Target Accuracy by File'</span>)</span>
<span id="cb25-443"><a href="#cb25-443" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'File Index'</span>)</span>
<span id="cb25-444"><a href="#cb25-444" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Target Accuracy'</span>)</span>
<span id="cb25-445"><a href="#cb25-445" aria-hidden="true" tabindex="-1"></a>plt.ylim(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb25-446"><a href="#cb25-446" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb25-447"><a href="#cb25-447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-448"><a href="#cb25-448" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot 4: Detection summary</span></span>
<span id="cb25-449"><a href="#cb25-449" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">4</span>)</span>
<span id="cb25-450"><a href="#cb25-450" aria-hidden="true" tabindex="-1"></a>total_tp <span class="op">=</span> <span class="bu">sum</span>([m[<span class="st">'true_positives'</span>] <span class="cf">for</span> m <span class="kw">in</span> all_metrics])</span>
<span id="cb25-451"><a href="#cb25-451" aria-hidden="true" tabindex="-1"></a>total_fp <span class="op">=</span> <span class="bu">sum</span>([m[<span class="st">'false_positives'</span>] <span class="cf">for</span> m <span class="kw">in</span> all_metrics])</span>
<span id="cb25-452"><a href="#cb25-452" aria-hidden="true" tabindex="-1"></a>total_fn <span class="op">=</span> <span class="bu">sum</span>([m[<span class="st">'false_negatives'</span>] <span class="cf">for</span> m <span class="kw">in</span> all_metrics])</span>
<span id="cb25-453"><a href="#cb25-453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-454"><a href="#cb25-454" aria-hidden="true" tabindex="-1"></a>detection_types <span class="op">=</span> [<span class="st">'True Positives'</span>, <span class="st">'False Positives'</span>, <span class="st">'False Negatives'</span>]</span>
<span id="cb25-455"><a href="#cb25-455" aria-hidden="true" tabindex="-1"></a>detection_counts <span class="op">=</span> [total_tp, total_fp, total_fn]</span>
<span id="cb25-456"><a href="#cb25-456" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> [<span class="st">'green'</span>, <span class="st">'red'</span>, <span class="st">'orange'</span>]</span>
<span id="cb25-457"><a href="#cb25-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-458"><a href="#cb25-458" aria-hidden="true" tabindex="-1"></a>plt.bar(detection_types, detection_counts, color<span class="op">=</span>colors)</span>
<span id="cb25-459"><a href="#cb25-459" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Overall Detection Summary'</span>)</span>
<span id="cb25-460"><a href="#cb25-460" aria-hidden="true" tabindex="-1"></a>plt.xticks(rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb25-461"><a href="#cb25-461" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, v <span class="kw">in</span> <span class="bu">enumerate</span>(detection_counts):</span>
<span id="cb25-462"><a href="#cb25-462" aria-hidden="true" tabindex="-1"></a>    plt.text(i, v <span class="op">+</span> <span class="fl">0.1</span>, <span class="bu">str</span>(v), ha<span class="op">=</span><span class="st">'center'</span>, va<span class="op">=</span><span class="st">'bottom'</span>)</span>
<span id="cb25-463"><a href="#cb25-463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-464"><a href="#cb25-464" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot 5: File-wise detection success</span></span>
<span id="cb25-465"><a href="#cb25-465" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">5</span>)</span>
<span id="cb25-466"><a href="#cb25-466" aria-hidden="true" tabindex="-1"></a>file_scores <span class="op">=</span> [m[<span class="st">'detection_success'</span>] <span class="cf">for</span> m <span class="kw">in</span> all_metrics]</span>
<span id="cb25-467"><a href="#cb25-467" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> [<span class="st">'red'</span> <span class="cf">if</span> score <span class="op">==</span> <span class="dv">0</span> <span class="cf">else</span> <span class="st">'green'</span> <span class="cf">for</span> score <span class="kw">in</span> file_scores]</span>
<span id="cb25-468"><a href="#cb25-468" aria-hidden="true" tabindex="-1"></a>plt.bar(file_indices, file_scores, color<span class="op">=</span>colors)</span>
<span id="cb25-469"><a href="#cb25-469" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'File-wise Detection Success (1=Success, 0=Failure)'</span>)</span>
<span id="cb25-470"><a href="#cb25-470" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'File Index'</span>)</span>
<span id="cb25-471"><a href="#cb25-471" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Detection Success'</span>)</span>
<span id="cb25-472"><a href="#cb25-472" aria-hidden="true" tabindex="-1"></a>plt.ylim(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb25-473"><a href="#cb25-473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-474"><a href="#cb25-474" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot 6: Predicted vs Target ranges</span></span>
<span id="cb25-475"><a href="#cb25-475" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">6</span>)</span>
<span id="cb25-476"><a href="#cb25-476" aria-hidden="true" tabindex="-1"></a>predicted_counts <span class="op">=</span> [m[<span class="st">'total_predicted_ranges'</span>] <span class="cf">for</span> m <span class="kw">in</span> all_metrics]</span>
<span id="cb25-477"><a href="#cb25-477" aria-hidden="true" tabindex="-1"></a>target_line <span class="op">=</span> [<span class="dv">10</span>] <span class="op">*</span> total_files  <span class="co"># Target of 10 anomalies per file</span></span>
<span id="cb25-478"><a href="#cb25-478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-479"><a href="#cb25-479" aria-hidden="true" tabindex="-1"></a>plt.plot(file_indices, predicted_counts, <span class="st">'bo-'</span>, label<span class="op">=</span><span class="st">'Predicted Ranges'</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb25-480"><a href="#cb25-480" aria-hidden="true" tabindex="-1"></a>plt.plot(file_indices, target_line, <span class="st">'r--'</span>, label<span class="op">=</span><span class="st">'Target (10)'</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb25-481"><a href="#cb25-481" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Predicted vs Target Anomaly Ranges'</span>)</span>
<span id="cb25-482"><a href="#cb25-482" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'File Index'</span>)</span>
<span id="cb25-483"><a href="#cb25-483" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Number of Ranges'</span>)</span>
<span id="cb25-484"><a href="#cb25-484" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb25-485"><a href="#cb25-485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-486"><a href="#cb25-486" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot 7: Combined score by file</span></span>
<span id="cb25-487"><a href="#cb25-487" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">7</span>)</span>
<span id="cb25-488"><a href="#cb25-488" aria-hidden="true" tabindex="-1"></a>combined_scores <span class="op">=</span> [m[<span class="st">'combined_score'</span>] <span class="cf">for</span> m <span class="kw">in</span> all_metrics]</span>
<span id="cb25-489"><a href="#cb25-489" aria-hidden="true" tabindex="-1"></a>plt.bar(file_indices, combined_scores, color<span class="op">=</span><span class="st">'orange'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb25-490"><a href="#cb25-490" aria-hidden="true" tabindex="-1"></a>plt.axhline(y<span class="op">=</span>overall_combined_score, color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, label<span class="op">=</span><span class="ss">f'Average: </span><span class="sc">{</span>overall_combined_score<span class="sc">:.3f}</span><span class="ss">'</span>)</span>
<span id="cb25-491"><a href="#cb25-491" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Combined Score by File'</span>)</span>
<span id="cb25-492"><a href="#cb25-492" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'File Index'</span>)</span>
<span id="cb25-493"><a href="#cb25-493" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Combined Score'</span>)</span>
<span id="cb25-494"><a href="#cb25-494" aria-hidden="true" tabindex="-1"></a>plt.ylim(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb25-495"><a href="#cb25-495" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb25-496"><a href="#cb25-496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-497"><a href="#cb25-497" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb25-498"><a href="#cb25-498" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb25-499"><a href="#cb25-499" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-500"><a href="#cb25-500" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Enhanced anomaly detection completed for all test files!"</span>)</span>
<span id="cb25-501"><a href="#cb25-501" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Final Summary: </span><span class="sc">{</span>total_correct<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>total_files<span class="sc">}</span><span class="ss"> files successfully detected anomalies"</span>)</span>
<span id="cb25-502"><a href="#cb25-502" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Overall performance score: </span><span class="sc">{</span>overall_combined_score<span class="sc">:.4f}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Starting Enhanced Isolation Forest Anomaly Detection Evaluation
TARGET: Detect approximately 10 anomalies in each of the 10 datasets
======================================================================

--- Processing File 0 ---
True anomaly ranges: [(np.int64(2533), np.int64(2620)), (np.int64(2864), np.int64(2949)), (np.int64(4811), np.int64(4910)), (np.int64(5148), np.int64(5304)), (np.int64(5492), np.int64(5619)), (np.int64(5986), np.int64(6016)), (np.int64(6222), np.int64(6257)), (np.int64(7088), np.int64(7117)), (np.int64(7599), np.int64(7716)), (np.int64(8633), np.int64(8750))]
Number of true anomaly segments: 10
Optimal contamination: 0.0050
Number of anomaly points detected: 50
Number of anomaly ranges: 7
Predicted anomaly ranges: [(np.int64(2870), np.int64(2877)), (np.int64(2895), np.int64(2901)), (np.int64(2920), np.int64(2923)), (np.int64(2945), np.int64(2947)), (np.int64(7092), np.int64(7094)), (np.int64(7099), np.int64(7105)), (np.int64(7112), np.int64(7117))]
Number of predicted anomaly segments: 7
True Positives: 2
False Positives: 5
False Negatives: 8
Precision: 0.2857
Recall: 0.2000
F1-Score: 0.2353
Target Accuracy: 0.7000
Combined Score: 0.3747
File 0 Detection Success: 1/1

--- Processing File 1 ---
True anomaly ranges: [(np.int64(2206), np.int64(2325)), (np.int64(2864), np.int64(2978)), (np.int64(3483), np.int64(3565)), (np.int64(3834), np.int64(3926)), (np.int64(4758), np.int64(4878)), (np.int64(6850), np.int64(6957)), (np.int64(7852), np.int64(7954)), (np.int64(8319), np.int64(8428)), (np.int64(9112), np.int64(9225)), (np.int64(9372), np.int64(9471))]
Number of true anomaly segments: 10
Optimal contamination: 0.0050
Number of anomaly points detected: 48
Number of anomaly ranges: 8
Predicted anomaly ranges: [(np.int64(2909), np.int64(2913)), (np.int64(2926), np.int64(2929)), (np.int64(2943), np.int64(2946)), (np.int64(7894), np.int64(7896)), (np.int64(7908), np.int64(7917)), (np.int64(8355), np.int64(8364)), (np.int64(8372), np.int64(8376)), (np.int64(9387), np.int64(9389))]
Number of predicted anomaly segments: 8
True Positives: 4
False Positives: 4
False Negatives: 6
Precision: 0.5000
Recall: 0.4000
F1-Score: 0.4444
Target Accuracy: 0.8000
Combined Score: 0.5511
File 1 Detection Success: 1/1

--- Processing File 2 ---
True anomaly ranges: [(np.int64(2657), np.int64(2755)), (np.int64(3755), np.int64(3860)), (np.int64(3991), np.int64(4011)), (np.int64(4429), np.int64(4558)), (np.int64(4968), np.int64(5070)), (np.int64(6624), np.int64(6713)), (np.int64(7931), np.int64(8008)), (np.int64(8129), np.int64(8159)), (np.int64(9307), np.int64(9393)), (np.int64(9752), np.int64(9790))]
Number of true anomaly segments: 10
Optimal contamination: 0.0050
Number of anomaly points detected: 15
Number of anomaly ranges: 2
Predicted anomaly ranges: [(np.int64(4524), np.int64(4528)), (np.int64(4530), np.int64(4533))]
Number of predicted anomaly segments: 2
True Positives: 1
False Positives: 1
False Negatives: 9
Precision: 0.5000
Recall: 0.1000
F1-Score: 0.1667
Target Accuracy: 0.2000
Combined Score: 0.1767
File 2 Detection Success: 1/1

--- Processing File 3 ---
True anomaly ranges: [(np.int64(2240), np.int64(2338)), (np.int64(2824), np.int64(2912)), (np.int64(3685), np.int64(3792)), (np.int64(4212), np.int64(4244)), (np.int64(5007), np.int64(5029)), (np.int64(5758), np.int64(5870)), (np.int64(6665), np.int64(6777)), (np.int64(8492), np.int64(8521)), (np.int64(9099), np.int64(9197)), (np.int64(9628), np.int64(9724))]
Number of true anomaly segments: 10
Optimal contamination: 0.0050
Number of anomaly points detected: 50
Number of anomaly ranges: 2
Predicted anomaly ranges: [(np.int64(5020), np.int64(5023)), (np.int64(8496), np.int64(8507))]
Number of predicted anomaly segments: 2
True Positives: 2
False Positives: 0
False Negatives: 8
Precision: 1.0000
Recall: 0.2000
F1-Score: 0.3333
Target Accuracy: 0.2000
Combined Score: 0.2933
File 3 Detection Success: 1/1

--- Processing File 4 ---
True anomaly ranges: [(np.int64(2229), np.int64(2272)), (np.int64(2744), np.int64(2840)), (np.int64(3010), np.int64(3034)), (np.int64(3761), np.int64(3783)), (np.int64(5028), np.int64(5065)), (np.int64(6270), np.int64(6304)), (np.int64(8383), np.int64(8422)), (np.int64(8650), np.int64(8730)), (np.int64(9602), np.int64(9627)), (np.int64(9862), np.int64(9960))]
Number of true anomaly segments: 10
Optimal contamination: 0.0050
Number of anomaly points detected: 0
Number of anomaly ranges: 0
Predicted anomaly ranges: []
Number of predicted anomaly segments: 0
True Positives: 0
False Positives: 0
False Negatives: 10
Precision: 0.0000
Recall: 0.0000
F1-Score: 0.0000
Target Accuracy: 0.0000
Combined Score: 0.0000
File 4 Detection Success: 0/1

--- Processing File 5 ---
True anomaly ranges: [(np.int64(2661), np.int64(2775)), (np.int64(2863), np.int64(2894)), (np.int64(3006), np.int64(3124)), (np.int64(4118), np.int64(4269)), (np.int64(4463), np.int64(4591)), (np.int64(5953), np.int64(5994)), (np.int64(6107), np.int64(6225)), (np.int64(6429), np.int64(6577)), (np.int64(7969), np.int64(8094)), (np.int64(8886), np.int64(8906))]
Number of true anomaly segments: 10
Optimal contamination: 0.0050
Number of anomaly points detected: 49
Number of anomaly ranges: 9
Predicted anomaly ranges: [(np.int64(2863), np.int64(2868)), (np.int64(4205), np.int64(4209)), (np.int64(4237), np.int64(4240)), (np.int64(4242), np.int64(4244)), (np.int64(5963), np.int64(5965)), (np.int64(5976), np.int64(5978)), (np.int64(6509), np.int64(6513)), (np.int64(6541), np.int64(6544)), (np.int64(6546), np.int64(6548))]
Number of predicted anomaly segments: 9
True Positives: 4
False Positives: 5
False Negatives: 6
Precision: 0.4444
Recall: 0.4000
F1-Score: 0.4211
Target Accuracy: 0.9000
Combined Score: 0.5647
File 5 Detection Success: 1/1

--- Processing File 6 ---
True anomaly ranges: [(np.int64(2543), np.int64(2670)), (np.int64(3004), np.int64(3087)), (np.int64(3766), np.int64(3826)), (np.int64(5188), np.int64(5304)), (np.int64(5882), np.int64(5908)), (np.int64(6584), np.int64(6609)), (np.int64(7041), np.int64(7143)), (np.int64(7441), np.int64(7539)), (np.int64(9294), np.int64(9429)), (np.int64(9817), np.int64(9846))]
Number of true anomaly segments: 10
Optimal contamination: 0.0050
Number of anomaly points detected: 46
Number of anomaly ranges: 5
Predicted anomaly ranges: [(np.int64(5238), np.int64(5243)), (np.int64(5254), np.int64(5256)), (np.int64(5894), np.int64(5901)), (np.int64(9360), np.int64(9362)), (np.int64(9372), np.int64(9379))]
Number of predicted anomaly segments: 5
True Positives: 3
False Positives: 2
False Negatives: 7
Precision: 0.6000
Recall: 0.3000
F1-Score: 0.4000
Target Accuracy: 0.5000
Combined Score: 0.4300
File 6 Detection Success: 1/1

--- Processing File 7 ---
True anomaly ranges: [(np.int64(2165), np.int64(2305)), (np.int64(2570), np.int64(2611)), (np.int64(4188), np.int64(4306)), (np.int64(4572), np.int64(4721)), (np.int64(5008), np.int64(5095)), (np.int64(6491), np.int64(6560)), (np.int64(7365), np.int64(7484)), (np.int64(8348), np.int64(8452)), (np.int64(8592), np.int64(8614)), (np.int64(9537), np.int64(9614))]
Number of true anomaly segments: 10
Optimal contamination: 0.0050
Number of anomaly points detected: 48
Number of anomaly ranges: 3
Predicted anomaly ranges: [(np.int64(2570), np.int64(2573)), (np.int64(4675), np.int64(4677)), (np.int64(5026), np.int64(5032))]
Number of predicted anomaly segments: 3
True Positives: 3
False Positives: 0
False Negatives: 7
Precision: 1.0000
Recall: 0.3000
F1-Score: 0.4615
Target Accuracy: 0.3000
Combined Score: 0.4131
File 7 Detection Success: 1/1

--- Processing File 8 ---
True anomaly ranges: [(np.int64(2340), np.int64(2407)), (np.int64(2594), np.int64(2698)), (np.int64(4708), np.int64(4787)), (np.int64(5387), np.int64(5480)), (np.int64(6153), np.int64(6267)), (np.int64(6479), np.int64(6580)), (np.int64(7548), np.int64(7569)), (np.int64(8021), np.int64(8058)), (np.int64(8299), np.int64(8329)), (np.int64(9827), np.int64(9904))]
Number of true anomaly segments: 10
Optimal contamination: 0.0050
Number of anomaly points detected: 1
Number of anomaly ranges: 0
Predicted anomaly ranges: []
Number of predicted anomaly segments: 0
True Positives: 0
False Positives: 0
False Negatives: 10
Precision: 0.0000
Recall: 0.0000
F1-Score: 0.0000
Target Accuracy: 0.0000
Combined Score: 0.0000
File 8 Detection Success: 0/1

--- Processing File 9 ---
True anomaly ranges: [(np.int64(3463), np.int64(3494)), (np.int64(3896), np.int64(3993)), (np.int64(4143), np.int64(4224)), (np.int64(5471), np.int64(5578)), (np.int64(6064), np.int64(6145)), (np.int64(6543), np.int64(6636)), (np.int64(7889), np.int64(8021)), (np.int64(8650), np.int64(8756)), (np.int64(9074), np.int64(9225)), (np.int64(9621), np.int64(9740))]
Number of true anomaly segments: 10
Optimal contamination: 0.0050
Number of anomaly points detected: 49
Number of anomaly ranges: 6
Predicted anomaly ranges: [(np.int64(3905), np.int64(3907)), (np.int64(3928), np.int64(3932)), (np.int64(3951), np.int64(3957)), (np.int64(3975), np.int64(3980)), (np.int64(6096), np.int64(6118)), (np.int64(6545), np.int64(6547))]
Number of predicted anomaly segments: 6
True Positives: 3
False Positives: 3
False Negatives: 7
Precision: 0.5000
Recall: 0.3000
F1-Score: 0.3750
Target Accuracy: 0.6000
Combined Score: 0.4425
File 9 Detection Success: 1/1

======================================================================
FINAL ENHANCED RESULTS FOR ALL TEST FILES
======================================================================
Total files processed: 10
Total correct files: 8/10
Detection Accuracy: 80.00%
Overall Precision: 0.4830
Overall Recall: 0.2200
Overall F1-Score: 0.2837
Overall Target Accuracy: 0.4200
Overall Combined Score: 0.3246

======================================================================
DETAILED ENHANCED RESULTS BY FILE
======================================================================

File 0:
  True Ranges: [(np.int64(2533), np.int64(2620)), (np.int64(2864), np.int64(2949)), (np.int64(4811), np.int64(4910)), (np.int64(5148), np.int64(5304)), (np.int64(5492), np.int64(5619)), (np.int64(5986), np.int64(6016)), (np.int64(6222), np.int64(6257)), (np.int64(7088), np.int64(7117)), (np.int64(7599), np.int64(7716)), (np.int64(8633), np.int64(8750))] (count: 10)
  Predicted Ranges: [(np.int64(2870), np.int64(2877)), (np.int64(2895), np.int64(2901)), (np.int64(2920), np.int64(2923)), (np.int64(2945), np.int64(2947)), (np.int64(7092), np.int64(7094)), (np.int64(7099), np.int64(7105)), (np.int64(7112), np.int64(7117))] (count: 7)
  Precision: 0.2857
  Recall: 0.2000
  F1-Score: 0.2353
  Target Accuracy: 0.7000
  Combined Score: 0.3747
  Detection Success: 1/1

File 1:
  True Ranges: [(np.int64(2206), np.int64(2325)), (np.int64(2864), np.int64(2978)), (np.int64(3483), np.int64(3565)), (np.int64(3834), np.int64(3926)), (np.int64(4758), np.int64(4878)), (np.int64(6850), np.int64(6957)), (np.int64(7852), np.int64(7954)), (np.int64(8319), np.int64(8428)), (np.int64(9112), np.int64(9225)), (np.int64(9372), np.int64(9471))] (count: 10)
  Predicted Ranges: [(np.int64(2909), np.int64(2913)), (np.int64(2926), np.int64(2929)), (np.int64(2943), np.int64(2946)), (np.int64(7894), np.int64(7896)), (np.int64(7908), np.int64(7917)), (np.int64(8355), np.int64(8364)), (np.int64(8372), np.int64(8376)), (np.int64(9387), np.int64(9389))] (count: 8)
  Precision: 0.5000
  Recall: 0.4000
  F1-Score: 0.4444
  Target Accuracy: 0.8000
  Combined Score: 0.5511
  Detection Success: 1/1

File 2:
  True Ranges: [(np.int64(2657), np.int64(2755)), (np.int64(3755), np.int64(3860)), (np.int64(3991), np.int64(4011)), (np.int64(4429), np.int64(4558)), (np.int64(4968), np.int64(5070)), (np.int64(6624), np.int64(6713)), (np.int64(7931), np.int64(8008)), (np.int64(8129), np.int64(8159)), (np.int64(9307), np.int64(9393)), (np.int64(9752), np.int64(9790))] (count: 10)
  Predicted Ranges: [(np.int64(4524), np.int64(4528)), (np.int64(4530), np.int64(4533))] (count: 2)
  Precision: 0.5000
  Recall: 0.1000
  F1-Score: 0.1667
  Target Accuracy: 0.2000
  Combined Score: 0.1767
  Detection Success: 1/1

File 3:
  True Ranges: [(np.int64(2240), np.int64(2338)), (np.int64(2824), np.int64(2912)), (np.int64(3685), np.int64(3792)), (np.int64(4212), np.int64(4244)), (np.int64(5007), np.int64(5029)), (np.int64(5758), np.int64(5870)), (np.int64(6665), np.int64(6777)), (np.int64(8492), np.int64(8521)), (np.int64(9099), np.int64(9197)), (np.int64(9628), np.int64(9724))] (count: 10)
  Predicted Ranges: [(np.int64(5020), np.int64(5023)), (np.int64(8496), np.int64(8507))] (count: 2)
  Precision: 1.0000
  Recall: 0.2000
  F1-Score: 0.3333
  Target Accuracy: 0.2000
  Combined Score: 0.2933
  Detection Success: 1/1

File 4:
  True Ranges: [(np.int64(2229), np.int64(2272)), (np.int64(2744), np.int64(2840)), (np.int64(3010), np.int64(3034)), (np.int64(3761), np.int64(3783)), (np.int64(5028), np.int64(5065)), (np.int64(6270), np.int64(6304)), (np.int64(8383), np.int64(8422)), (np.int64(8650), np.int64(8730)), (np.int64(9602), np.int64(9627)), (np.int64(9862), np.int64(9960))] (count: 10)
  Predicted Ranges: [] (count: 0)
  Precision: 0.0000
  Recall: 0.0000
  F1-Score: 0.0000
  Target Accuracy: 0.0000
  Combined Score: 0.0000
  Detection Success: 0/1

File 5:
  True Ranges: [(np.int64(2661), np.int64(2775)), (np.int64(2863), np.int64(2894)), (np.int64(3006), np.int64(3124)), (np.int64(4118), np.int64(4269)), (np.int64(4463), np.int64(4591)), (np.int64(5953), np.int64(5994)), (np.int64(6107), np.int64(6225)), (np.int64(6429), np.int64(6577)), (np.int64(7969), np.int64(8094)), (np.int64(8886), np.int64(8906))] (count: 10)
  Predicted Ranges: [(np.int64(2863), np.int64(2868)), (np.int64(4205), np.int64(4209)), (np.int64(4237), np.int64(4240)), (np.int64(4242), np.int64(4244)), (np.int64(5963), np.int64(5965)), (np.int64(5976), np.int64(5978)), (np.int64(6509), np.int64(6513)), (np.int64(6541), np.int64(6544)), (np.int64(6546), np.int64(6548))] (count: 9)
  Precision: 0.4444
  Recall: 0.4000
  F1-Score: 0.4211
  Target Accuracy: 0.9000
  Combined Score: 0.5647
  Detection Success: 1/1

File 6:
  True Ranges: [(np.int64(2543), np.int64(2670)), (np.int64(3004), np.int64(3087)), (np.int64(3766), np.int64(3826)), (np.int64(5188), np.int64(5304)), (np.int64(5882), np.int64(5908)), (np.int64(6584), np.int64(6609)), (np.int64(7041), np.int64(7143)), (np.int64(7441), np.int64(7539)), (np.int64(9294), np.int64(9429)), (np.int64(9817), np.int64(9846))] (count: 10)
  Predicted Ranges: [(np.int64(5238), np.int64(5243)), (np.int64(5254), np.int64(5256)), (np.int64(5894), np.int64(5901)), (np.int64(9360), np.int64(9362)), (np.int64(9372), np.int64(9379))] (count: 5)
  Precision: 0.6000
  Recall: 0.3000
  F1-Score: 0.4000
  Target Accuracy: 0.5000
  Combined Score: 0.4300
  Detection Success: 1/1

File 7:
  True Ranges: [(np.int64(2165), np.int64(2305)), (np.int64(2570), np.int64(2611)), (np.int64(4188), np.int64(4306)), (np.int64(4572), np.int64(4721)), (np.int64(5008), np.int64(5095)), (np.int64(6491), np.int64(6560)), (np.int64(7365), np.int64(7484)), (np.int64(8348), np.int64(8452)), (np.int64(8592), np.int64(8614)), (np.int64(9537), np.int64(9614))] (count: 10)
  Predicted Ranges: [(np.int64(2570), np.int64(2573)), (np.int64(4675), np.int64(4677)), (np.int64(5026), np.int64(5032))] (count: 3)
  Precision: 1.0000
  Recall: 0.3000
  F1-Score: 0.4615
  Target Accuracy: 0.3000
  Combined Score: 0.4131
  Detection Success: 1/1

File 8:
  True Ranges: [(np.int64(2340), np.int64(2407)), (np.int64(2594), np.int64(2698)), (np.int64(4708), np.int64(4787)), (np.int64(5387), np.int64(5480)), (np.int64(6153), np.int64(6267)), (np.int64(6479), np.int64(6580)), (np.int64(7548), np.int64(7569)), (np.int64(8021), np.int64(8058)), (np.int64(8299), np.int64(8329)), (np.int64(9827), np.int64(9904))] (count: 10)
  Predicted Ranges: [] (count: 0)
  Precision: 0.0000
  Recall: 0.0000
  F1-Score: 0.0000
  Target Accuracy: 0.0000
  Combined Score: 0.0000
  Detection Success: 0/1

File 9:
  True Ranges: [(np.int64(3463), np.int64(3494)), (np.int64(3896), np.int64(3993)), (np.int64(4143), np.int64(4224)), (np.int64(5471), np.int64(5578)), (np.int64(6064), np.int64(6145)), (np.int64(6543), np.int64(6636)), (np.int64(7889), np.int64(8021)), (np.int64(8650), np.int64(8756)), (np.int64(9074), np.int64(9225)), (np.int64(9621), np.int64(9740))] (count: 10)
  Predicted Ranges: [(np.int64(3905), np.int64(3907)), (np.int64(3928), np.int64(3932)), (np.int64(3951), np.int64(3957)), (np.int64(3975), np.int64(3980)), (np.int64(6096), np.int64(6118)), (np.int64(6545), np.int64(6547))] (count: 6)
  Precision: 0.5000
  Recall: 0.3000
  F1-Score: 0.3750
  Target Accuracy: 0.6000
  Combined Score: 0.4425
  Detection Success: 1/1

Visualizing enhanced results for ALL files...
Optimal contamination: 0.0050
Number of anomaly points detected: 50
Number of anomaly ranges: 7</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="IsolationForest_files/figure-html/cell-19-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Optimal contamination: 0.0050
Number of anomaly points detected: 48
Number of anomaly ranges: 8</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="IsolationForest_files/figure-html/cell-19-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Optimal contamination: 0.0050
Number of anomaly points detected: 15
Number of anomaly ranges: 2</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="IsolationForest_files/figure-html/cell-19-output-6.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Optimal contamination: 0.0050
Number of anomaly points detected: 50
Number of anomaly ranges: 2</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="IsolationForest_files/figure-html/cell-19-output-8.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Optimal contamination: 0.0050
Number of anomaly points detected: 0
Number of anomaly ranges: 0</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="IsolationForest_files/figure-html/cell-19-output-10.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Optimal contamination: 0.0050
Number of anomaly points detected: 49
Number of anomaly ranges: 9</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="IsolationForest_files/figure-html/cell-19-output-12.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Optimal contamination: 0.0050
Number of anomaly points detected: 46
Number of anomaly ranges: 5</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="IsolationForest_files/figure-html/cell-19-output-14.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Optimal contamination: 0.0050
Number of anomaly points detected: 48
Number of anomaly ranges: 3</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="IsolationForest_files/figure-html/cell-19-output-16.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Optimal contamination: 0.0050
Number of anomaly points detected: 1
Number of anomaly ranges: 0</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="IsolationForest_files/figure-html/cell-19-output-18.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Optimal contamination: 0.0050
Number of anomaly points detected: 49
Number of anomaly ranges: 6</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="IsolationForest_files/figure-html/cell-19-output-20.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Creating comprehensive performance summary...</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="IsolationForest_files/figure-html/cell-19-output-22.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Enhanced anomaly detection completed for all test files!
Final Summary: 8/10 files successfully detected anomalies
Overall performance score: 0.3246</code></pre>
</div>
</div>
<p>#Isolation Forest and Z-score Hybrid Model</p>
<p>###Data Processing &amp; Feature Engineering Extracts true anomaly ranges from label arrays using extract_true_anomaly_ranges()</p>
<p>Creates enhanced features including:</p>
<p>Original time series values</p>
<p>Multiple rolling window statistics (mean, std, min, max) across different window sizes</p>
<p>Z-scores based on rolling statistics</p>
<p>Global statistics (mean, std, z-score)</p>
<p>Rate of change and second derivatives</p>
<p>Differences from rolling means</p>
<section id="anomaly-detection-methods" class="level3">
<h3 class="anchored" data-anchor-id="anomaly-detection-methods">Anomaly Detection Methods</h3>
<section id="primary-high-precision-isolation-forest" class="level4">
<h4 class="anchored" data-anchor-id="primary-high-precision-isolation-forest">Primary: High-Precision Isolation Forest</h4>
<p>Uses lower contamination range (0.05-0.2) for fewer false positives</p>
<p>Optimizes contamination parameter specifically for precision</p>
<p>Enhanced configuration: 150 estimators, smaller samples, feature subsetting</p>
<p>Anti-overfitting measures: max_samples=128, max_features=0.7</p>
</section>
<section id="secondary-statistical-z-score-detection" class="level4">
<h4 class="anchored" data-anchor-id="secondary-statistical-z-score-detection">Secondary: Statistical Z-Score Detection</h4>
<p>Maintains Z-score threshold at 3.0 standard deviations</p>
<p>Uses stricter range grouping with minimum 3 consecutive points</p>
<p>Only keeps substantial anomaly ranges</p>
</section>
</section>
<section id="range-processing-grouping" class="level3">
<h3 class="anchored" data-anchor-id="range-processing-grouping">Range Processing &amp; Grouping</h3>
<p>Stricter range grouping: Maximum 5-point gaps between anomalies (was 10)</p>
<p>Minimum length requirement: 3+ consecutive anomalies to form a range</p>
<p>Selective range combination: Only keeps substantial ranges from both methods</p>
<p>Conservative merging: Smaller merge distance (10 points)</p>
<div id="x1uQgvOrpFdO" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}}" data-execution_count="15">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract true anomaly ranges from labels</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_true_anomaly_ranges(labels):</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Extract contiguous anomaly ranges from label array"""</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>    labels <span class="op">=</span> np.array(labels)</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>    anomaly_indices <span class="op">=</span> np.where(labels <span class="op">==</span> <span class="dv">1</span>)[<span class="dv">0</span>]</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(anomaly_indices) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> []</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>    ranges <span class="op">=</span> []</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>    start <span class="op">=</span> anomaly_indices[<span class="dv">0</span>]</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>    end <span class="op">=</span> anomaly_indices[<span class="dv">0</span>]</span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="bu">len</span>(anomaly_indices)):</span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> anomaly_indices[i] <span class="op">==</span> anomaly_indices[i<span class="op">-</span><span class="dv">1</span>] <span class="op">+</span> <span class="dv">1</span>:</span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>            end <span class="op">=</span> anomaly_indices[i]</span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>            ranges.append((start, end))</span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a>            start <span class="op">=</span> anomaly_indices[i]</span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a>            end <span class="op">=</span> anomaly_indices[i]</span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a>    ranges.append((start, end))</span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ranges</span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a><span class="co"># High Precision Isolation Forest Anomaly Detector (Z-score threshold = 3.0)</span></span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> HighPrecisionIsolationForestDetector:</span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, contamination_range<span class="op">=</span>(<span class="fl">0.05</span>, <span class="fl">0.2</span>), random_state<span class="op">=</span><span class="dv">42</span>):  <span class="co"># REDUCED range</span></span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.contamination_range <span class="op">=</span> contamination_range  <span class="co"># Lower: 0.05-0.2</span></span>
<span id="cb38-29"><a href="#cb38-29" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.random_state <span class="op">=</span> random_state</span>
<span id="cb38-30"><a href="#cb38-30" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.scaler <span class="op">=</span> StandardScaler()</span>
<span id="cb38-31"><a href="#cb38-31" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model <span class="op">=</span> <span class="va">None</span></span>
<span id="cb38-32"><a href="#cb38-32" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.anomaly_windows <span class="op">=</span> []</span>
<span id="cb38-33"><a href="#cb38-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-34"><a href="#cb38-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> create_enhanced_features(<span class="va">self</span>, series, window_sizes<span class="op">=</span>[<span class="dv">10</span>, <span class="dv">20</span>, <span class="dv">50</span>, <span class="dv">100</span>]):</span>
<span id="cb38-35"><a href="#cb38-35" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Enhanced feature engineering with multiple statistical features"""</span></span>
<span id="cb38-36"><a href="#cb38-36" aria-hidden="true" tabindex="-1"></a>        series <span class="op">=</span> np.array(series).flatten()  <span class="co"># Ensure 1D array</span></span>
<span id="cb38-37"><a href="#cb38-37" aria-hidden="true" tabindex="-1"></a>        features <span class="op">=</span> []</span>
<span id="cb38-38"><a href="#cb38-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-39"><a href="#cb38-39" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Original series (reshape to 2D for stacking)</span></span>
<span id="cb38-40"><a href="#cb38-40" aria-hidden="true" tabindex="-1"></a>        features.append(series.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb38-41"><a href="#cb38-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-42"><a href="#cb38-42" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Multiple rolling window statistics</span></span>
<span id="cb38-43"><a href="#cb38-43" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> window <span class="kw">in</span> window_sizes:</span>
<span id="cb38-44"><a href="#cb38-44" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(series) <span class="op">&gt;=</span> window:</span>
<span id="cb38-45"><a href="#cb38-45" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Rolling statistics</span></span>
<span id="cb38-46"><a href="#cb38-46" aria-hidden="true" tabindex="-1"></a>                roll_mean <span class="op">=</span> pd.Series(series).rolling(window<span class="op">=</span>window, center<span class="op">=</span><span class="va">True</span>).mean().values.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb38-47"><a href="#cb38-47" aria-hidden="true" tabindex="-1"></a>                roll_std <span class="op">=</span> pd.Series(series).rolling(window<span class="op">=</span>window, center<span class="op">=</span><span class="va">True</span>).std().values.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb38-48"><a href="#cb38-48" aria-hidden="true" tabindex="-1"></a>                roll_min <span class="op">=</span> pd.Series(series).rolling(window<span class="op">=</span>window, center<span class="op">=</span><span class="va">True</span>).<span class="bu">min</span>().values.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb38-49"><a href="#cb38-49" aria-hidden="true" tabindex="-1"></a>                roll_max <span class="op">=</span> pd.Series(series).rolling(window<span class="op">=</span>window, center<span class="op">=</span><span class="va">True</span>).<span class="bu">max</span>().values.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb38-50"><a href="#cb38-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-51"><a href="#cb38-51" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Handle NaN values</span></span>
<span id="cb38-52"><a href="#cb38-52" aria-hidden="true" tabindex="-1"></a>                roll_mean <span class="op">=</span> np.nan_to_num(roll_mean)</span>
<span id="cb38-53"><a href="#cb38-53" aria-hidden="true" tabindex="-1"></a>                roll_std <span class="op">=</span> np.nan_to_num(roll_std)</span>
<span id="cb38-54"><a href="#cb38-54" aria-hidden="true" tabindex="-1"></a>                roll_min <span class="op">=</span> np.nan_to_num(roll_min)</span>
<span id="cb38-55"><a href="#cb38-55" aria-hidden="true" tabindex="-1"></a>                roll_max <span class="op">=</span> np.nan_to_num(roll_max)</span>
<span id="cb38-56"><a href="#cb38-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-57"><a href="#cb38-57" aria-hidden="true" tabindex="-1"></a>                features.extend([roll_mean, roll_std, roll_min, roll_max])</span>
<span id="cb38-58"><a href="#cb38-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-59"><a href="#cb38-59" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Z-score based on rolling statistics</span></span>
<span id="cb38-60"><a href="#cb38-60" aria-hidden="true" tabindex="-1"></a>                z_score <span class="op">=</span> (series.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>) <span class="op">-</span> roll_mean) <span class="op">/</span> (roll_std <span class="op">+</span> <span class="fl">1e-8</span>)</span>
<span id="cb38-61"><a href="#cb38-61" aria-hidden="true" tabindex="-1"></a>                features.append(z_score)</span>
<span id="cb38-62"><a href="#cb38-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-63"><a href="#cb38-63" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Differences and changes</span></span>
<span id="cb38-64"><a href="#cb38-64" aria-hidden="true" tabindex="-1"></a>                diff_from_mean <span class="op">=</span> series.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>) <span class="op">-</span> roll_mean</span>
<span id="cb38-65"><a href="#cb38-65" aria-hidden="true" tabindex="-1"></a>                features.append(diff_from_mean)</span>
<span id="cb38-66"><a href="#cb38-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-67"><a href="#cb38-67" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Global statistics</span></span>
<span id="cb38-68"><a href="#cb38-68" aria-hidden="true" tabindex="-1"></a>        global_mean <span class="op">=</span> np.full((<span class="bu">len</span>(series), <span class="dv">1</span>), np.mean(series))</span>
<span id="cb38-69"><a href="#cb38-69" aria-hidden="true" tabindex="-1"></a>        global_std <span class="op">=</span> np.full((<span class="bu">len</span>(series), <span class="dv">1</span>), np.std(series))</span>
<span id="cb38-70"><a href="#cb38-70" aria-hidden="true" tabindex="-1"></a>        global_z <span class="op">=</span> (series.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>) <span class="op">-</span> global_mean) <span class="op">/</span> (global_std <span class="op">+</span> <span class="fl">1e-8</span>)</span>
<span id="cb38-71"><a href="#cb38-71" aria-hidden="true" tabindex="-1"></a>        features.extend([global_mean, global_std, global_z])</span>
<span id="cb38-72"><a href="#cb38-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-73"><a href="#cb38-73" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Rate of change and derivatives</span></span>
<span id="cb38-74"><a href="#cb38-74" aria-hidden="true" tabindex="-1"></a>        diff_1 <span class="op">=</span> np.diff(series, prepend<span class="op">=</span>series[<span class="dv">0</span>])</span>
<span id="cb38-75"><a href="#cb38-75" aria-hidden="true" tabindex="-1"></a>        diff_2 <span class="op">=</span> np.diff(diff_1, prepend<span class="op">=</span>diff_1[<span class="dv">0</span>])</span>
<span id="cb38-76"><a href="#cb38-76" aria-hidden="true" tabindex="-1"></a>        features.extend([diff_1.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>), diff_2.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)])</span>
<span id="cb38-77"><a href="#cb38-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-78"><a href="#cb38-78" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Combine features</span></span>
<span id="cb38-79"><a href="#cb38-79" aria-hidden="true" tabindex="-1"></a>        feature_matrix <span class="op">=</span> np.hstack([f <span class="cf">for</span> f <span class="kw">in</span> features <span class="cf">if</span> f <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>])</span>
<span id="cb38-80"><a href="#cb38-80" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> feature_matrix</span>
<span id="cb38-81"><a href="#cb38-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-82"><a href="#cb38-82" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> find_anomaly_ranges_stricter(<span class="va">self</span>, predictions, max_gap<span class="op">=</span><span class="dv">5</span>, min_length<span class="op">=</span><span class="dv">3</span>):</span>
<span id="cb38-83"><a href="#cb38-83" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Stricter range grouping to reduce false positives"""</span></span>
<span id="cb38-84"><a href="#cb38-84" aria-hidden="true" tabindex="-1"></a>        anomaly_indices <span class="op">=</span> np.where(predictions <span class="op">==</span> <span class="op">-</span><span class="dv">1</span>)[<span class="dv">0</span>]</span>
<span id="cb38-85"><a href="#cb38-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-86"><a href="#cb38-86" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(anomaly_indices) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb38-87"><a href="#cb38-87" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> []</span>
<span id="cb38-88"><a href="#cb38-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-89"><a href="#cb38-89" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Group anomalies with smaller allowed gaps</span></span>
<span id="cb38-90"><a href="#cb38-90" aria-hidden="true" tabindex="-1"></a>        ranges <span class="op">=</span> []</span>
<span id="cb38-91"><a href="#cb38-91" aria-hidden="true" tabindex="-1"></a>        start <span class="op">=</span> anomaly_indices[<span class="dv">0</span>]</span>
<span id="cb38-92"><a href="#cb38-92" aria-hidden="true" tabindex="-1"></a>        end <span class="op">=</span> anomaly_indices[<span class="dv">0</span>]</span>
<span id="cb38-93"><a href="#cb38-93" aria-hidden="true" tabindex="-1"></a>        consecutive_count <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb38-94"><a href="#cb38-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-95"><a href="#cb38-95" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="bu">len</span>(anomaly_indices)):</span>
<span id="cb38-96"><a href="#cb38-96" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> anomaly_indices[i] <span class="op">&lt;=</span> anomaly_indices[i<span class="op">-</span><span class="dv">1</span>] <span class="op">+</span> max_gap:  <span class="co"># Smaller gap</span></span>
<span id="cb38-97"><a href="#cb38-97" aria-hidden="true" tabindex="-1"></a>                end <span class="op">=</span> anomaly_indices[i]</span>
<span id="cb38-98"><a href="#cb38-98" aria-hidden="true" tabindex="-1"></a>                consecutive_count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb38-99"><a href="#cb38-99" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb38-100"><a href="#cb38-100" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Only keep ranges with minimum length</span></span>
<span id="cb38-101"><a href="#cb38-101" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> consecutive_count <span class="op">&gt;=</span> min_length:  <span class="co"># Minimum length requirement</span></span>
<span id="cb38-102"><a href="#cb38-102" aria-hidden="true" tabindex="-1"></a>                    ranges.append((start, end))</span>
<span id="cb38-103"><a href="#cb38-103" aria-hidden="true" tabindex="-1"></a>                start <span class="op">=</span> anomaly_indices[i]</span>
<span id="cb38-104"><a href="#cb38-104" aria-hidden="true" tabindex="-1"></a>                end <span class="op">=</span> anomaly_indices[i]</span>
<span id="cb38-105"><a href="#cb38-105" aria-hidden="true" tabindex="-1"></a>                consecutive_count <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb38-106"><a href="#cb38-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-107"><a href="#cb38-107" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Only keep the last range if it meets minimum length</span></span>
<span id="cb38-108"><a href="#cb38-108" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> consecutive_count <span class="op">&gt;=</span> min_length:</span>
<span id="cb38-109"><a href="#cb38-109" aria-hidden="true" tabindex="-1"></a>            ranges.append((start, end))</span>
<span id="cb38-110"><a href="#cb38-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-111"><a href="#cb38-111" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> ranges</span>
<span id="cb38-112"><a href="#cb38-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-113"><a href="#cb38-113" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> statistical_anomaly_detection(<span class="va">self</span>, series, z_threshold<span class="op">=</span><span class="fl">3.0</span>):  <span class="co"># KEEP: 3.0</span></span>
<span id="cb38-114"><a href="#cb38-114" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Statistical method using Z-scores with threshold = 3.0"""</span></span>
<span id="cb38-115"><a href="#cb38-115" aria-hidden="true" tabindex="-1"></a>        z_scores <span class="op">=</span> np.<span class="bu">abs</span>((series <span class="op">-</span> np.mean(series)) <span class="op">/</span> (np.std(series) <span class="op">+</span> <span class="fl">1e-8</span>))</span>
<span id="cb38-116"><a href="#cb38-116" aria-hidden="true" tabindex="-1"></a>        statistical_anomalies <span class="op">=</span> np.where(z_scores <span class="op">&gt;</span> z_threshold)[<span class="dv">0</span>]</span>
<span id="cb38-117"><a href="#cb38-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-118"><a href="#cb38-118" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Convert point anomalies to ranges with STRICTER grouping</span></span>
<span id="cb38-119"><a href="#cb38-119" aria-hidden="true" tabindex="-1"></a>        stat_ranges <span class="op">=</span> []</span>
<span id="cb38-120"><a href="#cb38-120" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(statistical_anomalies) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb38-121"><a href="#cb38-121" aria-hidden="true" tabindex="-1"></a>            start <span class="op">=</span> statistical_anomalies[<span class="dv">0</span>]</span>
<span id="cb38-122"><a href="#cb38-122" aria-hidden="true" tabindex="-1"></a>            end <span class="op">=</span> statistical_anomalies[<span class="dv">0</span>]</span>
<span id="cb38-123"><a href="#cb38-123" aria-hidden="true" tabindex="-1"></a>            consecutive_count <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb38-124"><a href="#cb38-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-125"><a href="#cb38-125" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="bu">len</span>(statistical_anomalies)):</span>
<span id="cb38-126"><a href="#cb38-126" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> statistical_anomalies[i] <span class="op">&lt;=</span> statistical_anomalies[i<span class="op">-</span><span class="dv">1</span>] <span class="op">+</span> <span class="dv">3</span>:  <span class="co"># STRICTER: 5 to 3</span></span>
<span id="cb38-127"><a href="#cb38-127" aria-hidden="true" tabindex="-1"></a>                    end <span class="op">=</span> statistical_anomalies[i]</span>
<span id="cb38-128"><a href="#cb38-128" aria-hidden="true" tabindex="-1"></a>                    consecutive_count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb38-129"><a href="#cb38-129" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb38-130"><a href="#cb38-130" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Only keep ranges with minimum length</span></span>
<span id="cb38-131"><a href="#cb38-131" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> consecutive_count <span class="op">&gt;=</span> <span class="dv">3</span>:  <span class="co"># Minimum 3 consecutive points</span></span>
<span id="cb38-132"><a href="#cb38-132" aria-hidden="true" tabindex="-1"></a>                        stat_ranges.append((start, end))</span>
<span id="cb38-133"><a href="#cb38-133" aria-hidden="true" tabindex="-1"></a>                    start <span class="op">=</span> statistical_anomalies[i]</span>
<span id="cb38-134"><a href="#cb38-134" aria-hidden="true" tabindex="-1"></a>                    end <span class="op">=</span> statistical_anomalies[i]</span>
<span id="cb38-135"><a href="#cb38-135" aria-hidden="true" tabindex="-1"></a>                    consecutive_count <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb38-136"><a href="#cb38-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-137"><a href="#cb38-137" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> consecutive_count <span class="op">&gt;=</span> <span class="dv">3</span>:  <span class="co"># Minimum 3 consecutive points</span></span>
<span id="cb38-138"><a href="#cb38-138" aria-hidden="true" tabindex="-1"></a>                stat_ranges.append((start, end))</span>
<span id="cb38-139"><a href="#cb38-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-140"><a href="#cb38-140" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> stat_ranges</span>
<span id="cb38-141"><a href="#cb38-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-142"><a href="#cb38-142" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> optimize_contamination_for_precision(<span class="va">self</span>, X, target_precision<span class="op">=</span><span class="fl">0.7</span>):</span>
<span id="cb38-143"><a href="#cb38-143" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Optimize contamination parameter for better precision"""</span></span>
<span id="cb38-144"><a href="#cb38-144" aria-hidden="true" tabindex="-1"></a>        best_contamination <span class="op">=</span> <span class="va">self</span>.contamination_range[<span class="dv">0</span>]</span>
<span id="cb38-145"><a href="#cb38-145" aria-hidden="true" tabindex="-1"></a>        best_score <span class="op">=</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb38-146"><a href="#cb38-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-147"><a href="#cb38-147" aria-hidden="true" tabindex="-1"></a>        contamination_values <span class="op">=</span> np.linspace(<span class="va">self</span>.contamination_range[<span class="dv">0</span>], <span class="va">self</span>.contamination_range[<span class="dv">1</span>], <span class="dv">20</span>)</span>
<span id="cb38-148"><a href="#cb38-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-149"><a href="#cb38-149" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> contamination <span class="kw">in</span> contamination_values:</span>
<span id="cb38-150"><a href="#cb38-150" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb38-151"><a href="#cb38-151" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Create features</span></span>
<span id="cb38-152"><a href="#cb38-152" aria-hidden="true" tabindex="-1"></a>                X_features <span class="op">=</span> <span class="va">self</span>.create_enhanced_features(X)</span>
<span id="cb38-153"><a href="#cb38-153" aria-hidden="true" tabindex="-1"></a>                X_scaled <span class="op">=</span> <span class="va">self</span>.scaler.fit_transform(X_features)</span>
<span id="cb38-154"><a href="#cb38-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-155"><a href="#cb38-155" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Train Isolation Forest</span></span>
<span id="cb38-156"><a href="#cb38-156" aria-hidden="true" tabindex="-1"></a>                model <span class="op">=</span> IsolationForest(</span>
<span id="cb38-157"><a href="#cb38-157" aria-hidden="true" tabindex="-1"></a>                    contamination<span class="op">=</span>contamination,</span>
<span id="cb38-158"><a href="#cb38-158" aria-hidden="true" tabindex="-1"></a>                    random_state<span class="op">=</span><span class="va">self</span>.random_state,</span>
<span id="cb38-159"><a href="#cb38-159" aria-hidden="true" tabindex="-1"></a>                    n_estimators<span class="op">=</span><span class="dv">150</span>,  <span class="co"># More trees for stability</span></span>
<span id="cb38-160"><a href="#cb38-160" aria-hidden="true" tabindex="-1"></a>                    max_samples<span class="op">=</span><span class="dv">128</span>,   <span class="co"># Smaller samples for less overfitting</span></span>
<span id="cb38-161"><a href="#cb38-161" aria-hidden="true" tabindex="-1"></a>                    max_features<span class="op">=</span><span class="fl">0.7</span>,  <span class="co"># Use subset of features</span></span>
<span id="cb38-162"><a href="#cb38-162" aria-hidden="true" tabindex="-1"></a>                    n_jobs<span class="op">=-</span><span class="dv">1</span></span>
<span id="cb38-163"><a href="#cb38-163" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb38-164"><a href="#cb38-164" aria-hidden="true" tabindex="-1"></a>                model.fit(X_scaled)</span>
<span id="cb38-165"><a href="#cb38-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-166"><a href="#cb38-166" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Predict anomalies</span></span>
<span id="cb38-167"><a href="#cb38-167" aria-hidden="true" tabindex="-1"></a>                predictions <span class="op">=</span> model.predict(X_scaled)</span>
<span id="cb38-168"><a href="#cb38-168" aria-hidden="true" tabindex="-1"></a>                pred_ranges <span class="op">=</span> <span class="va">self</span>.find_anomaly_ranges_stricter(predictions)</span>
<span id="cb38-169"><a href="#cb38-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-170"><a href="#cb38-170" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Use anomaly count as precision proxy</span></span>
<span id="cb38-171"><a href="#cb38-171" aria-hidden="true" tabindex="-1"></a>                anomaly_ratio <span class="op">=</span> np.<span class="bu">sum</span>(predictions <span class="op">==</span> <span class="op">-</span><span class="dv">1</span>) <span class="op">/</span> <span class="bu">len</span>(predictions)</span>
<span id="cb38-172"><a href="#cb38-172" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Lower anomaly ratio typically means higher precision</span></span>
<span id="cb38-173"><a href="#cb38-173" aria-hidden="true" tabindex="-1"></a>                precision_proxy <span class="op">=</span> <span class="fl">1.0</span> <span class="op">-</span> <span class="bu">min</span>(anomaly_ratio <span class="op">*</span> <span class="dv">3</span>, <span class="fl">0.9</span>)  <span class="co"># Favor lower contamination</span></span>
<span id="cb38-174"><a href="#cb38-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-175"><a href="#cb38-175" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> precision_proxy <span class="op">&gt;</span> best_score:</span>
<span id="cb38-176"><a href="#cb38-176" aria-hidden="true" tabindex="-1"></a>                    best_score <span class="op">=</span> precision_proxy</span>
<span id="cb38-177"><a href="#cb38-177" aria-hidden="true" tabindex="-1"></a>                    best_contamination <span class="op">=</span> contamination</span>
<span id="cb38-178"><a href="#cb38-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-179"><a href="#cb38-179" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb38-180"><a href="#cb38-180" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb38-181"><a href="#cb38-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-182"><a href="#cb38-182" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> best_contamination</span>
<span id="cb38-183"><a href="#cb38-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-184"><a href="#cb38-184" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> fit_predict(<span class="va">self</span>, X):</span>
<span id="cb38-185"><a href="#cb38-185" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Fit and predict with precision optimization"""</span></span>
<span id="cb38-186"><a href="#cb38-186" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb38-187"><a href="#cb38-187" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Optimize contamination for precision</span></span>
<span id="cb38-188"><a href="#cb38-188" aria-hidden="true" tabindex="-1"></a>            optimal_contamination <span class="op">=</span> <span class="va">self</span>.optimize_contamination_for_precision(X)</span>
<span id="cb38-189"><a href="#cb38-189" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Optimal contamination for precision: </span><span class="sc">{</span>optimal_contamination<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb38-190"><a href="#cb38-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-191"><a href="#cb38-191" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Create enhanced features</span></span>
<span id="cb38-192"><a href="#cb38-192" aria-hidden="true" tabindex="-1"></a>            X_features <span class="op">=</span> <span class="va">self</span>.create_enhanced_features(X)</span>
<span id="cb38-193"><a href="#cb38-193" aria-hidden="true" tabindex="-1"></a>            X_scaled <span class="op">=</span> <span class="va">self</span>.scaler.fit_transform(X_features)</span>
<span id="cb38-194"><a href="#cb38-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-195"><a href="#cb38-195" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Train Isolation Forest with precision-optimized parameters</span></span>
<span id="cb38-196"><a href="#cb38-196" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.model <span class="op">=</span> IsolationForest(</span>
<span id="cb38-197"><a href="#cb38-197" aria-hidden="true" tabindex="-1"></a>                contamination<span class="op">=</span>optimal_contamination,</span>
<span id="cb38-198"><a href="#cb38-198" aria-hidden="true" tabindex="-1"></a>                random_state<span class="op">=</span><span class="va">self</span>.random_state,</span>
<span id="cb38-199"><a href="#cb38-199" aria-hidden="true" tabindex="-1"></a>                n_estimators<span class="op">=</span><span class="dv">150</span>,</span>
<span id="cb38-200"><a href="#cb38-200" aria-hidden="true" tabindex="-1"></a>                max_samples<span class="op">=</span><span class="dv">128</span>,  <span class="co"># Smaller for less overfitting</span></span>
<span id="cb38-201"><a href="#cb38-201" aria-hidden="true" tabindex="-1"></a>                max_features<span class="op">=</span><span class="fl">0.7</span>, <span class="co"># Use subset of features</span></span>
<span id="cb38-202"><a href="#cb38-202" aria-hidden="true" tabindex="-1"></a>                n_jobs<span class="op">=-</span><span class="dv">1</span></span>
<span id="cb38-203"><a href="#cb38-203" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb38-204"><a href="#cb38-204" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.model.fit(X_scaled)</span>
<span id="cb38-205"><a href="#cb38-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-206"><a href="#cb38-206" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Get Isolation Forest predictions with STRICTER range grouping</span></span>
<span id="cb38-207"><a href="#cb38-207" aria-hidden="true" tabindex="-1"></a>            iso_predictions <span class="op">=</span> <span class="va">self</span>.model.predict(X_scaled)</span>
<span id="cb38-208"><a href="#cb38-208" aria-hidden="true" tabindex="-1"></a>            iso_ranges <span class="op">=</span> <span class="va">self</span>.find_anomaly_ranges_stricter(iso_predictions, max_gap<span class="op">=</span><span class="dv">5</span>, min_length<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb38-209"><a href="#cb38-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-210"><a href="#cb38-210" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Get statistical method predictions with Z-threshold = 3.0</span></span>
<span id="cb38-211"><a href="#cb38-211" aria-hidden="true" tabindex="-1"></a>            stat_ranges <span class="op">=</span> <span class="va">self</span>.statistical_anomaly_detection(X, z_threshold<span class="op">=</span><span class="fl">3.0</span>)  <span class="co"># KEEP: 3.0</span></span>
<span id="cb38-212"><a href="#cb38-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-213"><a href="#cb38-213" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Combine methods but be more selective</span></span>
<span id="cb38-214"><a href="#cb38-214" aria-hidden="true" tabindex="-1"></a>            all_ranges <span class="op">=</span> []</span>
<span id="cb38-215"><a href="#cb38-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-216"><a href="#cb38-216" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Only add Isolation Forest ranges if they're substantial</span></span>
<span id="cb38-217"><a href="#cb38-217" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> start, end <span class="kw">in</span> iso_ranges:</span>
<span id="cb38-218"><a href="#cb38-218" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> (end <span class="op">-</span> start) <span class="op">&gt;=</span> <span class="dv">2</span>:  <span class="co"># Minimum 3 points</span></span>
<span id="cb38-219"><a href="#cb38-219" aria-hidden="true" tabindex="-1"></a>                    all_ranges.append((start, end))</span>
<span id="cb38-220"><a href="#cb38-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-221"><a href="#cb38-221" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Only add Z-score ranges if they're very clear</span></span>
<span id="cb38-222"><a href="#cb38-222" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> start, end <span class="kw">in</span> stat_ranges:</span>
<span id="cb38-223"><a href="#cb38-223" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> (end <span class="op">-</span> start) <span class="op">&gt;=</span> <span class="dv">2</span>:  <span class="co"># Minimum 3 points for Z-score</span></span>
<span id="cb38-224"><a href="#cb38-224" aria-hidden="true" tabindex="-1"></a>                    all_ranges.append((start, end))</span>
<span id="cb38-225"><a href="#cb38-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-226"><a href="#cb38-226" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Merge overlapping ranges with STRICTER criteria</span></span>
<span id="cb38-227"><a href="#cb38-227" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> all_ranges:</span>
<span id="cb38-228"><a href="#cb38-228" aria-hidden="true" tabindex="-1"></a>                all_ranges.sort()</span>
<span id="cb38-229"><a href="#cb38-229" aria-hidden="true" tabindex="-1"></a>                merged_ranges <span class="op">=</span> []</span>
<span id="cb38-230"><a href="#cb38-230" aria-hidden="true" tabindex="-1"></a>                current_start, current_end <span class="op">=</span> all_ranges[<span class="dv">0</span>]</span>
<span id="cb38-231"><a href="#cb38-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-232"><a href="#cb38-232" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> start, end <span class="kw">in</span> all_ranges[<span class="dv">1</span>:]:</span>
<span id="cb38-233"><a href="#cb38-233" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> start <span class="op">&lt;=</span> current_end <span class="op">+</span> <span class="dv">10</span>:  <span class="co"># Smaller merge distance</span></span>
<span id="cb38-234"><a href="#cb38-234" aria-hidden="true" tabindex="-1"></a>                        current_end <span class="op">=</span> <span class="bu">max</span>(current_end, end)</span>
<span id="cb38-235"><a href="#cb38-235" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">else</span>:</span>
<span id="cb38-236"><a href="#cb38-236" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Only keep merged range if substantial</span></span>
<span id="cb38-237"><a href="#cb38-237" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> (current_end <span class="op">-</span> current_start) <span class="op">&gt;=</span> <span class="dv">2</span>:</span>
<span id="cb38-238"><a href="#cb38-238" aria-hidden="true" tabindex="-1"></a>                            merged_ranges.append((current_start, current_end))</span>
<span id="cb38-239"><a href="#cb38-239" aria-hidden="true" tabindex="-1"></a>                        current_start, current_end <span class="op">=</span> start, end</span>
<span id="cb38-240"><a href="#cb38-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-241"><a href="#cb38-241" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> (current_end <span class="op">-</span> current_start) <span class="op">&gt;=</span> <span class="dv">2</span>:</span>
<span id="cb38-242"><a href="#cb38-242" aria-hidden="true" tabindex="-1"></a>                    merged_ranges.append((current_start, current_end))</span>
<span id="cb38-243"><a href="#cb38-243" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.anomaly_windows <span class="op">=</span> merged_ranges</span>
<span id="cb38-244"><a href="#cb38-244" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb38-245"><a href="#cb38-245" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.anomaly_windows <span class="op">=</span> []</span>
<span id="cb38-246"><a href="#cb38-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-247"><a href="#cb38-247" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Detected </span><span class="sc">{</span><span class="bu">len</span>(<span class="va">self</span>.anomaly_windows)<span class="sc">}</span><span class="ss"> high-confidence anomaly ranges"</span>)</span>
<span id="cb38-248"><a href="#cb38-248" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Isolation Forest ranges: </span><span class="sc">{</span><span class="bu">len</span>(iso_ranges)<span class="sc">}</span><span class="ss">, Z-score ranges: </span><span class="sc">{</span><span class="bu">len</span>(stat_ranges)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-249"><a href="#cb38-249" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">self</span>.anomaly_windows</span>
<span id="cb38-250"><a href="#cb38-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-251"><a href="#cb38-251" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb38-252"><a href="#cb38-252" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Error in fit_predict: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-253"><a href="#cb38-253" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">self</span>.fallback_detection_precision(X)</span>
<span id="cb38-254"><a href="#cb38-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-255"><a href="#cb38-255" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> fallback_detection_precision(<span class="va">self</span>, X):</span>
<span id="cb38-256"><a href="#cb38-256" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Fallback with high precision settings"""</span></span>
<span id="cb38-257"><a href="#cb38-257" aria-hidden="true" tabindex="-1"></a>        <span class="im">from</span> sklearn.ensemble <span class="im">import</span> IsolationForest</span>
<span id="cb38-258"><a href="#cb38-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-259"><a href="#cb38-259" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Use lower contamination for higher precision</span></span>
<span id="cb38-260"><a href="#cb38-260" aria-hidden="true" tabindex="-1"></a>        model <span class="op">=</span> IsolationForest(</span>
<span id="cb38-261"><a href="#cb38-261" aria-hidden="true" tabindex="-1"></a>            contamination<span class="op">=</span><span class="fl">0.08</span>,  <span class="co"># Much lower</span></span>
<span id="cb38-262"><a href="#cb38-262" aria-hidden="true" tabindex="-1"></a>            random_state<span class="op">=</span><span class="va">self</span>.random_state,</span>
<span id="cb38-263"><a href="#cb38-263" aria-hidden="true" tabindex="-1"></a>            n_estimators<span class="op">=</span><span class="dv">100</span></span>
<span id="cb38-264"><a href="#cb38-264" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb38-265"><a href="#cb38-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-266"><a href="#cb38-266" aria-hidden="true" tabindex="-1"></a>        predictions <span class="op">=</span> model.fit_predict(X.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb38-267"><a href="#cb38-267" aria-hidden="true" tabindex="-1"></a>        anomaly_indices <span class="op">=</span> np.where(predictions <span class="op">==</span> <span class="op">-</span><span class="dv">1</span>)[<span class="dv">0</span>]</span>
<span id="cb38-268"><a href="#cb38-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-269"><a href="#cb38-269" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Stricter range grouping</span></span>
<span id="cb38-270"><a href="#cb38-270" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(anomaly_indices) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb38-271"><a href="#cb38-271" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> []</span>
<span id="cb38-272"><a href="#cb38-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-273"><a href="#cb38-273" aria-hidden="true" tabindex="-1"></a>        ranges <span class="op">=</span> []</span>
<span id="cb38-274"><a href="#cb38-274" aria-hidden="true" tabindex="-1"></a>        start <span class="op">=</span> anomaly_indices[<span class="dv">0</span>]</span>
<span id="cb38-275"><a href="#cb38-275" aria-hidden="true" tabindex="-1"></a>        end <span class="op">=</span> anomaly_indices[<span class="dv">0</span>]</span>
<span id="cb38-276"><a href="#cb38-276" aria-hidden="true" tabindex="-1"></a>        consecutive_count <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb38-277"><a href="#cb38-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-278"><a href="#cb38-278" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="bu">len</span>(anomaly_indices)):</span>
<span id="cb38-279"><a href="#cb38-279" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> anomaly_indices[i] <span class="op">&lt;=</span> anomaly_indices[i<span class="op">-</span><span class="dv">1</span>] <span class="op">+</span> <span class="dv">5</span>:  <span class="co"># Stricter</span></span>
<span id="cb38-280"><a href="#cb38-280" aria-hidden="true" tabindex="-1"></a>                end <span class="op">=</span> anomaly_indices[i]</span>
<span id="cb38-281"><a href="#cb38-281" aria-hidden="true" tabindex="-1"></a>                consecutive_count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb38-282"><a href="#cb38-282" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb38-283"><a href="#cb38-283" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> consecutive_count <span class="op">&gt;=</span> <span class="dv">3</span>:  <span class="co"># Minimum length</span></span>
<span id="cb38-284"><a href="#cb38-284" aria-hidden="true" tabindex="-1"></a>                    ranges.append((start, end))</span>
<span id="cb38-285"><a href="#cb38-285" aria-hidden="true" tabindex="-1"></a>                start <span class="op">=</span> anomaly_indices[i]</span>
<span id="cb38-286"><a href="#cb38-286" aria-hidden="true" tabindex="-1"></a>                end <span class="op">=</span> anomaly_indices[i]</span>
<span id="cb38-287"><a href="#cb38-287" aria-hidden="true" tabindex="-1"></a>                consecutive_count <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb38-288"><a href="#cb38-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-289"><a href="#cb38-289" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> consecutive_count <span class="op">&gt;=</span> <span class="dv">3</span>:</span>
<span id="cb38-290"><a href="#cb38-290" aria-hidden="true" tabindex="-1"></a>            ranges.append((start, end))</span>
<span id="cb38-291"><a href="#cb38-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-292"><a href="#cb38-292" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> ranges</span>
<span id="cb38-293"><a href="#cb38-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-294"><a href="#cb38-294" aria-hidden="true" tabindex="-1"></a><span class="co"># Updated student detection function for higher precision (Z-score threshold = 3.0)</span></span>
<span id="cb38-295"><a href="#cb38-295" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> student_detect_anomalies(series: np.ndarray) <span class="op">-&gt;</span> <span class="bu">list</span>:</span>
<span id="cb38-296"><a href="#cb38-296" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb38-297"><a href="#cb38-297" aria-hidden="true" tabindex="-1"></a><span class="co">    High-precision version using stricter parameters with Z-score = 3.0</span></span>
<span id="cb38-298"><a href="#cb38-298" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb38-299"><a href="#cb38-299" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> np.asarray(series, dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb38-300"><a href="#cb38-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-301"><a href="#cb38-301" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(x) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb38-302"><a href="#cb38-302" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> []</span>
<span id="cb38-303"><a href="#cb38-303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-304"><a href="#cb38-304" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb38-305"><a href="#cb38-305" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Use the high-precision detector</span></span>
<span id="cb38-306"><a href="#cb38-306" aria-hidden="true" tabindex="-1"></a>        detector <span class="op">=</span> HighPrecisionIsolationForestDetector(contamination_range<span class="op">=</span>(<span class="fl">0.05</span>, <span class="fl">0.2</span>))</span>
<span id="cb38-307"><a href="#cb38-307" aria-hidden="true" tabindex="-1"></a>        ranges <span class="op">=</span> detector.fit_predict(x)</span>
<span id="cb38-308"><a href="#cb38-308" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> ranges</span>
<span id="cb38-309"><a href="#cb38-309" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb38-310"><a href="#cb38-310" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Error in student_detect_anomalies: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-311"><a href="#cb38-311" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> student_detect_anomalies_simple(series)</span>
<span id="cb38-312"><a href="#cb38-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-313"><a href="#cb38-313" aria-hidden="true" tabindex="-1"></a><span class="co"># Simple fallback function (keep as backup)</span></span>
<span id="cb38-314"><a href="#cb38-314" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> student_detect_anomalies_simple(series: np.ndarray) <span class="op">-&gt;</span> <span class="bu">list</span>:</span>
<span id="cb38-315"><a href="#cb38-315" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb38-316"><a href="#cb38-316" aria-hidden="true" tabindex="-1"></a><span class="co">    Simple improved version with just higher contamination</span></span>
<span id="cb38-317"><a href="#cb38-317" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb38-318"><a href="#cb38-318" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> np.asarray(series, dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb38-319"><a href="#cb38-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-320"><a href="#cb38-320" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(x) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb38-321"><a href="#cb38-321" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> []</span>
<span id="cb38-322"><a href="#cb38-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-323"><a href="#cb38-323" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Simple approach with significantly higher contamination</span></span>
<span id="cb38-324"><a href="#cb38-324" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> sklearn.ensemble <span class="im">import</span> IsolationForest</span>
<span id="cb38-325"><a href="#cb38-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-326"><a href="#cb38-326" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use much higher contamination</span></span>
<span id="cb38-327"><a href="#cb38-327" aria-hidden="true" tabindex="-1"></a>    iso_forest <span class="op">=</span> IsolationForest(</span>
<span id="cb38-328"><a href="#cb38-328" aria-hidden="true" tabindex="-1"></a>        contamination<span class="op">=</span><span class="fl">0.2</span>,</span>
<span id="cb38-329"><a href="#cb38-329" aria-hidden="true" tabindex="-1"></a>        random_state<span class="op">=</span><span class="dv">42</span>,</span>
<span id="cb38-330"><a href="#cb38-330" aria-hidden="true" tabindex="-1"></a>        n_estimators<span class="op">=</span><span class="dv">100</span></span>
<span id="cb38-331"><a href="#cb38-331" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb38-332"><a href="#cb38-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-333"><a href="#cb38-333" aria-hidden="true" tabindex="-1"></a>    predictions <span class="op">=</span> iso_forest.fit_predict(x.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb38-334"><a href="#cb38-334" aria-hidden="true" tabindex="-1"></a>    anomaly_indices <span class="op">=</span> np.where(predictions <span class="op">==</span> <span class="op">-</span><span class="dv">1</span>)[<span class="dv">0</span>]</span>
<span id="cb38-335"><a href="#cb38-335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-336"><a href="#cb38-336" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Lenient range grouping with allowed gaps</span></span>
<span id="cb38-337"><a href="#cb38-337" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(anomaly_indices) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb38-338"><a href="#cb38-338" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> []</span>
<span id="cb38-339"><a href="#cb38-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-340"><a href="#cb38-340" aria-hidden="true" tabindex="-1"></a>    ranges <span class="op">=</span> []</span>
<span id="cb38-341"><a href="#cb38-341" aria-hidden="true" tabindex="-1"></a>    start <span class="op">=</span> anomaly_indices[<span class="dv">0</span>]</span>
<span id="cb38-342"><a href="#cb38-342" aria-hidden="true" tabindex="-1"></a>    end <span class="op">=</span> anomaly_indices[<span class="dv">0</span>]</span>
<span id="cb38-343"><a href="#cb38-343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-344"><a href="#cb38-344" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="bu">len</span>(anomaly_indices)):</span>
<span id="cb38-345"><a href="#cb38-345" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> anomaly_indices[i] <span class="op">&lt;=</span> anomaly_indices[i<span class="op">-</span><span class="dv">1</span>] <span class="op">+</span> <span class="dv">10</span>:</span>
<span id="cb38-346"><a href="#cb38-346" aria-hidden="true" tabindex="-1"></a>            end <span class="op">=</span> anomaly_indices[i]</span>
<span id="cb38-347"><a href="#cb38-347" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb38-348"><a href="#cb38-348" aria-hidden="true" tabindex="-1"></a>            ranges.append((start, end))</span>
<span id="cb38-349"><a href="#cb38-349" aria-hidden="true" tabindex="-1"></a>            start <span class="op">=</span> anomaly_indices[i]</span>
<span id="cb38-350"><a href="#cb38-350" aria-hidden="true" tabindex="-1"></a>            end <span class="op">=</span> anomaly_indices[i]</span>
<span id="cb38-351"><a href="#cb38-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-352"><a href="#cb38-352" aria-hidden="true" tabindex="-1"></a>    ranges.append((start, end))</span>
<span id="cb38-353"><a href="#cb38-353" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ranges</span>
<span id="cb38-354"><a href="#cb38-354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-355"><a href="#cb38-355" aria-hidden="true" tabindex="-1"></a><span class="co"># Keep the same evaluation function and main loop as before</span></span>
<span id="cb38-356"><a href="#cb38-356" aria-hidden="true" tabindex="-1"></a><span class="co"># Enhanced evaluation function with detailed range information</span></span>
<span id="cb38-357"><a href="#cb38-357" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> evaluate_anomaly_detection_formatted(true_ranges, predicted_ranges, tolerance<span class="op">=</span><span class="dv">5</span>, file_idx<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb38-358"><a href="#cb38-358" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb38-359"><a href="#cb38-359" aria-hidden="true" tabindex="-1"></a><span class="co">    Evaluate anomaly detection performance with exact formatting as requested</span></span>
<span id="cb38-360"><a href="#cb38-360" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb38-361"><a href="#cb38-361" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert point-level predictions</span></span>
<span id="cb38-362"><a href="#cb38-362" aria-hidden="true" tabindex="-1"></a>    series_length <span class="op">=</span> <span class="bu">max</span>(</span>
<span id="cb38-363"><a href="#cb38-363" aria-hidden="true" tabindex="-1"></a>        <span class="bu">max</span>([end <span class="cf">for</span> _, end <span class="kw">in</span> true_ranges]) <span class="cf">if</span> true_ranges <span class="cf">else</span> <span class="dv">0</span>,</span>
<span id="cb38-364"><a href="#cb38-364" aria-hidden="true" tabindex="-1"></a>        <span class="bu">max</span>([end <span class="cf">for</span> _, end <span class="kw">in</span> predicted_ranges]) <span class="cf">if</span> predicted_ranges <span class="cf">else</span> <span class="dv">0</span>,</span>
<span id="cb38-365"><a href="#cb38-365" aria-hidden="true" tabindex="-1"></a>        <span class="dv">0</span></span>
<span id="cb38-366"><a href="#cb38-366" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb38-367"><a href="#cb38-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-368"><a href="#cb38-368" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create point-level arrays</span></span>
<span id="cb38-369"><a href="#cb38-369" aria-hidden="true" tabindex="-1"></a>    true_point_labels <span class="op">=</span> np.zeros(series_length, dtype<span class="op">=</span><span class="bu">int</span>)</span>
<span id="cb38-370"><a href="#cb38-370" aria-hidden="true" tabindex="-1"></a>    pred_point_labels <span class="op">=</span> np.zeros(series_length, dtype<span class="op">=</span><span class="bu">int</span>)</span>
<span id="cb38-371"><a href="#cb38-371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-372"><a href="#cb38-372" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Mark true anomalies</span></span>
<span id="cb38-373"><a href="#cb38-373" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> start, end <span class="kw">in</span> true_ranges:</span>
<span id="cb38-374"><a href="#cb38-374" aria-hidden="true" tabindex="-1"></a>        true_point_labels[start:end<span class="op">+</span><span class="dv">1</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb38-375"><a href="#cb38-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-376"><a href="#cb38-376" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Mark predicted anomalies</span></span>
<span id="cb38-377"><a href="#cb38-377" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> start, end <span class="kw">in</span> predicted_ranges:</span>
<span id="cb38-378"><a href="#cb38-378" aria-hidden="true" tabindex="-1"></a>        pred_point_labels[start:end<span class="op">+</span><span class="dv">1</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb38-379"><a href="#cb38-379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-380"><a href="#cb38-380" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate point-level metrics</span></span>
<span id="cb38-381"><a href="#cb38-381" aria-hidden="true" tabindex="-1"></a>    true_positives <span class="op">=</span> np.<span class="bu">sum</span>((true_point_labels <span class="op">==</span> <span class="dv">1</span>) <span class="op">&amp;</span> (pred_point_labels <span class="op">==</span> <span class="dv">1</span>))</span>
<span id="cb38-382"><a href="#cb38-382" aria-hidden="true" tabindex="-1"></a>    false_positives <span class="op">=</span> np.<span class="bu">sum</span>((true_point_labels <span class="op">==</span> <span class="dv">0</span>) <span class="op">&amp;</span> (pred_point_labels <span class="op">==</span> <span class="dv">1</span>))</span>
<span id="cb38-383"><a href="#cb38-383" aria-hidden="true" tabindex="-1"></a>    false_negatives <span class="op">=</span> np.<span class="bu">sum</span>((true_point_labels <span class="op">==</span> <span class="dv">1</span>) <span class="op">&amp;</span> (pred_point_labels <span class="op">==</span> <span class="dv">0</span>))</span>
<span id="cb38-384"><a href="#cb38-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-385"><a href="#cb38-385" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Basic metrics</span></span>
<span id="cb38-386"><a href="#cb38-386" aria-hidden="true" tabindex="-1"></a>    accuracy <span class="op">=</span> (true_positives <span class="op">+</span> (series_length <span class="op">-</span> true_positives <span class="op">-</span> false_positives <span class="op">-</span> false_negatives)) <span class="op">/</span> series_length</span>
<span id="cb38-387"><a href="#cb38-387" aria-hidden="true" tabindex="-1"></a>    precision <span class="op">=</span> true_positives <span class="op">/</span> (true_positives <span class="op">+</span> false_positives) <span class="cf">if</span> (true_positives <span class="op">+</span> false_positives) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb38-388"><a href="#cb38-388" aria-hidden="true" tabindex="-1"></a>    recall <span class="op">=</span> true_positives <span class="op">/</span> (true_positives <span class="op">+</span> false_negatives) <span class="cf">if</span> (true_positives <span class="op">+</span> false_negatives) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb38-389"><a href="#cb38-389" aria-hidden="true" tabindex="-1"></a>    f1 <span class="op">=</span> <span class="dv">2</span> <span class="op">*</span> (precision <span class="op">*</span> recall) <span class="op">/</span> (precision <span class="op">+</span> recall) <span class="cf">if</span> (precision <span class="op">+</span> recall) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb38-390"><a href="#cb38-390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-391"><a href="#cb38-391" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Range-based metrics</span></span>
<span id="cb38-392"><a href="#cb38-392" aria-hidden="true" tabindex="-1"></a>    range_true_positives <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb38-393"><a href="#cb38-393" aria-hidden="true" tabindex="-1"></a>    range_false_positives <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb38-394"><a href="#cb38-394" aria-hidden="true" tabindex="-1"></a>    range_false_negatives <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb38-395"><a href="#cb38-395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-396"><a href="#cb38-396" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check each predicted range against true ranges</span></span>
<span id="cb38-397"><a href="#cb38-397" aria-hidden="true" tabindex="-1"></a>    matched_true_ranges <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb38-398"><a href="#cb38-398" aria-hidden="true" tabindex="-1"></a>    matched_pairs <span class="op">=</span> []</span>
<span id="cb38-399"><a href="#cb38-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-400"><a href="#cb38-400" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> pred_start, pred_end <span class="kw">in</span> predicted_ranges:</span>
<span id="cb38-401"><a href="#cb38-401" aria-hidden="true" tabindex="-1"></a>        matched <span class="op">=</span> <span class="va">False</span></span>
<span id="cb38-402"><a href="#cb38-402" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i, (true_start, true_end) <span class="kw">in</span> <span class="bu">enumerate</span>(true_ranges):</span>
<span id="cb38-403"><a href="#cb38-403" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Check if predicted range overlaps with true range within tolerance</span></span>
<span id="cb38-404"><a href="#cb38-404" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (pred_start <span class="op">&lt;=</span> true_end <span class="op">+</span> tolerance <span class="kw">and</span> pred_end <span class="op">&gt;=</span> true_start <span class="op">-</span> tolerance):</span>
<span id="cb38-405"><a href="#cb38-405" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> i <span class="kw">not</span> <span class="kw">in</span> matched_true_ranges:</span>
<span id="cb38-406"><a href="#cb38-406" aria-hidden="true" tabindex="-1"></a>                    range_true_positives <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb38-407"><a href="#cb38-407" aria-hidden="true" tabindex="-1"></a>                    matched_true_ranges.add(i)</span>
<span id="cb38-408"><a href="#cb38-408" aria-hidden="true" tabindex="-1"></a>                    matched_pairs.append((i, (pred_start, pred_end), (true_start, true_end)))</span>
<span id="cb38-409"><a href="#cb38-409" aria-hidden="true" tabindex="-1"></a>                    matched <span class="op">=</span> <span class="va">True</span></span>
<span id="cb38-410"><a href="#cb38-410" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">break</span></span>
<span id="cb38-411"><a href="#cb38-411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-412"><a href="#cb38-412" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> matched:</span>
<span id="cb38-413"><a href="#cb38-413" aria-hidden="true" tabindex="-1"></a>            range_false_positives <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb38-414"><a href="#cb38-414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-415"><a href="#cb38-415" aria-hidden="true" tabindex="-1"></a>    range_false_negatives <span class="op">=</span> <span class="bu">len</span>(true_ranges) <span class="op">-</span> <span class="bu">len</span>(matched_true_ranges)</span>
<span id="cb38-416"><a href="#cb38-416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-417"><a href="#cb38-417" aria-hidden="true" tabindex="-1"></a>    range_precision <span class="op">=</span> range_true_positives <span class="op">/</span> (range_true_positives <span class="op">+</span> range_false_positives) <span class="cf">if</span> (range_true_positives <span class="op">+</span> range_false_positives) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb38-418"><a href="#cb38-418" aria-hidden="true" tabindex="-1"></a>    range_recall <span class="op">=</span> range_true_positives <span class="op">/</span> <span class="bu">len</span>(true_ranges) <span class="cf">if</span> <span class="bu">len</span>(true_ranges) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb38-419"><a href="#cb38-419" aria-hidden="true" tabindex="-1"></a>    range_f1 <span class="op">=</span> <span class="dv">2</span> <span class="op">*</span> (range_precision <span class="op">*</span> range_recall) <span class="op">/</span> (range_precision <span class="op">+</span> range_recall) <span class="cf">if</span> (range_precision <span class="op">+</span> range_recall) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb38-420"><a href="#cb38-420" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-421"><a href="#cb38-421" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Segment detection metrics</span></span>
<span id="cb38-422"><a href="#cb38-422" aria-hidden="true" tabindex="-1"></a>    fully_detected <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb38-423"><a href="#cb38-423" aria-hidden="true" tabindex="-1"></a>    partially_detected <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb38-424"><a href="#cb38-424" aria-hidden="true" tabindex="-1"></a>    missed <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb38-425"><a href="#cb38-425" aria-hidden="true" tabindex="-1"></a>    detection_details <span class="op">=</span> []</span>
<span id="cb38-426"><a href="#cb38-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-427"><a href="#cb38-427" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, (true_start, true_end) <span class="kw">in</span> <span class="bu">enumerate</span>(true_ranges):</span>
<span id="cb38-428"><a href="#cb38-428" aria-hidden="true" tabindex="-1"></a>        detected_points <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb38-429"><a href="#cb38-429" aria-hidden="true" tabindex="-1"></a>        overlapping_ranges <span class="op">=</span> []</span>
<span id="cb38-430"><a href="#cb38-430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-431"><a href="#cb38-431" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> pred_start, pred_end <span class="kw">in</span> predicted_ranges:</span>
<span id="cb38-432"><a href="#cb38-432" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Calculate overlap</span></span>
<span id="cb38-433"><a href="#cb38-433" aria-hidden="true" tabindex="-1"></a>            overlap_start <span class="op">=</span> <span class="bu">max</span>(true_start, pred_start)</span>
<span id="cb38-434"><a href="#cb38-434" aria-hidden="true" tabindex="-1"></a>            overlap_end <span class="op">=</span> <span class="bu">min</span>(true_end, pred_end)</span>
<span id="cb38-435"><a href="#cb38-435" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> overlap_start <span class="op">&lt;=</span> overlap_end:</span>
<span id="cb38-436"><a href="#cb38-436" aria-hidden="true" tabindex="-1"></a>                overlap_points <span class="op">=</span> overlap_end <span class="op">-</span> overlap_start <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb38-437"><a href="#cb38-437" aria-hidden="true" tabindex="-1"></a>                detected_points <span class="op">+=</span> overlap_points</span>
<span id="cb38-438"><a href="#cb38-438" aria-hidden="true" tabindex="-1"></a>                overlapping_ranges.append((pred_start, pred_end, overlap_points))</span>
<span id="cb38-439"><a href="#cb38-439" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-440"><a href="#cb38-440" aria-hidden="true" tabindex="-1"></a>        total_points <span class="op">=</span> true_end <span class="op">-</span> true_start <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb38-441"><a href="#cb38-441" aria-hidden="true" tabindex="-1"></a>        detection_ratio <span class="op">=</span> detected_points <span class="op">/</span> total_points <span class="cf">if</span> total_points <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb38-442"><a href="#cb38-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-443"><a href="#cb38-443" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> detection_ratio <span class="op">&gt;=</span> <span class="fl">0.8</span>:  <span class="co"># 80% threshold for full detection</span></span>
<span id="cb38-444"><a href="#cb38-444" aria-hidden="true" tabindex="-1"></a>            fully_detected <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb38-445"><a href="#cb38-445" aria-hidden="true" tabindex="-1"></a>            detection_status <span class="op">=</span> <span class="st">"FULL"</span></span>
<span id="cb38-446"><a href="#cb38-446" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> detection_ratio <span class="op">&gt;</span> <span class="dv">0</span>:   <span class="co"># Any detection counts as partial</span></span>
<span id="cb38-447"><a href="#cb38-447" aria-hidden="true" tabindex="-1"></a>            partially_detected <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb38-448"><a href="#cb38-448" aria-hidden="true" tabindex="-1"></a>            detection_status <span class="op">=</span> <span class="st">"PARTIAL"</span></span>
<span id="cb38-449"><a href="#cb38-449" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb38-450"><a href="#cb38-450" aria-hidden="true" tabindex="-1"></a>            missed <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb38-451"><a href="#cb38-451" aria-hidden="true" tabindex="-1"></a>            detection_status <span class="op">=</span> <span class="st">"MISSED"</span></span>
<span id="cb38-452"><a href="#cb38-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-453"><a href="#cb38-453" aria-hidden="true" tabindex="-1"></a>        detection_details.append({</span>
<span id="cb38-454"><a href="#cb38-454" aria-hidden="true" tabindex="-1"></a>            <span class="st">'true_range'</span>: (true_start, true_end),</span>
<span id="cb38-455"><a href="#cb38-455" aria-hidden="true" tabindex="-1"></a>            <span class="st">'detection_ratio'</span>: detection_ratio,</span>
<span id="cb38-456"><a href="#cb38-456" aria-hidden="true" tabindex="-1"></a>            <span class="st">'status'</span>: detection_status,</span>
<span id="cb38-457"><a href="#cb38-457" aria-hidden="true" tabindex="-1"></a>            <span class="st">'overlapping_ranges'</span>: overlapping_ranges,</span>
<span id="cb38-458"><a href="#cb38-458" aria-hidden="true" tabindex="-1"></a>            <span class="st">'detected_points'</span>: detected_points,</span>
<span id="cb38-459"><a href="#cb38-459" aria-hidden="true" tabindex="-1"></a>            <span class="st">'total_points'</span>: total_points</span>
<span id="cb38-460"><a href="#cb38-460" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb38-461"><a href="#cb38-461" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-462"><a href="#cb38-462" aria-hidden="true" tabindex="-1"></a>    segment_detection_rate <span class="op">=</span> fully_detected <span class="op">/</span> <span class="bu">len</span>(true_ranges) <span class="cf">if</span> <span class="bu">len</span>(true_ranges) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb38-463"><a href="#cb38-463" aria-hidden="true" tabindex="-1"></a>    overall_detection_rate <span class="op">=</span> (fully_detected <span class="op">+</span> partially_detected) <span class="op">/</span> <span class="bu">len</span>(true_ranges) <span class="cf">if</span> <span class="bu">len</span>(true_ranges) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb38-464"><a href="#cb38-464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-465"><a href="#cb38-465" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Print results in the exact format requested</span></span>
<span id="cb38-466"><a href="#cb38-466" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"EVALUATION RESULTS - FILE </span><span class="sc">{</span>file_idx<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-467"><a href="#cb38-467" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">60</span>)</span>
<span id="cb38-468"><a href="#cb38-468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-469"><a href="#cb38-469" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Display range information</span></span>
<span id="cb38-470"><a href="#cb38-470" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Range Information:"</span>)</span>
<span id="cb38-471"><a href="#cb38-471" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  True Ranges: </span><span class="sc">{</span>true_ranges<span class="sc">}</span><span class="ss"> (count: </span><span class="sc">{</span><span class="bu">len</span>(true_ranges)<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb38-472"><a href="#cb38-472" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Predicted Ranges: </span><span class="sc">{</span>predicted_ranges<span class="sc">}</span><span class="ss"> (count: </span><span class="sc">{</span><span class="bu">len</span>(predicted_ranges)<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb38-473"><a href="#cb38-473" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>()</span>
<span id="cb38-474"><a href="#cb38-474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-475"><a href="#cb38-475" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Display detection details for each true range</span></span>
<span id="cb38-476"><a href="#cb38-476" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> detection_details:</span>
<span id="cb38-477"><a href="#cb38-477" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Detection Details by Segment:"</span>)</span>
<span id="cb38-478"><a href="#cb38-478" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i, detail <span class="kw">in</span> <span class="bu">enumerate</span>(detection_details):</span>
<span id="cb38-479"><a href="#cb38-479" aria-hidden="true" tabindex="-1"></a>            status_symbol <span class="op">=</span> <span class="st">"‚úì"</span> <span class="cf">if</span> detail[<span class="st">'status'</span>] <span class="op">==</span> <span class="st">"FULL"</span> <span class="cf">else</span> <span class="st">"~"</span> <span class="cf">if</span> detail[<span class="st">'status'</span>] <span class="op">==</span> <span class="st">"PARTIAL"</span> <span class="cf">else</span> <span class="st">"‚úó"</span></span>
<span id="cb38-480"><a href="#cb38-480" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  Segment </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>detail[<span class="st">'true_range'</span>]<span class="sc">}</span><span class="ss"> </span><span class="sc">{</span>status_symbol<span class="sc">}</span><span class="ss"> </span><span class="sc">{</span>detail[<span class="st">'status'</span>]<span class="sc">}</span><span class="ss"> "</span></span>
<span id="cb38-481"><a href="#cb38-481" aria-hidden="true" tabindex="-1"></a>                  <span class="ss">f"(</span><span class="sc">{</span>detail[<span class="st">'detected_points'</span>]<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>detail[<span class="st">'total_points'</span>]<span class="sc">}</span><span class="ss"> points, "</span></span>
<span id="cb38-482"><a href="#cb38-482" aria-hidden="true" tabindex="-1"></a>                  <span class="ss">f"</span><span class="sc">{</span>detail[<span class="st">'detection_ratio'</span>]<span class="sc">:.1%}</span><span class="ss">)"</span>)</span>
<span id="cb38-483"><a href="#cb38-483" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> detail[<span class="st">'overlapping_ranges'</span>]:</span>
<span id="cb38-484"><a href="#cb38-484" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> pred_range <span class="kw">in</span> detail[<span class="st">'overlapping_ranges'</span>]:</span>
<span id="cb38-485"><a href="#cb38-485" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">print</span>(<span class="ss">f"    ‚Üí Overlap with predicted range </span><span class="sc">{</span>pred_range[<span class="dv">0</span>:<span class="dv">2</span>]<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>pred_range[<span class="dv">2</span>]<span class="sc">}</span><span class="ss"> points"</span>)</span>
<span id="cb38-486"><a href="#cb38-486" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>()</span>
<span id="cb38-487"><a href="#cb38-487" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-488"><a href="#cb38-488" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Basic Metrics:"</span>)</span>
<span id="cb38-489"><a href="#cb38-489" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Accuracy:  </span><span class="sc">{</span>accuracy<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb38-490"><a href="#cb38-490" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Precision: </span><span class="sc">{</span>precision<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb38-491"><a href="#cb38-491" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Recall:    </span><span class="sc">{</span>recall<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb38-492"><a href="#cb38-492" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  F1-Score:  </span><span class="sc">{</span>f1<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb38-493"><a href="#cb38-493" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>()</span>
<span id="cb38-494"><a href="#cb38-494" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Anomaly Statistics:"</span>)</span>
<span id="cb38-495"><a href="#cb38-495" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  True Anomalies: </span><span class="sc">{</span>np<span class="sc">.</span><span class="bu">sum</span>(true_point_labels)<span class="sc">}</span><span class="ss"> points"</span>)</span>
<span id="cb38-496"><a href="#cb38-496" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Predicted Anomalies: </span><span class="sc">{</span>np<span class="sc">.</span><span class="bu">sum</span>(pred_point_labels)<span class="sc">}</span><span class="ss"> points"</span>)</span>
<span id="cb38-497"><a href="#cb38-497" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Detection Rate: </span><span class="sc">{</span>recall<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb38-498"><a href="#cb38-498" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>()</span>
<span id="cb38-499"><a href="#cb38-499" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Range-based Metrics:"</span>)</span>
<span id="cb38-500"><a href="#cb38-500" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Range Precision: </span><span class="sc">{</span>range_precision<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb38-501"><a href="#cb38-501" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Range Recall:    </span><span class="sc">{</span>range_recall<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb38-502"><a href="#cb38-502" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Range F1:        </span><span class="sc">{</span>range_f1<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb38-503"><a href="#cb38-503" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>()</span>
<span id="cb38-504"><a href="#cb38-504" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Point-level Performance:"</span>)</span>
<span id="cb38-505"><a href="#cb38-505" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  True Positives:  </span><span class="sc">{</span>true_positives<span class="sc">}</span><span class="ss"> points"</span>)</span>
<span id="cb38-506"><a href="#cb38-506" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  False Positives: </span><span class="sc">{</span>false_positives<span class="sc">}</span><span class="ss"> points"</span>)</span>
<span id="cb38-507"><a href="#cb38-507" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  False Negatives: </span><span class="sc">{</span>false_negatives<span class="sc">}</span><span class="ss"> points"</span>)</span>
<span id="cb38-508"><a href="#cb38-508" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>()</span>
<span id="cb38-509"><a href="#cb38-509" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Segment Detection Metrics:"</span>)</span>
<span id="cb38-510"><a href="#cb38-510" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Total Anomaly Segments: </span><span class="sc">{</span><span class="bu">len</span>(true_ranges)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-511"><a href="#cb38-511" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Fully Detected: </span><span class="sc">{</span>fully_detected<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-512"><a href="#cb38-512" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Partially Detected: </span><span class="sc">{</span>partially_detected<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-513"><a href="#cb38-513" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Missed: </span><span class="sc">{</span>missed<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-514"><a href="#cb38-514" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Segment Detection Rate: </span><span class="sc">{</span>segment_detection_rate<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb38-515"><a href="#cb38-515" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Overall Detection Rate: </span><span class="sc">{</span>overall_detection_rate<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb38-516"><a href="#cb38-516" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>()</span>
<span id="cb38-517"><a href="#cb38-517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-518"><a href="#cb38-518" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb38-519"><a href="#cb38-519" aria-hidden="true" tabindex="-1"></a>        <span class="st">'accuracy'</span>: accuracy,</span>
<span id="cb38-520"><a href="#cb38-520" aria-hidden="true" tabindex="-1"></a>        <span class="st">'precision'</span>: precision,</span>
<span id="cb38-521"><a href="#cb38-521" aria-hidden="true" tabindex="-1"></a>        <span class="st">'recall'</span>: recall,</span>
<span id="cb38-522"><a href="#cb38-522" aria-hidden="true" tabindex="-1"></a>        <span class="st">'f1_score'</span>: f1,</span>
<span id="cb38-523"><a href="#cb38-523" aria-hidden="true" tabindex="-1"></a>        <span class="st">'true_positives'</span>: true_positives,</span>
<span id="cb38-524"><a href="#cb38-524" aria-hidden="true" tabindex="-1"></a>        <span class="st">'false_positives'</span>: false_positives,</span>
<span id="cb38-525"><a href="#cb38-525" aria-hidden="true" tabindex="-1"></a>        <span class="st">'false_negatives'</span>: false_negatives,</span>
<span id="cb38-526"><a href="#cb38-526" aria-hidden="true" tabindex="-1"></a>        <span class="st">'range_precision'</span>: range_precision,</span>
<span id="cb38-527"><a href="#cb38-527" aria-hidden="true" tabindex="-1"></a>        <span class="st">'range_recall'</span>: range_recall,</span>
<span id="cb38-528"><a href="#cb38-528" aria-hidden="true" tabindex="-1"></a>        <span class="st">'range_f1'</span>: range_f1,</span>
<span id="cb38-529"><a href="#cb38-529" aria-hidden="true" tabindex="-1"></a>        <span class="st">'fully_detected'</span>: fully_detected,</span>
<span id="cb38-530"><a href="#cb38-530" aria-hidden="true" tabindex="-1"></a>        <span class="st">'partially_detected'</span>: partially_detected,</span>
<span id="cb38-531"><a href="#cb38-531" aria-hidden="true" tabindex="-1"></a>        <span class="st">'missed'</span>: missed,</span>
<span id="cb38-532"><a href="#cb38-532" aria-hidden="true" tabindex="-1"></a>        <span class="st">'segment_detection_rate'</span>: segment_detection_rate,</span>
<span id="cb38-533"><a href="#cb38-533" aria-hidden="true" tabindex="-1"></a>        <span class="st">'overall_detection_rate'</span>: overall_detection_rate,</span>
<span id="cb38-534"><a href="#cb38-534" aria-hidden="true" tabindex="-1"></a>        <span class="st">'true_ranges'</span>: true_ranges,</span>
<span id="cb38-535"><a href="#cb38-535" aria-hidden="true" tabindex="-1"></a>        <span class="st">'predicted_ranges'</span>: predicted_ranges,</span>
<span id="cb38-536"><a href="#cb38-536" aria-hidden="true" tabindex="-1"></a>        <span class="st">'detection_details'</span>: detection_details,</span>
<span id="cb38-537"><a href="#cb38-537" aria-hidden="true" tabindex="-1"></a>        <span class="st">'matched_pairs'</span>: matched_pairs</span>
<span id="cb38-538"><a href="#cb38-538" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb38-539"><a href="#cb38-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-540"><a href="#cb38-540" aria-hidden="true" tabindex="-1"></a><span class="co"># Updated main evaluation loop with high-precision settings (Z-score threshold = 3.0)</span></span>
<span id="cb38-541"><a href="#cb38-541" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Starting HIGH-PRECISION Anomaly Detection Evaluation"</span>)</span>
<span id="cb38-542"><a href="#cb38-542" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Key improvements for higher precision:"</span>)</span>
<span id="cb38-543"><a href="#cb38-543" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"- Contamination range: 0.05-0.2 (reduced from 0.1-0.4)"</span>)</span>
<span id="cb38-544"><a href="#cb38-544" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"- Z-score threshold: 3.0 (maintained)"</span>)</span>
<span id="cb38-545"><a href="#cb38-545" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"- Stricter range grouping (max_gap=5, min_length=3)"</span>)</span>
<span id="cb38-546"><a href="#cb38-546" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"- Anti-overfitting measures (more trees, smaller samples)"</span>)</span>
<span id="cb38-547"><a href="#cb38-547" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"- More selective range merging and combination"</span>)</span>
<span id="cb38-548"><a href="#cb38-548" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">80</span>)</span>
<span id="cb38-549"><a href="#cb38-549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-550"><a href="#cb38-550" aria-hidden="true" tabindex="-1"></a>total_files <span class="op">=</span> <span class="bu">len</span>(test_files)</span>
<span id="cb38-551"><a href="#cb38-551" aria-hidden="true" tabindex="-1"></a>all_metrics <span class="op">=</span> []</span>
<span id="cb38-552"><a href="#cb38-552" aria-hidden="true" tabindex="-1"></a>detailed_results <span class="op">=</span> []</span>
<span id="cb38-553"><a href="#cb38-553" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-554"><a href="#cb38-554" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx, test_df <span class="kw">in</span> <span class="bu">enumerate</span>(test_files):</span>
<span id="cb38-555"><a href="#cb38-555" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">80</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-556"><a href="#cb38-556" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-557"><a href="#cb38-557" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb38-558"><a href="#cb38-558" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract series and labels</span></span>
<span id="cb38-559"><a href="#cb38-559" aria-hidden="true" tabindex="-1"></a>        series <span class="op">=</span> test_df[<span class="st">'Value'</span>].values <span class="cf">if</span> <span class="st">'Value'</span> <span class="kw">in</span> test_df.columns <span class="cf">else</span> test_df.iloc[:, <span class="dv">0</span>].values</span>
<span id="cb38-560"><a href="#cb38-560" aria-hidden="true" tabindex="-1"></a>        labels <span class="op">=</span> test_df[<span class="st">'Labels'</span>].values <span class="cf">if</span> <span class="st">'Labels'</span> <span class="kw">in</span> test_df.columns <span class="cf">else</span> test_df.iloc[:, <span class="dv">1</span>].values</span>
<span id="cb38-561"><a href="#cb38-561" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-562"><a href="#cb38-562" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get true anomaly ranges</span></span>
<span id="cb38-563"><a href="#cb38-563" aria-hidden="true" tabindex="-1"></a>        true_ranges <span class="op">=</span> extract_true_anomaly_ranges(labels)</span>
<span id="cb38-564"><a href="#cb38-564" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-565"><a href="#cb38-565" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Detect anomalies using HIGH-PRECISION student's function</span></span>
<span id="cb38-566"><a href="#cb38-566" aria-hidden="true" tabindex="-1"></a>        predicted_ranges <span class="op">=</span> student_detect_anomalies(series)</span>
<span id="cb38-567"><a href="#cb38-567" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-568"><a href="#cb38-568" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Evaluate with formatted output</span></span>
<span id="cb38-569"><a href="#cb38-569" aria-hidden="true" tabindex="-1"></a>        metrics <span class="op">=</span> evaluate_anomaly_detection_formatted(true_ranges, predicted_ranges, file_idx<span class="op">=</span>idx)</span>
<span id="cb38-570"><a href="#cb38-570" aria-hidden="true" tabindex="-1"></a>        all_metrics.append(metrics)</span>
<span id="cb38-571"><a href="#cb38-571" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-572"><a href="#cb38-572" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Store detailed results</span></span>
<span id="cb38-573"><a href="#cb38-573" aria-hidden="true" tabindex="-1"></a>        detailed_results.append({</span>
<span id="cb38-574"><a href="#cb38-574" aria-hidden="true" tabindex="-1"></a>            <span class="st">'file_idx'</span>: idx,</span>
<span id="cb38-575"><a href="#cb38-575" aria-hidden="true" tabindex="-1"></a>            <span class="st">'true_ranges'</span>: true_ranges,</span>
<span id="cb38-576"><a href="#cb38-576" aria-hidden="true" tabindex="-1"></a>            <span class="st">'predicted_ranges'</span>: predicted_ranges,</span>
<span id="cb38-577"><a href="#cb38-577" aria-hidden="true" tabindex="-1"></a>            <span class="st">'metrics'</span>: metrics</span>
<span id="cb38-578"><a href="#cb38-578" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb38-579"><a href="#cb38-579" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-580"><a href="#cb38-580" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb38-581"><a href="#cb38-581" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Error processing file </span><span class="sc">{</span>idx<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-582"><a href="#cb38-582" aria-hidden="true" tabindex="-1"></a>        <span class="im">import</span> traceback</span>
<span id="cb38-583"><a href="#cb38-583" aria-hidden="true" tabindex="-1"></a>        traceback.print_exc()</span>
<span id="cb38-584"><a href="#cb38-584" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add zero metrics for failed files</span></span>
<span id="cb38-585"><a href="#cb38-585" aria-hidden="true" tabindex="-1"></a>        all_metrics.append({</span>
<span id="cb38-586"><a href="#cb38-586" aria-hidden="true" tabindex="-1"></a>            <span class="st">'accuracy'</span>: <span class="dv">0</span>,</span>
<span id="cb38-587"><a href="#cb38-587" aria-hidden="true" tabindex="-1"></a>            <span class="st">'precision'</span>: <span class="dv">0</span>,</span>
<span id="cb38-588"><a href="#cb38-588" aria-hidden="true" tabindex="-1"></a>            <span class="st">'recall'</span>: <span class="dv">0</span>,</span>
<span id="cb38-589"><a href="#cb38-589" aria-hidden="true" tabindex="-1"></a>            <span class="st">'f1_score'</span>: <span class="dv">0</span>,</span>
<span id="cb38-590"><a href="#cb38-590" aria-hidden="true" tabindex="-1"></a>            <span class="st">'true_positives'</span>: <span class="dv">0</span>,</span>
<span id="cb38-591"><a href="#cb38-591" aria-hidden="true" tabindex="-1"></a>            <span class="st">'false_positives'</span>: <span class="dv">0</span>,</span>
<span id="cb38-592"><a href="#cb38-592" aria-hidden="true" tabindex="-1"></a>            <span class="st">'false_negatives'</span>: <span class="dv">0</span>,</span>
<span id="cb38-593"><a href="#cb38-593" aria-hidden="true" tabindex="-1"></a>            <span class="st">'range_precision'</span>: <span class="dv">0</span>,</span>
<span id="cb38-594"><a href="#cb38-594" aria-hidden="true" tabindex="-1"></a>            <span class="st">'range_recall'</span>: <span class="dv">0</span>,</span>
<span id="cb38-595"><a href="#cb38-595" aria-hidden="true" tabindex="-1"></a>            <span class="st">'range_f1'</span>: <span class="dv">0</span>,</span>
<span id="cb38-596"><a href="#cb38-596" aria-hidden="true" tabindex="-1"></a>            <span class="st">'fully_detected'</span>: <span class="dv">0</span>,</span>
<span id="cb38-597"><a href="#cb38-597" aria-hidden="true" tabindex="-1"></a>            <span class="st">'partially_detected'</span>: <span class="dv">0</span>,</span>
<span id="cb38-598"><a href="#cb38-598" aria-hidden="true" tabindex="-1"></a>            <span class="st">'missed'</span>: <span class="dv">0</span>,</span>
<span id="cb38-599"><a href="#cb38-599" aria-hidden="true" tabindex="-1"></a>            <span class="st">'segment_detection_rate'</span>: <span class="dv">0</span>,</span>
<span id="cb38-600"><a href="#cb38-600" aria-hidden="true" tabindex="-1"></a>            <span class="st">'overall_detection_rate'</span>: <span class="dv">0</span>,</span>
<span id="cb38-601"><a href="#cb38-601" aria-hidden="true" tabindex="-1"></a>            <span class="st">'true_ranges'</span>: [],</span>
<span id="cb38-602"><a href="#cb38-602" aria-hidden="true" tabindex="-1"></a>            <span class="st">'predicted_ranges'</span>: [],</span>
<span id="cb38-603"><a href="#cb38-603" aria-hidden="true" tabindex="-1"></a>            <span class="st">'detection_details'</span>: [],</span>
<span id="cb38-604"><a href="#cb38-604" aria-hidden="true" tabindex="-1"></a>            <span class="st">'matched_pairs'</span>: []</span>
<span id="cb38-605"><a href="#cb38-605" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb38-606"><a href="#cb38-606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-607"><a href="#cb38-607" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate overall summary statistics</span></span>
<span id="cb38-608"><a href="#cb38-608" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span> <span class="op">*</span> <span class="dv">80</span>)</span>
<span id="cb38-609"><a href="#cb38-609" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"OVERALL SUMMARY ACROSS ALL FILES - HIGH-PRECISION VERSION"</span>)</span>
<span id="cb38-610"><a href="#cb38-610" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">80</span>)</span>
<span id="cb38-611"><a href="#cb38-611" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-612"><a href="#cb38-612" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate basic metrics</span></span>
<span id="cb38-613"><a href="#cb38-613" aria-hidden="true" tabindex="-1"></a>overall_accuracy <span class="op">=</span> np.mean([m[<span class="st">'accuracy'</span>] <span class="cf">for</span> m <span class="kw">in</span> all_metrics])</span>
<span id="cb38-614"><a href="#cb38-614" aria-hidden="true" tabindex="-1"></a>overall_precision <span class="op">=</span> np.mean([m[<span class="st">'precision'</span>] <span class="cf">for</span> m <span class="kw">in</span> all_metrics])</span>
<span id="cb38-615"><a href="#cb38-615" aria-hidden="true" tabindex="-1"></a>overall_recall <span class="op">=</span> np.mean([m[<span class="st">'recall'</span>] <span class="cf">for</span> m <span class="kw">in</span> all_metrics])</span>
<span id="cb38-616"><a href="#cb38-616" aria-hidden="true" tabindex="-1"></a>overall_f1 <span class="op">=</span> np.mean([m[<span class="st">'f1_score'</span>] <span class="cf">for</span> m <span class="kw">in</span> all_metrics])</span>
<span id="cb38-617"><a href="#cb38-617" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-618"><a href="#cb38-618" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate range statistics</span></span>
<span id="cb38-619"><a href="#cb38-619" aria-hidden="true" tabindex="-1"></a>total_true_ranges <span class="op">=</span> <span class="bu">sum</span>([<span class="bu">len</span>(m[<span class="st">'true_ranges'</span>]) <span class="cf">for</span> m <span class="kw">in</span> all_metrics])</span>
<span id="cb38-620"><a href="#cb38-620" aria-hidden="true" tabindex="-1"></a>total_predicted_ranges <span class="op">=</span> <span class="bu">sum</span>([<span class="bu">len</span>(m[<span class="st">'predicted_ranges'</span>]) <span class="cf">for</span> m <span class="kw">in</span> all_metrics])</span>
<span id="cb38-621"><a href="#cb38-621" aria-hidden="true" tabindex="-1"></a>total_matched_ranges <span class="op">=</span> <span class="bu">sum</span>([<span class="bu">len</span>(m[<span class="st">'matched_pairs'</span>]) <span class="cf">for</span> m <span class="kw">in</span> all_metrics])</span>
<span id="cb38-622"><a href="#cb38-622" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-623"><a href="#cb38-623" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate other metrics</span></span>
<span id="cb38-624"><a href="#cb38-624" aria-hidden="true" tabindex="-1"></a>overall_range_precision <span class="op">=</span> np.mean([m[<span class="st">'range_precision'</span>] <span class="cf">for</span> m <span class="kw">in</span> all_metrics])</span>
<span id="cb38-625"><a href="#cb38-625" aria-hidden="true" tabindex="-1"></a>overall_range_recall <span class="op">=</span> np.mean([m[<span class="st">'range_recall'</span>] <span class="cf">for</span> m <span class="kw">in</span> all_metrics])</span>
<span id="cb38-626"><a href="#cb38-626" aria-hidden="true" tabindex="-1"></a>overall_range_f1 <span class="op">=</span> np.mean([m[<span class="st">'range_f1'</span>] <span class="cf">for</span> m <span class="kw">in</span> all_metrics])</span>
<span id="cb38-627"><a href="#cb38-627" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-628"><a href="#cb38-628" aria-hidden="true" tabindex="-1"></a>total_true_positives <span class="op">=</span> <span class="bu">sum</span>([m[<span class="st">'true_positives'</span>] <span class="cf">for</span> m <span class="kw">in</span> all_metrics])</span>
<span id="cb38-629"><a href="#cb38-629" aria-hidden="true" tabindex="-1"></a>total_false_positives <span class="op">=</span> <span class="bu">sum</span>([m[<span class="st">'false_positives'</span>] <span class="cf">for</span> m <span class="kw">in</span> all_metrics])</span>
<span id="cb38-630"><a href="#cb38-630" aria-hidden="true" tabindex="-1"></a>total_false_negatives <span class="op">=</span> <span class="bu">sum</span>([m[<span class="st">'false_negatives'</span>] <span class="cf">for</span> m <span class="kw">in</span> all_metrics])</span>
<span id="cb38-631"><a href="#cb38-631" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-632"><a href="#cb38-632" aria-hidden="true" tabindex="-1"></a>total_fully_detected <span class="op">=</span> <span class="bu">sum</span>([m[<span class="st">'fully_detected'</span>] <span class="cf">for</span> m <span class="kw">in</span> all_metrics])</span>
<span id="cb38-633"><a href="#cb38-633" aria-hidden="true" tabindex="-1"></a>total_partially_detected <span class="op">=</span> <span class="bu">sum</span>([m[<span class="st">'partially_detected'</span>] <span class="cf">for</span> m <span class="kw">in</span> all_metrics])</span>
<span id="cb38-634"><a href="#cb38-634" aria-hidden="true" tabindex="-1"></a>total_missed <span class="op">=</span> <span class="bu">sum</span>([m[<span class="st">'missed'</span>] <span class="cf">for</span> m <span class="kw">in</span> all_metrics])</span>
<span id="cb38-635"><a href="#cb38-635" aria-hidden="true" tabindex="-1"></a>total_segments <span class="op">=</span> total_fully_detected <span class="op">+</span> total_partially_detected <span class="op">+</span> total_missed</span>
<span id="cb38-636"><a href="#cb38-636" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-637"><a href="#cb38-637" aria-hidden="true" tabindex="-1"></a>overall_segment_detection_rate <span class="op">=</span> total_fully_detected <span class="op">/</span> total_segments <span class="cf">if</span> total_segments <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb38-638"><a href="#cb38-638" aria-hidden="true" tabindex="-1"></a>overall_detection_rate <span class="op">=</span> (total_fully_detected <span class="op">+</span> total_partially_detected) <span class="op">/</span> total_segments <span class="cf">if</span> total_segments <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb38-639"><a href="#cb38-639" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-640"><a href="#cb38-640" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Overall Basic Metrics:"</span>)</span>
<span id="cb38-641"><a href="#cb38-641" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Accuracy:  </span><span class="sc">{</span>overall_accuracy<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb38-642"><a href="#cb38-642" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Precision: </span><span class="sc">{</span>overall_precision<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb38-643"><a href="#cb38-643" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Recall:    </span><span class="sc">{</span>overall_recall<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb38-644"><a href="#cb38-644" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  F1-Score:  </span><span class="sc">{</span>overall_f1<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb38-645"><a href="#cb38-645" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>()</span>
<span id="cb38-646"><a href="#cb38-646" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Overall Range Statistics:"</span>)</span>
<span id="cb38-647"><a href="#cb38-647" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Total True Ranges: </span><span class="sc">{</span>total_true_ranges<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-648"><a href="#cb38-648" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Total Predicted Ranges: </span><span class="sc">{</span>total_predicted_ranges<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-649"><a href="#cb38-649" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Total Matched Ranges: </span><span class="sc">{</span>total_matched_ranges<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-650"><a href="#cb38-650" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Range Match Rate: </span><span class="sc">{</span>total_matched_ranges<span class="op">/</span>total_true_ranges<span class="sc">:.4f}</span><span class="ss">"</span> <span class="cf">if</span> total_true_ranges <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="st">"  Range Match Rate: 0.0000"</span>)</span>
<span id="cb38-651"><a href="#cb38-651" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>()</span>
<span id="cb38-652"><a href="#cb38-652" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Overall Range-based Metrics:"</span>)</span>
<span id="cb38-653"><a href="#cb38-653" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Range Precision: </span><span class="sc">{</span>overall_range_precision<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb38-654"><a href="#cb38-654" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Range Recall:    </span><span class="sc">{</span>overall_range_recall<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb38-655"><a href="#cb38-655" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Range F1:        </span><span class="sc">{</span>overall_range_f1<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb38-656"><a href="#cb38-656" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>()</span>
<span id="cb38-657"><a href="#cb38-657" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Overall Point-level Performance:"</span>)</span>
<span id="cb38-658"><a href="#cb38-658" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  True Positives:  </span><span class="sc">{</span>total_true_positives<span class="sc">}</span><span class="ss"> points"</span>)</span>
<span id="cb38-659"><a href="#cb38-659" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  False Positives: </span><span class="sc">{</span>total_false_positives<span class="sc">}</span><span class="ss"> points"</span>)</span>
<span id="cb38-660"><a href="#cb38-660" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  False Negatives: </span><span class="sc">{</span>total_false_negatives<span class="sc">}</span><span class="ss"> points"</span>)</span>
<span id="cb38-661"><a href="#cb38-661" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>()</span>
<span id="cb38-662"><a href="#cb38-662" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Overall Segment Detection Metrics:"</span>)</span>
<span id="cb38-663"><a href="#cb38-663" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Total Anomaly Segments: </span><span class="sc">{</span>total_segments<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-664"><a href="#cb38-664" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Fully Detected: </span><span class="sc">{</span>total_fully_detected<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-665"><a href="#cb38-665" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Partially Detected: </span><span class="sc">{</span>total_partially_detected<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-666"><a href="#cb38-666" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Missed: </span><span class="sc">{</span>total_missed<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-667"><a href="#cb38-667" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Segment Detection Rate: </span><span class="sc">{</span>overall_segment_detection_rate<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb38-668"><a href="#cb38-668" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Overall Detection Rate: </span><span class="sc">{</span>overall_detection_rate<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb38-669"><a href="#cb38-669" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-670"><a href="#cb38-670" aria-hidden="true" tabindex="-1"></a><span class="co"># File-by-file summary table</span></span>
<span id="cb38-671"><a href="#cb38-671" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span> <span class="op">*</span> <span class="dv">80</span>)</span>
<span id="cb38-672"><a href="#cb38-672" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"FILE-BY-FILE SUMMARY - HIGH-PRECISION VERSION"</span>)</span>
<span id="cb38-673"><a href="#cb38-673" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">80</span>)</span>
<span id="cb38-674"><a href="#cb38-674" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'File'</span><span class="sc">:&lt;6}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Accuracy'</span><span class="sc">:&lt;10}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Precision'</span><span class="sc">:&lt;10}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Recall'</span><span class="sc">:&lt;10}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'F1-Score'</span><span class="sc">:&lt;10}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'True Ranges'</span><span class="sc">:&lt;12}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Pred Ranges'</span><span class="sc">:&lt;12}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Fully Det.'</span><span class="sc">:&lt;12}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Part. Det.'</span><span class="sc">:&lt;12}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Missed'</span><span class="sc">:&lt;8}</span><span class="ss">"</span>)</span>
<span id="cb38-675"><a href="#cb38-675" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">100</span>)</span>
<span id="cb38-676"><a href="#cb38-676" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-677"><a href="#cb38-677" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx, metrics <span class="kw">in</span> <span class="bu">enumerate</span>(all_metrics):</span>
<span id="cb38-678"><a href="#cb38-678" aria-hidden="true" tabindex="-1"></a>    true_range_count <span class="op">=</span> <span class="bu">len</span>(metrics[<span class="st">'true_ranges'</span>])</span>
<span id="cb38-679"><a href="#cb38-679" aria-hidden="true" tabindex="-1"></a>    pred_range_count <span class="op">=</span> <span class="bu">len</span>(metrics[<span class="st">'predicted_ranges'</span>])</span>
<span id="cb38-680"><a href="#cb38-680" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-681"><a href="#cb38-681" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>idx<span class="sc">:&lt;6}</span><span class="ss"> </span><span class="sc">{</span>metrics[<span class="st">'accuracy'</span>]<span class="sc">:.4f}</span><span class="ss">    </span><span class="sc">{</span>metrics[<span class="st">'precision'</span>]<span class="sc">:.4f}</span><span class="ss">     </span><span class="sc">{</span>metrics[<span class="st">'recall'</span>]<span class="sc">:.4f}</span><span class="ss">     </span><span class="sc">{</span>metrics[<span class="st">'f1_score'</span>]<span class="sc">:.4f}</span><span class="ss">     "</span></span>
<span id="cb38-682"><a href="#cb38-682" aria-hidden="true" tabindex="-1"></a>          <span class="ss">f"</span><span class="sc">{</span>true_range_count<span class="sc">:&lt;11}</span><span class="ss"> </span><span class="sc">{</span>pred_range_count<span class="sc">:&lt;11}</span><span class="ss"> </span><span class="sc">{</span>metrics[<span class="st">'fully_detected'</span>]<span class="sc">:&lt;11}</span><span class="ss"> </span><span class="sc">{</span>metrics[<span class="st">'partially_detected'</span>]<span class="sc">:&lt;11}</span><span class="ss"> </span><span class="sc">{</span>metrics[<span class="st">'missed'</span>]<span class="sc">:&lt;8}</span><span class="ss">"</span>)</span>
<span id="cb38-683"><a href="#cb38-683" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-684"><a href="#cb38-684" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">100</span>)</span>
<span id="cb38-685"><a href="#cb38-685" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-686"><a href="#cb38-686" aria-hidden="true" tabindex="-1"></a><span class="co"># Detailed range information for each file</span></span>
<span id="cb38-687"><a href="#cb38-687" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span> <span class="op">*</span> <span class="dv">80</span>)</span>
<span id="cb38-688"><a href="#cb38-688" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"DETAILED RANGE INFORMATION BY FILE"</span>)</span>
<span id="cb38-689"><a href="#cb38-689" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">80</span>)</span>
<span id="cb38-690"><a href="#cb38-690" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-691"><a href="#cb38-691" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> result <span class="kw">in</span> detailed_results:</span>
<span id="cb38-692"><a href="#cb38-692" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> result[<span class="st">'metrics'</span>][<span class="st">'true_ranges'</span>] <span class="kw">or</span> result[<span class="st">'metrics'</span>][<span class="st">'predicted_ranges'</span>]:</span>
<span id="cb38-693"><a href="#cb38-693" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">File </span><span class="sc">{</span>result[<span class="st">'file_idx'</span>]<span class="sc">}</span><span class="ss">:"</span>)</span>
<span id="cb38-694"><a href="#cb38-694" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  True Ranges: </span><span class="sc">{</span>result[<span class="st">'true_ranges'</span>]<span class="sc">}</span><span class="ss"> (count: </span><span class="sc">{</span><span class="bu">len</span>(result[<span class="st">'true_ranges'</span>])<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb38-695"><a href="#cb38-695" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Predicted Ranges: </span><span class="sc">{</span>result[<span class="st">'predicted_ranges'</span>]<span class="sc">}</span><span class="ss"> (count: </span><span class="sc">{</span><span class="bu">len</span>(result[<span class="st">'predicted_ranges'</span>])<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb38-696"><a href="#cb38-696" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-697"><a href="#cb38-697" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Show matching information</span></span>
<span id="cb38-698"><a href="#cb38-698" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> result[<span class="st">'metrics'</span>][<span class="st">'matched_pairs'</span>]:</span>
<span id="cb38-699"><a href="#cb38-699" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  Matched Pairs:"</span>)</span>
<span id="cb38-700"><a href="#cb38-700" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> match <span class="kw">in</span> result[<span class="st">'metrics'</span>][<span class="st">'matched_pairs'</span>]:</span>
<span id="cb38-701"><a href="#cb38-701" aria-hidden="true" tabindex="-1"></a>                true_idx, pred_range, true_range <span class="op">=</span> match</span>
<span id="cb38-702"><a href="#cb38-702" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"    True Range </span><span class="sc">{</span>true_idx<span class="sc">}</span><span class="ss"> </span><span class="sc">{</span>true_range<span class="sc">}</span><span class="ss"> ‚Üî Predicted </span><span class="sc">{</span>pred_range<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb38-703"><a href="#cb38-703" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-704"><a href="#cb38-704" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Evaluation completed for all files with high-precision detection methods!"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Starting HIGH-PRECISION Anomaly Detection Evaluation
Key improvements for higher precision:
- Contamination range: 0.05-0.2 (reduced from 0.1-0.4)
- Z-score threshold: 3.0 (maintained)
- Stricter range grouping (max_gap=5, min_length=3)
- Anti-overfitting measures (more trees, smaller samples)
- More selective range merging and combination
================================================================================

================================================================================
Optimal contamination for precision: 0.0500
Detected 16 high-confidence anomaly ranges
Isolation Forest ranges: 19, Z-score ranges: 3
EVALUATION RESULTS - FILE 0
============================================================
Range Information:
  True Ranges: [(np.int64(2533), np.int64(2620)), (np.int64(2864), np.int64(2949)), (np.int64(4811), np.int64(4910)), (np.int64(5148), np.int64(5304)), (np.int64(5492), np.int64(5619)), (np.int64(5986), np.int64(6016)), (np.int64(6222), np.int64(6257)), (np.int64(7088), np.int64(7117)), (np.int64(7599), np.int64(7716)), (np.int64(8633), np.int64(8750))] (count: 10)
  Predicted Ranges: [(np.int64(0), np.int64(9)), (np.int64(2533), np.int64(2617)), (np.int64(2860), np.int64(2954)), (np.int64(4808), np.int64(4817)), (np.int64(4900), np.int64(4912)), (np.int64(5236), np.int64(5245)), (np.int64(5291), np.int64(5308)), (np.int64(5491), np.int64(5503)), (np.int64(5608), np.int64(5624)), (np.int64(5982), np.int64(6017)), (np.int64(6219), np.int64(6258)), (np.int64(7084), np.int64(7122)), (np.int64(7595), np.int64(7613)), (np.int64(7711), np.int64(7718)), (np.int64(8628), np.int64(8756)), (np.int64(9986), np.int64(9999))] (count: 16)

Detection Details by Segment:
  Segment 0: (np.int64(2533), np.int64(2620)) ‚úì FULL (85/88 points, 96.6%)
    ‚Üí Overlap with predicted range (np.int64(2533), np.int64(2617)): 85 points
  Segment 1: (np.int64(2864), np.int64(2949)) ‚úì FULL (86/86 points, 100.0%)
    ‚Üí Overlap with predicted range (np.int64(2860), np.int64(2954)): 86 points
  Segment 2: (np.int64(4811), np.int64(4910)) ~ PARTIAL (18/100 points, 18.0%)
    ‚Üí Overlap with predicted range (np.int64(4808), np.int64(4817)): 7 points
    ‚Üí Overlap with predicted range (np.int64(4900), np.int64(4912)): 11 points
  Segment 3: (np.int64(5148), np.int64(5304)) ~ PARTIAL (24/157 points, 15.3%)
    ‚Üí Overlap with predicted range (np.int64(5236), np.int64(5245)): 10 points
    ‚Üí Overlap with predicted range (np.int64(5291), np.int64(5308)): 14 points
  Segment 4: (np.int64(5492), np.int64(5619)) ~ PARTIAL (24/128 points, 18.8%)
    ‚Üí Overlap with predicted range (np.int64(5491), np.int64(5503)): 12 points
    ‚Üí Overlap with predicted range (np.int64(5608), np.int64(5624)): 12 points
  Segment 5: (np.int64(5986), np.int64(6016)) ‚úì FULL (31/31 points, 100.0%)
    ‚Üí Overlap with predicted range (np.int64(5982), np.int64(6017)): 31 points
  Segment 6: (np.int64(6222), np.int64(6257)) ‚úì FULL (36/36 points, 100.0%)
    ‚Üí Overlap with predicted range (np.int64(6219), np.int64(6258)): 36 points
  Segment 7: (np.int64(7088), np.int64(7117)) ‚úì FULL (30/30 points, 100.0%)
    ‚Üí Overlap with predicted range (np.int64(7084), np.int64(7122)): 30 points
  Segment 8: (np.int64(7599), np.int64(7716)) ~ PARTIAL (21/118 points, 17.8%)
    ‚Üí Overlap with predicted range (np.int64(7595), np.int64(7613)): 15 points
    ‚Üí Overlap with predicted range (np.int64(7711), np.int64(7718)): 6 points
  Segment 9: (np.int64(8633), np.int64(8750)) ‚úì FULL (118/118 points, 100.0%)
    ‚Üí Overlap with predicted range (np.int64(8628), np.int64(8756)): 118 points

Basic Metrics:
  Accuracy:  0.9498
  Precision: 0.8507
  Recall:    0.5303
  F1-Score:  0.6533

Anomaly Statistics:
  True Anomalies: 892 points
  Predicted Anomalies: 556 points
  Detection Rate: 0.5303

Range-based Metrics:
  Range Precision: 0.6250
  Range Recall:    1.0000
  Range F1:        0.7692

Point-level Performance:
  True Positives:  473 points
  False Positives: 83 points
  False Negatives: 419 points

Segment Detection Metrics:
  Total Anomaly Segments: 10
  Fully Detected: 6
  Partially Detected: 4
  Missed: 0
  Segment Detection Rate: 0.6000
  Overall Detection Rate: 1.0000


================================================================================
Optimal contamination for precision: 0.0500
Detected 16 high-confidence anomaly ranges
Isolation Forest ranges: 23, Z-score ranges: 8
EVALUATION RESULTS - FILE 1
============================================================
Range Information:
  True Ranges: [(np.int64(2206), np.int64(2325)), (np.int64(2864), np.int64(2978)), (np.int64(3483), np.int64(3565)), (np.int64(3834), np.int64(3926)), (np.int64(4758), np.int64(4878)), (np.int64(6850), np.int64(6957)), (np.int64(7852), np.int64(7954)), (np.int64(8319), np.int64(8428)), (np.int64(9112), np.int64(9225)), (np.int64(9372), np.int64(9471))] (count: 10)
  Predicted Ranges: [(np.int64(0), np.int64(9)), (np.int64(2205), np.int64(2327)), (np.int64(2930), np.int64(2981)), (np.int64(3482), np.int64(3567)), (np.int64(3830), np.int64(3931)), (np.int64(4757), np.int64(4882)), (np.int64(6856), np.int64(6862)), (np.int64(6904), np.int64(6910)), (np.int64(6928), np.int64(6934)), (np.int64(7901), np.int64(7906)), (np.int64(7918), np.int64(7959)), (np.int64(8377), np.int64(8430)), (np.int64(9160), np.int64(9166)), (np.int64(9184), np.int64(9190)), (np.int64(9391), np.int64(9476)), (np.int64(9990), np.int64(9999))] (count: 16)

Detection Details by Segment:
  Segment 0: (np.int64(2206), np.int64(2325)) ‚úì FULL (120/120 points, 100.0%)
    ‚Üí Overlap with predicted range (np.int64(2205), np.int64(2327)): 120 points
  Segment 1: (np.int64(2864), np.int64(2978)) ~ PARTIAL (49/115 points, 42.6%)
    ‚Üí Overlap with predicted range (np.int64(2930), np.int64(2981)): 49 points
  Segment 2: (np.int64(3483), np.int64(3565)) ‚úì FULL (83/83 points, 100.0%)
    ‚Üí Overlap with predicted range (np.int64(3482), np.int64(3567)): 83 points
  Segment 3: (np.int64(3834), np.int64(3926)) ‚úì FULL (93/93 points, 100.0%)
    ‚Üí Overlap with predicted range (np.int64(3830), np.int64(3931)): 93 points
  Segment 4: (np.int64(4758), np.int64(4878)) ‚úì FULL (121/121 points, 100.0%)
    ‚Üí Overlap with predicted range (np.int64(4757), np.int64(4882)): 121 points
  Segment 5: (np.int64(6850), np.int64(6957)) ~ PARTIAL (21/108 points, 19.4%)
    ‚Üí Overlap with predicted range (np.int64(6856), np.int64(6862)): 7 points
    ‚Üí Overlap with predicted range (np.int64(6904), np.int64(6910)): 7 points
    ‚Üí Overlap with predicted range (np.int64(6928), np.int64(6934)): 7 points
  Segment 6: (np.int64(7852), np.int64(7954)) ~ PARTIAL (43/103 points, 41.7%)
    ‚Üí Overlap with predicted range (np.int64(7901), np.int64(7906)): 6 points
    ‚Üí Overlap with predicted range (np.int64(7918), np.int64(7959)): 37 points
  Segment 7: (np.int64(8319), np.int64(8428)) ~ PARTIAL (52/110 points, 47.3%)
    ‚Üí Overlap with predicted range (np.int64(8377), np.int64(8430)): 52 points
  Segment 8: (np.int64(9112), np.int64(9225)) ~ PARTIAL (14/114 points, 12.3%)
    ‚Üí Overlap with predicted range (np.int64(9160), np.int64(9166)): 7 points
    ‚Üí Overlap with predicted range (np.int64(9184), np.int64(9190)): 7 points
  Segment 9: (np.int64(9372), np.int64(9471)) ‚úì FULL (81/100 points, 81.0%)
    ‚Üí Overlap with predicted range (np.int64(9391), np.int64(9476)): 81 points

Basic Metrics:
  Accuracy:  0.9555
  Precision: 0.9249
  Recall:    0.6345
  F1-Score:  0.7526

Anomaly Statistics:
  True Anomalies: 1067 points
  Predicted Anomalies: 732 points
  Detection Rate: 0.6345

Range-based Metrics:
  Range Precision: 0.6250
  Range Recall:    1.0000
  Range F1:        0.7692

Point-level Performance:
  True Positives:  677 points
  False Positives: 55 points
  False Negatives: 390 points

Segment Detection Metrics:
  Total Anomaly Segments: 10
  Fully Detected: 5
  Partially Detected: 5
  Missed: 0
  Segment Detection Rate: 0.5000
  Overall Detection Rate: 1.0000


================================================================================
Optimal contamination for precision: 0.0500
Detected 19 high-confidence anomaly ranges
Isolation Forest ranges: 19, Z-score ranges: 9
EVALUATION RESULTS - FILE 2
============================================================
Range Information:
  True Ranges: [(np.int64(2657), np.int64(2755)), (np.int64(3755), np.int64(3860)), (np.int64(3991), np.int64(4011)), (np.int64(4429), np.int64(4558)), (np.int64(4968), np.int64(5070)), (np.int64(6624), np.int64(6713)), (np.int64(7931), np.int64(8008)), (np.int64(8129), np.int64(8159)), (np.int64(9307), np.int64(9393)), (np.int64(9752), np.int64(9790))] (count: 10)
  Predicted Ranges: [(np.int64(0), np.int64(9)), (np.int64(2681), np.int64(2687)), (np.int64(2699), np.int64(2711)), (np.int64(2729), np.int64(2735)), (np.int64(2747), np.int64(2755)), (np.int64(3761), np.int64(3767)), (np.int64(3785), np.int64(3791)), (np.int64(3803), np.int64(3815)), (np.int64(3833), np.int64(3839)), (np.int64(3988), np.int64(4013)), (np.int64(4487), np.int64(4562)), (np.int64(4964), np.int64(5075)), (np.int64(6655), np.int64(6718)), (np.int64(7961), np.int64(7967)), (np.int64(7979), np.int64(7991)), (np.int64(8126), np.int64(8163)), (np.int64(9350), np.int64(9397)), (np.int64(9749), np.int64(9795)), (np.int64(9989), np.int64(9999))] (count: 19)

Detection Details by Segment:
  Segment 0: (np.int64(2657), np.int64(2755)) ~ PARTIAL (36/99 points, 36.4%)
    ‚Üí Overlap with predicted range (np.int64(2681), np.int64(2687)): 7 points
    ‚Üí Overlap with predicted range (np.int64(2699), np.int64(2711)): 13 points
    ‚Üí Overlap with predicted range (np.int64(2729), np.int64(2735)): 7 points
    ‚Üí Overlap with predicted range (np.int64(2747), np.int64(2755)): 9 points
  Segment 1: (np.int64(3755), np.int64(3860)) ~ PARTIAL (34/106 points, 32.1%)
    ‚Üí Overlap with predicted range (np.int64(3761), np.int64(3767)): 7 points
    ‚Üí Overlap with predicted range (np.int64(3785), np.int64(3791)): 7 points
    ‚Üí Overlap with predicted range (np.int64(3803), np.int64(3815)): 13 points
    ‚Üí Overlap with predicted range (np.int64(3833), np.int64(3839)): 7 points
  Segment 2: (np.int64(3991), np.int64(4011)) ‚úì FULL (21/21 points, 100.0%)
    ‚Üí Overlap with predicted range (np.int64(3988), np.int64(4013)): 21 points
  Segment 3: (np.int64(4429), np.int64(4558)) ~ PARTIAL (72/130 points, 55.4%)
    ‚Üí Overlap with predicted range (np.int64(4487), np.int64(4562)): 72 points
  Segment 4: (np.int64(4968), np.int64(5070)) ‚úì FULL (103/103 points, 100.0%)
    ‚Üí Overlap with predicted range (np.int64(4964), np.int64(5075)): 103 points
  Segment 5: (np.int64(6624), np.int64(6713)) ~ PARTIAL (59/90 points, 65.6%)
    ‚Üí Overlap with predicted range (np.int64(6655), np.int64(6718)): 59 points
  Segment 6: (np.int64(7931), np.int64(8008)) ~ PARTIAL (20/78 points, 25.6%)
    ‚Üí Overlap with predicted range (np.int64(7961), np.int64(7967)): 7 points
    ‚Üí Overlap with predicted range (np.int64(7979), np.int64(7991)): 13 points
  Segment 7: (np.int64(8129), np.int64(8159)) ‚úì FULL (31/31 points, 100.0%)
    ‚Üí Overlap with predicted range (np.int64(8126), np.int64(8163)): 31 points
  Segment 8: (np.int64(9307), np.int64(9393)) ~ PARTIAL (44/87 points, 50.6%)
    ‚Üí Overlap with predicted range (np.int64(9350), np.int64(9397)): 44 points
  Segment 9: (np.int64(9752), np.int64(9790)) ‚úì FULL (39/39 points, 100.0%)
    ‚Üí Overlap with predicted range (np.int64(9749), np.int64(9795)): 39 points

Basic Metrics:
  Accuracy:  0.9612
  Precision: 0.8793
  Recall:    0.5855
  F1-Score:  0.7029

Anomaly Statistics:
  True Anomalies: 784 points
  Predicted Anomalies: 522 points
  Detection Rate: 0.5855

Range-based Metrics:
  Range Precision: 0.5263
  Range Recall:    1.0000
  Range F1:        0.6897

Point-level Performance:
  True Positives:  459 points
  False Positives: 63 points
  False Negatives: 325 points

Segment Detection Metrics:
  Total Anomaly Segments: 10
  Fully Detected: 4
  Partially Detected: 6
  Missed: 0
  Segment Detection Rate: 0.4000
  Overall Detection Rate: 1.0000


================================================================================
Optimal contamination for precision: 0.0500
Detected 20 high-confidence anomaly ranges
Isolation Forest ranges: 21, Z-score ranges: 3
EVALUATION RESULTS - FILE 3
============================================================
Range Information:
  True Ranges: [(np.int64(2240), np.int64(2338)), (np.int64(2824), np.int64(2912)), (np.int64(3685), np.int64(3792)), (np.int64(4212), np.int64(4244)), (np.int64(5007), np.int64(5029)), (np.int64(5758), np.int64(5870)), (np.int64(6665), np.int64(6777)), (np.int64(8492), np.int64(8521)), (np.int64(9099), np.int64(9197)), (np.int64(9628), np.int64(9724))] (count: 10)
  Predicted Ranges: [(np.int64(0), np.int64(24)), (np.int64(2282), np.int64(2291)), (np.int64(2334), np.int64(2342)), (np.int64(2824), np.int64(2909)), (np.int64(3681), np.int64(3689)), (np.int64(3732), np.int64(3744)), (np.int64(3787), np.int64(3797)), (np.int64(4210), np.int64(4248)), (np.int64(5003), np.int64(5034)), (np.int64(5755), np.int64(5762)), (np.int64(5804), np.int64(5824)), (np.int64(5865), np.int64(5874)), (np.int64(6661), np.int64(6678)), (np.int64(6713), np.int64(6729)), (np.int64(6772), np.int64(6781)), (np.int64(8486), np.int64(8527)), (np.int64(9137), np.int64(9155)), (np.int64(9184), np.int64(9202)), (np.int64(9628), np.int64(9725)), (np.int64(9976), np.int64(9999))] (count: 20)

Detection Details by Segment:
  Segment 0: (np.int64(2240), np.int64(2338)) ~ PARTIAL (15/99 points, 15.2%)
    ‚Üí Overlap with predicted range (np.int64(2282), np.int64(2291)): 10 points
    ‚Üí Overlap with predicted range (np.int64(2334), np.int64(2342)): 5 points
  Segment 1: (np.int64(2824), np.int64(2912)) ‚úì FULL (86/89 points, 96.6%)
    ‚Üí Overlap with predicted range (np.int64(2824), np.int64(2909)): 86 points
  Segment 2: (np.int64(3685), np.int64(3792)) ~ PARTIAL (24/108 points, 22.2%)
    ‚Üí Overlap with predicted range (np.int64(3681), np.int64(3689)): 5 points
    ‚Üí Overlap with predicted range (np.int64(3732), np.int64(3744)): 13 points
    ‚Üí Overlap with predicted range (np.int64(3787), np.int64(3797)): 6 points
  Segment 3: (np.int64(4212), np.int64(4244)) ‚úì FULL (33/33 points, 100.0%)
    ‚Üí Overlap with predicted range (np.int64(4210), np.int64(4248)): 33 points
  Segment 4: (np.int64(5007), np.int64(5029)) ‚úì FULL (23/23 points, 100.0%)
    ‚Üí Overlap with predicted range (np.int64(5003), np.int64(5034)): 23 points
  Segment 5: (np.int64(5758), np.int64(5870)) ~ PARTIAL (32/113 points, 28.3%)
    ‚Üí Overlap with predicted range (np.int64(5755), np.int64(5762)): 5 points
    ‚Üí Overlap with predicted range (np.int64(5804), np.int64(5824)): 21 points
    ‚Üí Overlap with predicted range (np.int64(5865), np.int64(5874)): 6 points
  Segment 6: (np.int64(6665), np.int64(6777)) ~ PARTIAL (37/113 points, 32.7%)
    ‚Üí Overlap with predicted range (np.int64(6661), np.int64(6678)): 14 points
    ‚Üí Overlap with predicted range (np.int64(6713), np.int64(6729)): 17 points
    ‚Üí Overlap with predicted range (np.int64(6772), np.int64(6781)): 6 points
  Segment 7: (np.int64(8492), np.int64(8521)) ‚úì FULL (30/30 points, 100.0%)
    ‚Üí Overlap with predicted range (np.int64(8486), np.int64(8527)): 30 points
  Segment 8: (np.int64(9099), np.int64(9197)) ~ PARTIAL (33/99 points, 33.3%)
    ‚Üí Overlap with predicted range (np.int64(9137), np.int64(9155)): 19 points
    ‚Üí Overlap with predicted range (np.int64(9184), np.int64(9202)): 14 points
  Segment 9: (np.int64(9628), np.int64(9724)) ‚úì FULL (97/97 points, 100.0%)
    ‚Üí Overlap with predicted range (np.int64(9628), np.int64(9725)): 97 points

Basic Metrics:
  Accuracy:  0.9496
  Precision: 0.7885
  Recall:    0.5100
  F1-Score:  0.6193

Anomaly Statistics:
  True Anomalies: 804 points
  Predicted Anomalies: 520 points
  Detection Rate: 0.5100

Range-based Metrics:
  Range Precision: 0.5000
  Range Recall:    1.0000
  Range F1:        0.6667

Point-level Performance:
  True Positives:  410 points
  False Positives: 110 points
  False Negatives: 394 points

Segment Detection Metrics:
  Total Anomaly Segments: 10
  Fully Detected: 5
  Partially Detected: 5
  Missed: 0
  Segment Detection Rate: 0.5000
  Overall Detection Rate: 1.0000


================================================================================
Optimal contamination for precision: 0.0500
Detected 12 high-confidence anomaly ranges
Isolation Forest ranges: 15, Z-score ranges: 9
EVALUATION RESULTS - FILE 4
============================================================
Range Information:
  True Ranges: [(np.int64(2229), np.int64(2272)), (np.int64(2744), np.int64(2840)), (np.int64(3010), np.int64(3034)), (np.int64(3761), np.int64(3783)), (np.int64(5028), np.int64(5065)), (np.int64(6270), np.int64(6304)), (np.int64(8383), np.int64(8422)), (np.int64(8650), np.int64(8730)), (np.int64(9602), np.int64(9627)), (np.int64(9862), np.int64(9960))] (count: 10)
  Predicted Ranges: [(np.int64(0), np.int64(9)), (np.int64(2225), np.int64(2276)), (np.int64(2740), np.int64(2845)), (np.int64(3008), np.int64(3038)), (np.int64(3759), np.int64(3786)), (np.int64(5025), np.int64(5068)), (np.int64(6267), np.int64(6305)), (np.int64(8380), np.int64(8427)), (np.int64(8685), np.int64(8735)), (np.int64(9599), np.int64(9632)), (np.int64(9874), np.int64(9960)), (np.int64(9990), np.int64(9999))] (count: 12)

Detection Details by Segment:
  Segment 0: (np.int64(2229), np.int64(2272)) ‚úì FULL (44/44 points, 100.0%)
    ‚Üí Overlap with predicted range (np.int64(2225), np.int64(2276)): 44 points
  Segment 1: (np.int64(2744), np.int64(2840)) ‚úì FULL (97/97 points, 100.0%)
    ‚Üí Overlap with predicted range (np.int64(2740), np.int64(2845)): 97 points
  Segment 2: (np.int64(3010), np.int64(3034)) ‚úì FULL (25/25 points, 100.0%)
    ‚Üí Overlap with predicted range (np.int64(3008), np.int64(3038)): 25 points
  Segment 3: (np.int64(3761), np.int64(3783)) ‚úì FULL (23/23 points, 100.0%)
    ‚Üí Overlap with predicted range (np.int64(3759), np.int64(3786)): 23 points
  Segment 4: (np.int64(5028), np.int64(5065)) ‚úì FULL (38/38 points, 100.0%)
    ‚Üí Overlap with predicted range (np.int64(5025), np.int64(5068)): 38 points
  Segment 5: (np.int64(6270), np.int64(6304)) ‚úì FULL (35/35 points, 100.0%)
    ‚Üí Overlap with predicted range (np.int64(6267), np.int64(6305)): 35 points
  Segment 6: (np.int64(8383), np.int64(8422)) ‚úì FULL (40/40 points, 100.0%)
    ‚Üí Overlap with predicted range (np.int64(8380), np.int64(8427)): 40 points
  Segment 7: (np.int64(8650), np.int64(8730)) ~ PARTIAL (46/81 points, 56.8%)
    ‚Üí Overlap with predicted range (np.int64(8685), np.int64(8735)): 46 points
  Segment 8: (np.int64(9602), np.int64(9627)) ‚úì FULL (26/26 points, 100.0%)
    ‚Üí Overlap with predicted range (np.int64(9599), np.int64(9632)): 26 points
  Segment 9: (np.int64(9862), np.int64(9960)) ‚úì FULL (87/99 points, 87.9%)
    ‚Üí Overlap with predicted range (np.int64(9874), np.int64(9960)): 87 points

Basic Metrics:
  Accuracy:  0.9874
  Precision: 0.8537
  Recall:    0.9075
  F1-Score:  0.8798

Anomaly Statistics:
  True Anomalies: 508 points
  Predicted Anomalies: 540 points
  Detection Rate: 0.9075

Range-based Metrics:
  Range Precision: 0.8333
  Range Recall:    1.0000
  Range F1:        0.9091

Point-level Performance:
  True Positives:  461 points
  False Positives: 79 points
  False Negatives: 47 points

Segment Detection Metrics:
  Total Anomaly Segments: 10
  Fully Detected: 9
  Partially Detected: 1
  Missed: 0
  Segment Detection Rate: 0.9000
  Overall Detection Rate: 1.0000


================================================================================
Optimal contamination for precision: 0.0500
Detected 21 high-confidence anomaly ranges
Isolation Forest ranges: 23, Z-score ranges: 7
EVALUATION RESULTS - FILE 5
============================================================
Range Information:
  True Ranges: [(np.int64(2661), np.int64(2775)), (np.int64(2863), np.int64(2894)), (np.int64(3006), np.int64(3124)), (np.int64(4118), np.int64(4269)), (np.int64(4463), np.int64(4591)), (np.int64(5953), np.int64(5994)), (np.int64(6107), np.int64(6225)), (np.int64(6429), np.int64(6577)), (np.int64(7969), np.int64(8094)), (np.int64(8886), np.int64(8906))] (count: 10)
  Predicted Ranges: [(np.int64(0), np.int64(9)), (np.int64(2679), np.int64(2685)), (np.int64(2703), np.int64(2715)), (np.int64(2727), np.int64(2733)), (np.int64(2863), np.int64(2897)), (np.int64(3004), np.int64(3010)), (np.int64(3056), np.int64(3075)), (np.int64(3121), np.int64(3127)), (np.int64(4180), np.int64(4274)), (np.int64(4463), np.int64(4466)), (np.int64(4513), np.int64(4542)), (np.int64(4588), np.int64(4594)), (np.int64(5950), np.int64(5998)), (np.int64(6137), np.int64(6167)), (np.int64(6179), np.int64(6215)), (np.int64(6484), np.int64(6581)), (np.int64(7968), np.int64(7979)), (np.int64(8019), np.int64(8045)), (np.int64(8083), np.int64(8098)), (np.int64(8885), np.int64(8909)), (np.int64(9984), np.int64(9999))] (count: 21)

Detection Details by Segment:
  Segment 0: (np.int64(2661), np.int64(2775)) ~ PARTIAL (27/115 points, 23.5%)
    ‚Üí Overlap with predicted range (np.int64(2679), np.int64(2685)): 7 points
    ‚Üí Overlap with predicted range (np.int64(2703), np.int64(2715)): 13 points
    ‚Üí Overlap with predicted range (np.int64(2727), np.int64(2733)): 7 points
  Segment 1: (np.int64(2863), np.int64(2894)) ‚úì FULL (32/32 points, 100.0%)
    ‚Üí Overlap with predicted range (np.int64(2863), np.int64(2897)): 32 points
  Segment 2: (np.int64(3006), np.int64(3124)) ~ PARTIAL (29/119 points, 24.4%)
    ‚Üí Overlap with predicted range (np.int64(3004), np.int64(3010)): 5 points
    ‚Üí Overlap with predicted range (np.int64(3056), np.int64(3075)): 20 points
    ‚Üí Overlap with predicted range (np.int64(3121), np.int64(3127)): 4 points
  Segment 3: (np.int64(4118), np.int64(4269)) ~ PARTIAL (90/152 points, 59.2%)
    ‚Üí Overlap with predicted range (np.int64(4180), np.int64(4274)): 90 points
  Segment 4: (np.int64(4463), np.int64(4591)) ~ PARTIAL (38/129 points, 29.5%)
    ‚Üí Overlap with predicted range (np.int64(4463), np.int64(4466)): 4 points
    ‚Üí Overlap with predicted range (np.int64(4513), np.int64(4542)): 30 points
    ‚Üí Overlap with predicted range (np.int64(4588), np.int64(4594)): 4 points
  Segment 5: (np.int64(5953), np.int64(5994)) ‚úì FULL (42/42 points, 100.0%)
    ‚Üí Overlap with predicted range (np.int64(5950), np.int64(5998)): 42 points
  Segment 6: (np.int64(6107), np.int64(6225)) ~ PARTIAL (68/119 points, 57.1%)
    ‚Üí Overlap with predicted range (np.int64(6137), np.int64(6167)): 31 points
    ‚Üí Overlap with predicted range (np.int64(6179), np.int64(6215)): 37 points
  Segment 7: (np.int64(6429), np.int64(6577)) ~ PARTIAL (94/149 points, 63.1%)
    ‚Üí Overlap with predicted range (np.int64(6484), np.int64(6581)): 94 points
  Segment 8: (np.int64(7969), np.int64(8094)) ~ PARTIAL (50/126 points, 39.7%)
    ‚Üí Overlap with predicted range (np.int64(7968), np.int64(7979)): 11 points
    ‚Üí Overlap with predicted range (np.int64(8019), np.int64(8045)): 27 points
    ‚Üí Overlap with predicted range (np.int64(8083), np.int64(8098)): 12 points
  Segment 9: (np.int64(8886), np.int64(8906)) ‚úì FULL (21/21 points, 100.0%)
    ‚Üí Overlap with predicted range (np.int64(8885), np.int64(8909)): 21 points

Basic Metrics:
  Accuracy:  0.9425
  Precision: 0.8879
  Recall:    0.4890
  F1-Score:  0.6307

Anomaly Statistics:
  True Anomalies: 1004 points
  Predicted Anomalies: 553 points
  Detection Rate: 0.4890

Range-based Metrics:
  Range Precision: 0.4762
  Range Recall:    1.0000
  Range F1:        0.6452

Point-level Performance:
  True Positives:  491 points
  False Positives: 62 points
  False Negatives: 513 points

Segment Detection Metrics:
  Total Anomaly Segments: 10
  Fully Detected: 3
  Partially Detected: 7
  Missed: 0
  Segment Detection Rate: 0.3000
  Overall Detection Rate: 1.0000


================================================================================
Optimal contamination for precision: 0.0500
Detected 13 high-confidence anomaly ranges
Isolation Forest ranges: 23, Z-score ranges: 9
EVALUATION RESULTS - FILE 6
============================================================
Range Information:
  True Ranges: [(np.int64(2543), np.int64(2670)), (np.int64(3004), np.int64(3087)), (np.int64(3766), np.int64(3826)), (np.int64(5188), np.int64(5304)), (np.int64(5882), np.int64(5908)), (np.int64(6584), np.int64(6609)), (np.int64(7041), np.int64(7143)), (np.int64(7441), np.int64(7539)), (np.int64(9294), np.int64(9429)), (np.int64(9817), np.int64(9846))] (count: 10)
  Predicted Ranges: [(np.int64(0), np.int64(9)), (np.int64(2541), np.int64(2672)), (np.int64(3047), np.int64(3089)), (np.int64(3784), np.int64(3790)), (np.int64(3808), np.int64(3814)), (np.int64(5255), np.int64(5308)), (np.int64(5880), np.int64(5911)), (np.int64(6584), np.int64(6612)), (np.int64(7038), np.int64(7148)), (np.int64(7438), np.int64(7542)), (np.int64(9360), np.int64(9434)), (np.int64(9815), np.int64(9849)), (np.int64(9991), np.int64(9999))] (count: 13)

Detection Details by Segment:
  Segment 0: (np.int64(2543), np.int64(2670)) ‚úì FULL (128/128 points, 100.0%)
    ‚Üí Overlap with predicted range (np.int64(2541), np.int64(2672)): 128 points
  Segment 1: (np.int64(3004), np.int64(3087)) ~ PARTIAL (41/84 points, 48.8%)
    ‚Üí Overlap with predicted range (np.int64(3047), np.int64(3089)): 41 points
  Segment 2: (np.int64(3766), np.int64(3826)) ~ PARTIAL (14/61 points, 23.0%)
    ‚Üí Overlap with predicted range (np.int64(3784), np.int64(3790)): 7 points
    ‚Üí Overlap with predicted range (np.int64(3808), np.int64(3814)): 7 points
  Segment 3: (np.int64(5188), np.int64(5304)) ~ PARTIAL (50/117 points, 42.7%)
    ‚Üí Overlap with predicted range (np.int64(5255), np.int64(5308)): 50 points
  Segment 4: (np.int64(5882), np.int64(5908)) ‚úì FULL (27/27 points, 100.0%)
    ‚Üí Overlap with predicted range (np.int64(5880), np.int64(5911)): 27 points
  Segment 5: (np.int64(6584), np.int64(6609)) ‚úì FULL (26/26 points, 100.0%)
    ‚Üí Overlap with predicted range (np.int64(6584), np.int64(6612)): 26 points
  Segment 6: (np.int64(7041), np.int64(7143)) ‚úì FULL (103/103 points, 100.0%)
    ‚Üí Overlap with predicted range (np.int64(7038), np.int64(7148)): 103 points
  Segment 7: (np.int64(7441), np.int64(7539)) ‚úì FULL (99/99 points, 100.0%)
    ‚Üí Overlap with predicted range (np.int64(7438), np.int64(7542)): 99 points
  Segment 8: (np.int64(9294), np.int64(9429)) ~ PARTIAL (70/136 points, 51.5%)
    ‚Üí Overlap with predicted range (np.int64(9360), np.int64(9434)): 70 points
  Segment 9: (np.int64(9817), np.int64(9846)) ‚úì FULL (30/30 points, 100.0%)
    ‚Üí Overlap with predicted range (np.int64(9815), np.int64(9849)): 30 points

Basic Metrics:
  Accuracy:  0.9716
  Precision: 0.9060
  Recall:    0.7250
  F1-Score:  0.8055

Anomaly Statistics:
  True Anomalies: 811 points
  Predicted Anomalies: 649 points
  Detection Rate: 0.7250

Range-based Metrics:
  Range Precision: 0.7692
  Range Recall:    1.0000
  Range F1:        0.8696

Point-level Performance:
  True Positives:  588 points
  False Positives: 61 points
  False Negatives: 223 points

Segment Detection Metrics:
  Total Anomaly Segments: 10
  Fully Detected: 6
  Partially Detected: 4
  Missed: 0
  Segment Detection Rate: 0.6000
  Overall Detection Rate: 1.0000


================================================================================
Optimal contamination for precision: 0.0500
Detected 15 high-confidence anomaly ranges
Isolation Forest ranges: 18, Z-score ranges: 8
EVALUATION RESULTS - FILE 7
============================================================
Range Information:
  True Ranges: [(np.int64(2165), np.int64(2305)), (np.int64(2570), np.int64(2611)), (np.int64(4188), np.int64(4306)), (np.int64(4572), np.int64(4721)), (np.int64(5008), np.int64(5095)), (np.int64(6491), np.int64(6560)), (np.int64(7365), np.int64(7484)), (np.int64(8348), np.int64(8452)), (np.int64(8592), np.int64(8614)), (np.int64(9537), np.int64(9614))] (count: 10)
  Predicted Ranges: [(np.int64(0), np.int64(9)), (np.int64(2255), np.int64(2309)), (np.int64(2568), np.int64(2613)), (np.int64(4218), np.int64(4224)), (np.int64(4236), np.int64(4248)), (np.int64(4260), np.int64(4272)), (np.int64(4639), np.int64(4726)), (np.int64(5023), np.int64(5099)), (np.int64(6521), np.int64(6527)), (np.int64(7421), np.int64(7488)), (np.int64(8344), np.int64(8455)), (np.int64(8592), np.int64(8616)), (np.int64(9567), np.int64(9579)), (np.int64(9591), np.int64(9597)), (np.int64(9991), np.int64(9999))] (count: 15)

Detection Details by Segment:
  Segment 0: (np.int64(2165), np.int64(2305)) ~ PARTIAL (51/141 points, 36.2%)
    ‚Üí Overlap with predicted range (np.int64(2255), np.int64(2309)): 51 points
  Segment 1: (np.int64(2570), np.int64(2611)) ‚úì FULL (42/42 points, 100.0%)
    ‚Üí Overlap with predicted range (np.int64(2568), np.int64(2613)): 42 points
  Segment 2: (np.int64(4188), np.int64(4306)) ~ PARTIAL (33/119 points, 27.7%)
    ‚Üí Overlap with predicted range (np.int64(4218), np.int64(4224)): 7 points
    ‚Üí Overlap with predicted range (np.int64(4236), np.int64(4248)): 13 points
    ‚Üí Overlap with predicted range (np.int64(4260), np.int64(4272)): 13 points
  Segment 3: (np.int64(4572), np.int64(4721)) ~ PARTIAL (83/150 points, 55.3%)
    ‚Üí Overlap with predicted range (np.int64(4639), np.int64(4726)): 83 points
  Segment 4: (np.int64(5008), np.int64(5095)) ‚úì FULL (73/88 points, 83.0%)
    ‚Üí Overlap with predicted range (np.int64(5023), np.int64(5099)): 73 points
  Segment 5: (np.int64(6491), np.int64(6560)) ~ PARTIAL (7/70 points, 10.0%)
    ‚Üí Overlap with predicted range (np.int64(6521), np.int64(6527)): 7 points
  Segment 6: (np.int64(7365), np.int64(7484)) ~ PARTIAL (64/120 points, 53.3%)
    ‚Üí Overlap with predicted range (np.int64(7421), np.int64(7488)): 64 points
  Segment 7: (np.int64(8348), np.int64(8452)) ‚úì FULL (105/105 points, 100.0%)
    ‚Üí Overlap with predicted range (np.int64(8344), np.int64(8455)): 105 points
  Segment 8: (np.int64(8592), np.int64(8614)) ‚úì FULL (23/23 points, 100.0%)
    ‚Üí Overlap with predicted range (np.int64(8592), np.int64(8616)): 23 points
  Segment 9: (np.int64(9537), np.int64(9614)) ~ PARTIAL (20/78 points, 25.6%)
    ‚Üí Overlap with predicted range (np.int64(9567), np.int64(9579)): 13 points
    ‚Üí Overlap with predicted range (np.int64(9591), np.int64(9597)): 7 points

Basic Metrics:
  Accuracy:  0.9516
  Precision: 0.9109
  Recall:    0.5353
  F1-Score:  0.6743

Anomaly Statistics:
  True Anomalies: 936 points
  Predicted Anomalies: 550 points
  Detection Rate: 0.5353

Range-based Metrics:
  Range Precision: 0.6667
  Range Recall:    1.0000
  Range F1:        0.8000

Point-level Performance:
  True Positives:  501 points
  False Positives: 49 points
  False Negatives: 435 points

Segment Detection Metrics:
  Total Anomaly Segments: 10
  Fully Detected: 4
  Partially Detected: 6
  Missed: 0
  Segment Detection Rate: 0.4000
  Overall Detection Rate: 1.0000


================================================================================
Optimal contamination for precision: 0.0500
Detected 14 high-confidence anomaly ranges
Isolation Forest ranges: 23, Z-score ranges: 9
EVALUATION RESULTS - FILE 8
============================================================
Range Information:
  True Ranges: [(np.int64(2340), np.int64(2407)), (np.int64(2594), np.int64(2698)), (np.int64(4708), np.int64(4787)), (np.int64(5387), np.int64(5480)), (np.int64(6153), np.int64(6267)), (np.int64(6479), np.int64(6580)), (np.int64(7548), np.int64(7569)), (np.int64(8021), np.int64(8058)), (np.int64(8299), np.int64(8329)), (np.int64(9827), np.int64(9904))] (count: 10)
  Predicted Ranges: [(np.int64(0), np.int64(9)), (np.int64(2346), np.int64(2352)), (np.int64(2364), np.int64(2400)), (np.int64(2633), np.int64(2700)), (np.int64(4741), np.int64(4789)), (np.int64(5418), np.int64(5482)), (np.int64(6159), np.int64(6165)), (np.int64(6177), np.int64(6267)), (np.int64(6495), np.int64(6582)), (np.int64(7544), np.int64(7574)), (np.int64(8019), np.int64(8059)), (np.int64(8295), np.int64(8335)), (np.int64(9833), np.int64(9900)), (np.int64(9990), np.int64(9999))] (count: 14)

Detection Details by Segment:
  Segment 0: (np.int64(2340), np.int64(2407)) ~ PARTIAL (44/68 points, 64.7%)
    ‚Üí Overlap with predicted range (np.int64(2346), np.int64(2352)): 7 points
    ‚Üí Overlap with predicted range (np.int64(2364), np.int64(2400)): 37 points
  Segment 1: (np.int64(2594), np.int64(2698)) ~ PARTIAL (66/105 points, 62.9%)
    ‚Üí Overlap with predicted range (np.int64(2633), np.int64(2700)): 66 points
  Segment 2: (np.int64(4708), np.int64(4787)) ~ PARTIAL (47/80 points, 58.8%)
    ‚Üí Overlap with predicted range (np.int64(4741), np.int64(4789)): 47 points
  Segment 3: (np.int64(5387), np.int64(5480)) ~ PARTIAL (63/94 points, 67.0%)
    ‚Üí Overlap with predicted range (np.int64(5418), np.int64(5482)): 63 points
  Segment 4: (np.int64(6153), np.int64(6267)) ‚úì FULL (98/115 points, 85.2%)
    ‚Üí Overlap with predicted range (np.int64(6159), np.int64(6165)): 7 points
    ‚Üí Overlap with predicted range (np.int64(6177), np.int64(6267)): 91 points
  Segment 5: (np.int64(6479), np.int64(6580)) ‚úì FULL (86/102 points, 84.3%)
    ‚Üí Overlap with predicted range (np.int64(6495), np.int64(6582)): 86 points
  Segment 6: (np.int64(7548), np.int64(7569)) ‚úì FULL (22/22 points, 100.0%)
    ‚Üí Overlap with predicted range (np.int64(7544), np.int64(7574)): 22 points
  Segment 7: (np.int64(8021), np.int64(8058)) ‚úì FULL (38/38 points, 100.0%)
    ‚Üí Overlap with predicted range (np.int64(8019), np.int64(8059)): 38 points
  Segment 8: (np.int64(8299), np.int64(8329)) ‚úì FULL (31/31 points, 100.0%)
    ‚Üí Overlap with predicted range (np.int64(8295), np.int64(8335)): 31 points
  Segment 9: (np.int64(9827), np.int64(9904)) ‚úì FULL (68/78 points, 87.2%)
    ‚Üí Overlap with predicted range (np.int64(9833), np.int64(9900)): 68 points

Basic Metrics:
  Accuracy:  0.9780
  Precision: 0.9184
  Recall:    0.7681
  F1-Score:  0.8366

Anomaly Statistics:
  True Anomalies: 733 points
  Predicted Anomalies: 613 points
  Detection Rate: 0.7681

Range-based Metrics:
  Range Precision: 0.7143
  Range Recall:    1.0000
  Range F1:        0.8333

Point-level Performance:
  True Positives:  563 points
  False Positives: 50 points
  False Negatives: 170 points

Segment Detection Metrics:
  Total Anomaly Segments: 10
  Fully Detected: 6
  Partially Detected: 4
  Missed: 0
  Segment Detection Rate: 0.6000
  Overall Detection Rate: 1.0000


================================================================================
Optimal contamination for precision: 0.0500
Detected 14 high-confidence anomaly ranges
Isolation Forest ranges: 28, Z-score ranges: 6
EVALUATION RESULTS - FILE 9
============================================================
Range Information:
  True Ranges: [(np.int64(3463), np.int64(3494)), (np.int64(3896), np.int64(3993)), (np.int64(4143), np.int64(4224)), (np.int64(5471), np.int64(5578)), (np.int64(6064), np.int64(6145)), (np.int64(6543), np.int64(6636)), (np.int64(7889), np.int64(8021)), (np.int64(8650), np.int64(8756)), (np.int64(9074), np.int64(9225)), (np.int64(9621), np.int64(9740))] (count: 10)
  Predicted Ranges: [(np.int64(0), np.int64(9)), (np.int64(3473), np.int64(3495)), (np.int64(3893), np.int64(3998)), (np.int64(4143), np.int64(4149)), (np.int64(4161), np.int64(4223)), (np.int64(5467), np.int64(5583)), (np.int64(6102), np.int64(6105)), (np.int64(6117), np.int64(6148)), (np.int64(6539), np.int64(6640)), (np.int64(7886), np.int64(8025)), (np.int64(8715), np.int64(8757)), (np.int64(9155), np.int64(9227)), (np.int64(9685), np.int64(9741)), (np.int64(9991), np.int64(9999))] (count: 14)

Detection Details by Segment:
  Segment 0: (np.int64(3463), np.int64(3494)) ~ PARTIAL (22/32 points, 68.8%)
    ‚Üí Overlap with predicted range (np.int64(3473), np.int64(3495)): 22 points
  Segment 1: (np.int64(3896), np.int64(3993)) ‚úì FULL (98/98 points, 100.0%)
    ‚Üí Overlap with predicted range (np.int64(3893), np.int64(3998)): 98 points
  Segment 2: (np.int64(4143), np.int64(4224)) ‚úì FULL (70/82 points, 85.4%)
    ‚Üí Overlap with predicted range (np.int64(4143), np.int64(4149)): 7 points
    ‚Üí Overlap with predicted range (np.int64(4161), np.int64(4223)): 63 points
  Segment 3: (np.int64(5471), np.int64(5578)) ‚úì FULL (108/108 points, 100.0%)
    ‚Üí Overlap with predicted range (np.int64(5467), np.int64(5583)): 108 points
  Segment 4: (np.int64(6064), np.int64(6145)) ~ PARTIAL (33/82 points, 40.2%)
    ‚Üí Overlap with predicted range (np.int64(6102), np.int64(6105)): 4 points
    ‚Üí Overlap with predicted range (np.int64(6117), np.int64(6148)): 29 points
  Segment 5: (np.int64(6543), np.int64(6636)) ‚úì FULL (94/94 points, 100.0%)
    ‚Üí Overlap with predicted range (np.int64(6539), np.int64(6640)): 94 points
  Segment 6: (np.int64(7889), np.int64(8021)) ‚úì FULL (133/133 points, 100.0%)
    ‚Üí Overlap with predicted range (np.int64(7886), np.int64(8025)): 133 points
  Segment 7: (np.int64(8650), np.int64(8756)) ~ PARTIAL (42/107 points, 39.3%)
    ‚Üí Overlap with predicted range (np.int64(8715), np.int64(8757)): 42 points
  Segment 8: (np.int64(9074), np.int64(9225)) ~ PARTIAL (71/152 points, 46.7%)
    ‚Üí Overlap with predicted range (np.int64(9155), np.int64(9227)): 71 points
  Segment 9: (np.int64(9621), np.int64(9740)) ~ PARTIAL (56/120 points, 46.7%)
    ‚Üí Overlap with predicted range (np.int64(9685), np.int64(9741)): 56 points

Basic Metrics:
  Accuracy:  0.9660
  Precision: 0.9249
  Recall:    0.7212
  F1-Score:  0.8105

Anomaly Statistics:
  True Anomalies: 1008 points
  Predicted Anomalies: 786 points
  Detection Rate: 0.7212

Range-based Metrics:
  Range Precision: 0.7143
  Range Recall:    1.0000
  Range F1:        0.8333

Point-level Performance:
  True Positives:  727 points
  False Positives: 59 points
  False Negatives: 281 points

Segment Detection Metrics:
  Total Anomaly Segments: 10
  Fully Detected: 5
  Partially Detected: 5
  Missed: 0
  Segment Detection Rate: 0.5000
  Overall Detection Rate: 1.0000


================================================================================
OVERALL SUMMARY ACROSS ALL FILES - HIGH-PRECISION VERSION
================================================================================
Overall Basic Metrics:
  Accuracy:  0.9613
  Precision: 0.8845
  Recall:    0.6406
  F1-Score:  0.7365

Overall Range Statistics:
  Total True Ranges: 100
  Total Predicted Ranges: 160
  Total Matched Ranges: 100
  Range Match Rate: 1.0000

Overall Range-based Metrics:
  Range Precision: 0.6450
  Range Recall:    1.0000
  Range F1:        0.7785

Overall Point-level Performance:
  True Positives:  5350 points
  False Positives: 671 points
  False Negatives: 3197 points

Overall Segment Detection Metrics:
  Total Anomaly Segments: 100
  Fully Detected: 53
  Partially Detected: 47
  Missed: 0
  Segment Detection Rate: 0.5300
  Overall Detection Rate: 1.0000

================================================================================
FILE-BY-FILE SUMMARY - HIGH-PRECISION VERSION
================================================================================
File   Accuracy   Precision  Recall     F1-Score   True Ranges  Pred Ranges  Fully Det.   Part. Det.   Missed  
----------------------------------------------------------------------------------------------------
0      0.9498    0.8507     0.5303     0.6533     10          16          6           4           0       
1      0.9555    0.9249     0.6345     0.7526     10          16          5           5           0       
2      0.9612    0.8793     0.5855     0.7029     10          19          4           6           0       
3      0.9496    0.7885     0.5100     0.6193     10          20          5           5           0       
4      0.9874    0.8537     0.9075     0.8798     10          12          9           1           0       
5      0.9425    0.8879     0.4890     0.6307     10          21          3           7           0       
6      0.9716    0.9060     0.7250     0.8055     10          13          6           4           0       
7      0.9516    0.9109     0.5353     0.6743     10          15          4           6           0       
8      0.9780    0.9184     0.7681     0.8366     10          14          6           4           0       
9      0.9660    0.9249     0.7212     0.8105     10          14          5           5           0       
----------------------------------------------------------------------------------------------------

================================================================================
DETAILED RANGE INFORMATION BY FILE
================================================================================

File 0:
  True Ranges: [(np.int64(2533), np.int64(2620)), (np.int64(2864), np.int64(2949)), (np.int64(4811), np.int64(4910)), (np.int64(5148), np.int64(5304)), (np.int64(5492), np.int64(5619)), (np.int64(5986), np.int64(6016)), (np.int64(6222), np.int64(6257)), (np.int64(7088), np.int64(7117)), (np.int64(7599), np.int64(7716)), (np.int64(8633), np.int64(8750))] (count: 10)
  Predicted Ranges: [(np.int64(0), np.int64(9)), (np.int64(2533), np.int64(2617)), (np.int64(2860), np.int64(2954)), (np.int64(4808), np.int64(4817)), (np.int64(4900), np.int64(4912)), (np.int64(5236), np.int64(5245)), (np.int64(5291), np.int64(5308)), (np.int64(5491), np.int64(5503)), (np.int64(5608), np.int64(5624)), (np.int64(5982), np.int64(6017)), (np.int64(6219), np.int64(6258)), (np.int64(7084), np.int64(7122)), (np.int64(7595), np.int64(7613)), (np.int64(7711), np.int64(7718)), (np.int64(8628), np.int64(8756)), (np.int64(9986), np.int64(9999))] (count: 16)
  Matched Pairs:
    True Range 0 (np.int64(2533), np.int64(2620)) ‚Üî Predicted (np.int64(2533), np.int64(2617))
    True Range 1 (np.int64(2864), np.int64(2949)) ‚Üî Predicted (np.int64(2860), np.int64(2954))
    True Range 2 (np.int64(4811), np.int64(4910)) ‚Üî Predicted (np.int64(4808), np.int64(4817))
    True Range 3 (np.int64(5148), np.int64(5304)) ‚Üî Predicted (np.int64(5236), np.int64(5245))
    True Range 4 (np.int64(5492), np.int64(5619)) ‚Üî Predicted (np.int64(5491), np.int64(5503))
    True Range 5 (np.int64(5986), np.int64(6016)) ‚Üî Predicted (np.int64(5982), np.int64(6017))
    True Range 6 (np.int64(6222), np.int64(6257)) ‚Üî Predicted (np.int64(6219), np.int64(6258))
    True Range 7 (np.int64(7088), np.int64(7117)) ‚Üî Predicted (np.int64(7084), np.int64(7122))
    True Range 8 (np.int64(7599), np.int64(7716)) ‚Üî Predicted (np.int64(7595), np.int64(7613))
    True Range 9 (np.int64(8633), np.int64(8750)) ‚Üî Predicted (np.int64(8628), np.int64(8756))

File 1:
  True Ranges: [(np.int64(2206), np.int64(2325)), (np.int64(2864), np.int64(2978)), (np.int64(3483), np.int64(3565)), (np.int64(3834), np.int64(3926)), (np.int64(4758), np.int64(4878)), (np.int64(6850), np.int64(6957)), (np.int64(7852), np.int64(7954)), (np.int64(8319), np.int64(8428)), (np.int64(9112), np.int64(9225)), (np.int64(9372), np.int64(9471))] (count: 10)
  Predicted Ranges: [(np.int64(0), np.int64(9)), (np.int64(2205), np.int64(2327)), (np.int64(2930), np.int64(2981)), (np.int64(3482), np.int64(3567)), (np.int64(3830), np.int64(3931)), (np.int64(4757), np.int64(4882)), (np.int64(6856), np.int64(6862)), (np.int64(6904), np.int64(6910)), (np.int64(6928), np.int64(6934)), (np.int64(7901), np.int64(7906)), (np.int64(7918), np.int64(7959)), (np.int64(8377), np.int64(8430)), (np.int64(9160), np.int64(9166)), (np.int64(9184), np.int64(9190)), (np.int64(9391), np.int64(9476)), (np.int64(9990), np.int64(9999))] (count: 16)
  Matched Pairs:
    True Range 0 (np.int64(2206), np.int64(2325)) ‚Üî Predicted (np.int64(2205), np.int64(2327))
    True Range 1 (np.int64(2864), np.int64(2978)) ‚Üî Predicted (np.int64(2930), np.int64(2981))
    True Range 2 (np.int64(3483), np.int64(3565)) ‚Üî Predicted (np.int64(3482), np.int64(3567))
    True Range 3 (np.int64(3834), np.int64(3926)) ‚Üî Predicted (np.int64(3830), np.int64(3931))
    True Range 4 (np.int64(4758), np.int64(4878)) ‚Üî Predicted (np.int64(4757), np.int64(4882))
    True Range 5 (np.int64(6850), np.int64(6957)) ‚Üî Predicted (np.int64(6856), np.int64(6862))
    True Range 6 (np.int64(7852), np.int64(7954)) ‚Üî Predicted (np.int64(7901), np.int64(7906))
    True Range 7 (np.int64(8319), np.int64(8428)) ‚Üî Predicted (np.int64(8377), np.int64(8430))
    True Range 8 (np.int64(9112), np.int64(9225)) ‚Üî Predicted (np.int64(9160), np.int64(9166))
    True Range 9 (np.int64(9372), np.int64(9471)) ‚Üî Predicted (np.int64(9391), np.int64(9476))

File 2:
  True Ranges: [(np.int64(2657), np.int64(2755)), (np.int64(3755), np.int64(3860)), (np.int64(3991), np.int64(4011)), (np.int64(4429), np.int64(4558)), (np.int64(4968), np.int64(5070)), (np.int64(6624), np.int64(6713)), (np.int64(7931), np.int64(8008)), (np.int64(8129), np.int64(8159)), (np.int64(9307), np.int64(9393)), (np.int64(9752), np.int64(9790))] (count: 10)
  Predicted Ranges: [(np.int64(0), np.int64(9)), (np.int64(2681), np.int64(2687)), (np.int64(2699), np.int64(2711)), (np.int64(2729), np.int64(2735)), (np.int64(2747), np.int64(2755)), (np.int64(3761), np.int64(3767)), (np.int64(3785), np.int64(3791)), (np.int64(3803), np.int64(3815)), (np.int64(3833), np.int64(3839)), (np.int64(3988), np.int64(4013)), (np.int64(4487), np.int64(4562)), (np.int64(4964), np.int64(5075)), (np.int64(6655), np.int64(6718)), (np.int64(7961), np.int64(7967)), (np.int64(7979), np.int64(7991)), (np.int64(8126), np.int64(8163)), (np.int64(9350), np.int64(9397)), (np.int64(9749), np.int64(9795)), (np.int64(9989), np.int64(9999))] (count: 19)
  Matched Pairs:
    True Range 0 (np.int64(2657), np.int64(2755)) ‚Üî Predicted (np.int64(2681), np.int64(2687))
    True Range 1 (np.int64(3755), np.int64(3860)) ‚Üî Predicted (np.int64(3761), np.int64(3767))
    True Range 2 (np.int64(3991), np.int64(4011)) ‚Üî Predicted (np.int64(3988), np.int64(4013))
    True Range 3 (np.int64(4429), np.int64(4558)) ‚Üî Predicted (np.int64(4487), np.int64(4562))
    True Range 4 (np.int64(4968), np.int64(5070)) ‚Üî Predicted (np.int64(4964), np.int64(5075))
    True Range 5 (np.int64(6624), np.int64(6713)) ‚Üî Predicted (np.int64(6655), np.int64(6718))
    True Range 6 (np.int64(7931), np.int64(8008)) ‚Üî Predicted (np.int64(7961), np.int64(7967))
    True Range 7 (np.int64(8129), np.int64(8159)) ‚Üî Predicted (np.int64(8126), np.int64(8163))
    True Range 8 (np.int64(9307), np.int64(9393)) ‚Üî Predicted (np.int64(9350), np.int64(9397))
    True Range 9 (np.int64(9752), np.int64(9790)) ‚Üî Predicted (np.int64(9749), np.int64(9795))

File 3:
  True Ranges: [(np.int64(2240), np.int64(2338)), (np.int64(2824), np.int64(2912)), (np.int64(3685), np.int64(3792)), (np.int64(4212), np.int64(4244)), (np.int64(5007), np.int64(5029)), (np.int64(5758), np.int64(5870)), (np.int64(6665), np.int64(6777)), (np.int64(8492), np.int64(8521)), (np.int64(9099), np.int64(9197)), (np.int64(9628), np.int64(9724))] (count: 10)
  Predicted Ranges: [(np.int64(0), np.int64(24)), (np.int64(2282), np.int64(2291)), (np.int64(2334), np.int64(2342)), (np.int64(2824), np.int64(2909)), (np.int64(3681), np.int64(3689)), (np.int64(3732), np.int64(3744)), (np.int64(3787), np.int64(3797)), (np.int64(4210), np.int64(4248)), (np.int64(5003), np.int64(5034)), (np.int64(5755), np.int64(5762)), (np.int64(5804), np.int64(5824)), (np.int64(5865), np.int64(5874)), (np.int64(6661), np.int64(6678)), (np.int64(6713), np.int64(6729)), (np.int64(6772), np.int64(6781)), (np.int64(8486), np.int64(8527)), (np.int64(9137), np.int64(9155)), (np.int64(9184), np.int64(9202)), (np.int64(9628), np.int64(9725)), (np.int64(9976), np.int64(9999))] (count: 20)
  Matched Pairs:
    True Range 0 (np.int64(2240), np.int64(2338)) ‚Üî Predicted (np.int64(2282), np.int64(2291))
    True Range 1 (np.int64(2824), np.int64(2912)) ‚Üî Predicted (np.int64(2824), np.int64(2909))
    True Range 2 (np.int64(3685), np.int64(3792)) ‚Üî Predicted (np.int64(3681), np.int64(3689))
    True Range 3 (np.int64(4212), np.int64(4244)) ‚Üî Predicted (np.int64(4210), np.int64(4248))
    True Range 4 (np.int64(5007), np.int64(5029)) ‚Üî Predicted (np.int64(5003), np.int64(5034))
    True Range 5 (np.int64(5758), np.int64(5870)) ‚Üî Predicted (np.int64(5755), np.int64(5762))
    True Range 6 (np.int64(6665), np.int64(6777)) ‚Üî Predicted (np.int64(6661), np.int64(6678))
    True Range 7 (np.int64(8492), np.int64(8521)) ‚Üî Predicted (np.int64(8486), np.int64(8527))
    True Range 8 (np.int64(9099), np.int64(9197)) ‚Üî Predicted (np.int64(9137), np.int64(9155))
    True Range 9 (np.int64(9628), np.int64(9724)) ‚Üî Predicted (np.int64(9628), np.int64(9725))

File 4:
  True Ranges: [(np.int64(2229), np.int64(2272)), (np.int64(2744), np.int64(2840)), (np.int64(3010), np.int64(3034)), (np.int64(3761), np.int64(3783)), (np.int64(5028), np.int64(5065)), (np.int64(6270), np.int64(6304)), (np.int64(8383), np.int64(8422)), (np.int64(8650), np.int64(8730)), (np.int64(9602), np.int64(9627)), (np.int64(9862), np.int64(9960))] (count: 10)
  Predicted Ranges: [(np.int64(0), np.int64(9)), (np.int64(2225), np.int64(2276)), (np.int64(2740), np.int64(2845)), (np.int64(3008), np.int64(3038)), (np.int64(3759), np.int64(3786)), (np.int64(5025), np.int64(5068)), (np.int64(6267), np.int64(6305)), (np.int64(8380), np.int64(8427)), (np.int64(8685), np.int64(8735)), (np.int64(9599), np.int64(9632)), (np.int64(9874), np.int64(9960)), (np.int64(9990), np.int64(9999))] (count: 12)
  Matched Pairs:
    True Range 0 (np.int64(2229), np.int64(2272)) ‚Üî Predicted (np.int64(2225), np.int64(2276))
    True Range 1 (np.int64(2744), np.int64(2840)) ‚Üî Predicted (np.int64(2740), np.int64(2845))
    True Range 2 (np.int64(3010), np.int64(3034)) ‚Üî Predicted (np.int64(3008), np.int64(3038))
    True Range 3 (np.int64(3761), np.int64(3783)) ‚Üî Predicted (np.int64(3759), np.int64(3786))
    True Range 4 (np.int64(5028), np.int64(5065)) ‚Üî Predicted (np.int64(5025), np.int64(5068))
    True Range 5 (np.int64(6270), np.int64(6304)) ‚Üî Predicted (np.int64(6267), np.int64(6305))
    True Range 6 (np.int64(8383), np.int64(8422)) ‚Üî Predicted (np.int64(8380), np.int64(8427))
    True Range 7 (np.int64(8650), np.int64(8730)) ‚Üî Predicted (np.int64(8685), np.int64(8735))
    True Range 8 (np.int64(9602), np.int64(9627)) ‚Üî Predicted (np.int64(9599), np.int64(9632))
    True Range 9 (np.int64(9862), np.int64(9960)) ‚Üî Predicted (np.int64(9874), np.int64(9960))

File 5:
  True Ranges: [(np.int64(2661), np.int64(2775)), (np.int64(2863), np.int64(2894)), (np.int64(3006), np.int64(3124)), (np.int64(4118), np.int64(4269)), (np.int64(4463), np.int64(4591)), (np.int64(5953), np.int64(5994)), (np.int64(6107), np.int64(6225)), (np.int64(6429), np.int64(6577)), (np.int64(7969), np.int64(8094)), (np.int64(8886), np.int64(8906))] (count: 10)
  Predicted Ranges: [(np.int64(0), np.int64(9)), (np.int64(2679), np.int64(2685)), (np.int64(2703), np.int64(2715)), (np.int64(2727), np.int64(2733)), (np.int64(2863), np.int64(2897)), (np.int64(3004), np.int64(3010)), (np.int64(3056), np.int64(3075)), (np.int64(3121), np.int64(3127)), (np.int64(4180), np.int64(4274)), (np.int64(4463), np.int64(4466)), (np.int64(4513), np.int64(4542)), (np.int64(4588), np.int64(4594)), (np.int64(5950), np.int64(5998)), (np.int64(6137), np.int64(6167)), (np.int64(6179), np.int64(6215)), (np.int64(6484), np.int64(6581)), (np.int64(7968), np.int64(7979)), (np.int64(8019), np.int64(8045)), (np.int64(8083), np.int64(8098)), (np.int64(8885), np.int64(8909)), (np.int64(9984), np.int64(9999))] (count: 21)
  Matched Pairs:
    True Range 0 (np.int64(2661), np.int64(2775)) ‚Üî Predicted (np.int64(2679), np.int64(2685))
    True Range 1 (np.int64(2863), np.int64(2894)) ‚Üî Predicted (np.int64(2863), np.int64(2897))
    True Range 2 (np.int64(3006), np.int64(3124)) ‚Üî Predicted (np.int64(3004), np.int64(3010))
    True Range 3 (np.int64(4118), np.int64(4269)) ‚Üî Predicted (np.int64(4180), np.int64(4274))
    True Range 4 (np.int64(4463), np.int64(4591)) ‚Üî Predicted (np.int64(4463), np.int64(4466))
    True Range 5 (np.int64(5953), np.int64(5994)) ‚Üî Predicted (np.int64(5950), np.int64(5998))
    True Range 6 (np.int64(6107), np.int64(6225)) ‚Üî Predicted (np.int64(6137), np.int64(6167))
    True Range 7 (np.int64(6429), np.int64(6577)) ‚Üî Predicted (np.int64(6484), np.int64(6581))
    True Range 8 (np.int64(7969), np.int64(8094)) ‚Üî Predicted (np.int64(7968), np.int64(7979))
    True Range 9 (np.int64(8886), np.int64(8906)) ‚Üî Predicted (np.int64(8885), np.int64(8909))

File 6:
  True Ranges: [(np.int64(2543), np.int64(2670)), (np.int64(3004), np.int64(3087)), (np.int64(3766), np.int64(3826)), (np.int64(5188), np.int64(5304)), (np.int64(5882), np.int64(5908)), (np.int64(6584), np.int64(6609)), (np.int64(7041), np.int64(7143)), (np.int64(7441), np.int64(7539)), (np.int64(9294), np.int64(9429)), (np.int64(9817), np.int64(9846))] (count: 10)
  Predicted Ranges: [(np.int64(0), np.int64(9)), (np.int64(2541), np.int64(2672)), (np.int64(3047), np.int64(3089)), (np.int64(3784), np.int64(3790)), (np.int64(3808), np.int64(3814)), (np.int64(5255), np.int64(5308)), (np.int64(5880), np.int64(5911)), (np.int64(6584), np.int64(6612)), (np.int64(7038), np.int64(7148)), (np.int64(7438), np.int64(7542)), (np.int64(9360), np.int64(9434)), (np.int64(9815), np.int64(9849)), (np.int64(9991), np.int64(9999))] (count: 13)
  Matched Pairs:
    True Range 0 (np.int64(2543), np.int64(2670)) ‚Üî Predicted (np.int64(2541), np.int64(2672))
    True Range 1 (np.int64(3004), np.int64(3087)) ‚Üî Predicted (np.int64(3047), np.int64(3089))
    True Range 2 (np.int64(3766), np.int64(3826)) ‚Üî Predicted (np.int64(3784), np.int64(3790))
    True Range 3 (np.int64(5188), np.int64(5304)) ‚Üî Predicted (np.int64(5255), np.int64(5308))
    True Range 4 (np.int64(5882), np.int64(5908)) ‚Üî Predicted (np.int64(5880), np.int64(5911))
    True Range 5 (np.int64(6584), np.int64(6609)) ‚Üî Predicted (np.int64(6584), np.int64(6612))
    True Range 6 (np.int64(7041), np.int64(7143)) ‚Üî Predicted (np.int64(7038), np.int64(7148))
    True Range 7 (np.int64(7441), np.int64(7539)) ‚Üî Predicted (np.int64(7438), np.int64(7542))
    True Range 8 (np.int64(9294), np.int64(9429)) ‚Üî Predicted (np.int64(9360), np.int64(9434))
    True Range 9 (np.int64(9817), np.int64(9846)) ‚Üî Predicted (np.int64(9815), np.int64(9849))

File 7:
  True Ranges: [(np.int64(2165), np.int64(2305)), (np.int64(2570), np.int64(2611)), (np.int64(4188), np.int64(4306)), (np.int64(4572), np.int64(4721)), (np.int64(5008), np.int64(5095)), (np.int64(6491), np.int64(6560)), (np.int64(7365), np.int64(7484)), (np.int64(8348), np.int64(8452)), (np.int64(8592), np.int64(8614)), (np.int64(9537), np.int64(9614))] (count: 10)
  Predicted Ranges: [(np.int64(0), np.int64(9)), (np.int64(2255), np.int64(2309)), (np.int64(2568), np.int64(2613)), (np.int64(4218), np.int64(4224)), (np.int64(4236), np.int64(4248)), (np.int64(4260), np.int64(4272)), (np.int64(4639), np.int64(4726)), (np.int64(5023), np.int64(5099)), (np.int64(6521), np.int64(6527)), (np.int64(7421), np.int64(7488)), (np.int64(8344), np.int64(8455)), (np.int64(8592), np.int64(8616)), (np.int64(9567), np.int64(9579)), (np.int64(9591), np.int64(9597)), (np.int64(9991), np.int64(9999))] (count: 15)
  Matched Pairs:
    True Range 0 (np.int64(2165), np.int64(2305)) ‚Üî Predicted (np.int64(2255), np.int64(2309))
    True Range 1 (np.int64(2570), np.int64(2611)) ‚Üî Predicted (np.int64(2568), np.int64(2613))
    True Range 2 (np.int64(4188), np.int64(4306)) ‚Üî Predicted (np.int64(4218), np.int64(4224))
    True Range 3 (np.int64(4572), np.int64(4721)) ‚Üî Predicted (np.int64(4639), np.int64(4726))
    True Range 4 (np.int64(5008), np.int64(5095)) ‚Üî Predicted (np.int64(5023), np.int64(5099))
    True Range 5 (np.int64(6491), np.int64(6560)) ‚Üî Predicted (np.int64(6521), np.int64(6527))
    True Range 6 (np.int64(7365), np.int64(7484)) ‚Üî Predicted (np.int64(7421), np.int64(7488))
    True Range 7 (np.int64(8348), np.int64(8452)) ‚Üî Predicted (np.int64(8344), np.int64(8455))
    True Range 8 (np.int64(8592), np.int64(8614)) ‚Üî Predicted (np.int64(8592), np.int64(8616))
    True Range 9 (np.int64(9537), np.int64(9614)) ‚Üî Predicted (np.int64(9567), np.int64(9579))

File 8:
  True Ranges: [(np.int64(2340), np.int64(2407)), (np.int64(2594), np.int64(2698)), (np.int64(4708), np.int64(4787)), (np.int64(5387), np.int64(5480)), (np.int64(6153), np.int64(6267)), (np.int64(6479), np.int64(6580)), (np.int64(7548), np.int64(7569)), (np.int64(8021), np.int64(8058)), (np.int64(8299), np.int64(8329)), (np.int64(9827), np.int64(9904))] (count: 10)
  Predicted Ranges: [(np.int64(0), np.int64(9)), (np.int64(2346), np.int64(2352)), (np.int64(2364), np.int64(2400)), (np.int64(2633), np.int64(2700)), (np.int64(4741), np.int64(4789)), (np.int64(5418), np.int64(5482)), (np.int64(6159), np.int64(6165)), (np.int64(6177), np.int64(6267)), (np.int64(6495), np.int64(6582)), (np.int64(7544), np.int64(7574)), (np.int64(8019), np.int64(8059)), (np.int64(8295), np.int64(8335)), (np.int64(9833), np.int64(9900)), (np.int64(9990), np.int64(9999))] (count: 14)
  Matched Pairs:
    True Range 0 (np.int64(2340), np.int64(2407)) ‚Üî Predicted (np.int64(2346), np.int64(2352))
    True Range 1 (np.int64(2594), np.int64(2698)) ‚Üî Predicted (np.int64(2633), np.int64(2700))
    True Range 2 (np.int64(4708), np.int64(4787)) ‚Üî Predicted (np.int64(4741), np.int64(4789))
    True Range 3 (np.int64(5387), np.int64(5480)) ‚Üî Predicted (np.int64(5418), np.int64(5482))
    True Range 4 (np.int64(6153), np.int64(6267)) ‚Üî Predicted (np.int64(6159), np.int64(6165))
    True Range 5 (np.int64(6479), np.int64(6580)) ‚Üî Predicted (np.int64(6495), np.int64(6582))
    True Range 6 (np.int64(7548), np.int64(7569)) ‚Üî Predicted (np.int64(7544), np.int64(7574))
    True Range 7 (np.int64(8021), np.int64(8058)) ‚Üî Predicted (np.int64(8019), np.int64(8059))
    True Range 8 (np.int64(8299), np.int64(8329)) ‚Üî Predicted (np.int64(8295), np.int64(8335))
    True Range 9 (np.int64(9827), np.int64(9904)) ‚Üî Predicted (np.int64(9833), np.int64(9900))

File 9:
  True Ranges: [(np.int64(3463), np.int64(3494)), (np.int64(3896), np.int64(3993)), (np.int64(4143), np.int64(4224)), (np.int64(5471), np.int64(5578)), (np.int64(6064), np.int64(6145)), (np.int64(6543), np.int64(6636)), (np.int64(7889), np.int64(8021)), (np.int64(8650), np.int64(8756)), (np.int64(9074), np.int64(9225)), (np.int64(9621), np.int64(9740))] (count: 10)
  Predicted Ranges: [(np.int64(0), np.int64(9)), (np.int64(3473), np.int64(3495)), (np.int64(3893), np.int64(3998)), (np.int64(4143), np.int64(4149)), (np.int64(4161), np.int64(4223)), (np.int64(5467), np.int64(5583)), (np.int64(6102), np.int64(6105)), (np.int64(6117), np.int64(6148)), (np.int64(6539), np.int64(6640)), (np.int64(7886), np.int64(8025)), (np.int64(8715), np.int64(8757)), (np.int64(9155), np.int64(9227)), (np.int64(9685), np.int64(9741)), (np.int64(9991), np.int64(9999))] (count: 14)
  Matched Pairs:
    True Range 0 (np.int64(3463), np.int64(3494)) ‚Üî Predicted (np.int64(3473), np.int64(3495))
    True Range 1 (np.int64(3896), np.int64(3993)) ‚Üî Predicted (np.int64(3893), np.int64(3998))
    True Range 2 (np.int64(4143), np.int64(4224)) ‚Üî Predicted (np.int64(4143), np.int64(4149))
    True Range 3 (np.int64(5471), np.int64(5578)) ‚Üî Predicted (np.int64(5467), np.int64(5583))
    True Range 4 (np.int64(6064), np.int64(6145)) ‚Üî Predicted (np.int64(6102), np.int64(6105))
    True Range 5 (np.int64(6543), np.int64(6636)) ‚Üî Predicted (np.int64(6539), np.int64(6640))
    True Range 6 (np.int64(7889), np.int64(8021)) ‚Üî Predicted (np.int64(7886), np.int64(8025))
    True Range 7 (np.int64(8650), np.int64(8756)) ‚Üî Predicted (np.int64(8715), np.int64(8757))
    True Range 8 (np.int64(9074), np.int64(9225)) ‚Üî Predicted (np.int64(9155), np.int64(9227))
    True Range 9 (np.int64(9621), np.int64(9740)) ‚Üî Predicted (np.int64(9685), np.int64(9741))

Evaluation completed for all files with high-precision detection methods!</code></pre>
</div>
</div>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "Óßã";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>